<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>谷粒商城—分布式基础(二) | OYの博客</title><meta name="keywords" content="Java项目"><meta name="author" content="OY"><meta name="copyright" content="OY"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="语雀文档库: https:&#x2F;&#x2F;www.yuque.com&#x2F;imoyt&#x2F;zssuuf  一、 递归树形结构获取数据在注册中心中“product”命名空间中，创建“gulimall-product.yml”配置文件：  将“application.yml”内容拷贝到该配置文件中 12345678910111213141516171819202122server:  port: 10000spring"><meta property="og:type" content="article"><meta property="og:title" content="谷粒商城—分布式基础(二)"><meta property="og:url" content="https://oy6090.top/posts/3d7d679f/index.html"><meta property="og:site_name" content="OYの博客"><meta property="og:description" content="语雀文档库: https:&#x2F;&#x2F;www.yuque.com&#x2F;imoyt&#x2F;zssuuf  一、 递归树形结构获取数据在注册中心中“product”命名空间中，创建“gulimall-product.yml”配置文件：  将“application.yml”内容拷贝到该配置文件中 12345678910111213141516171819202122server:  port: 10000spring"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/21.jpg"><meta property="article:published_time" content="2021-05-07T12:30:00.000Z"><meta property="article:modified_time" content="2022-06-17T15:29:42.589Z"><meta property="article:author" content="OY"><meta property="article:tag" content="Java项目"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/21.jpg"><link rel="shortcut icon" href="/img/favicons.png"><link rel="canonical" href="https://oy6090.top/posts/3d7d679f/"><link rel="preconnect" href="//fastly.jsdelivr.net"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/images/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/images/pwaicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/pwaicons/android-chrome-36x36.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/pwaicons/android-chrome-16x16.png"><link rel="mask-icon" href="/images/pwaicons/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"这篇文章最后更新于","messageNext":"天前，您需要注意相关的内容是否还可用，如有疑问请联系博主！"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: OY","link":"链接: ","source":"来源: OYの博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://fastly.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@main/butterflyCss/animate.min.css" media="print" onload='this.media="all"'><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"谷粒商城—分布式基础(二)",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-06-17 15:29:42"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" data-pjax href="/tools/css/icofont.css"><link rel="stylesheet" href="/tools/css/oy.css"><link rel="stylesheet" href="/tools/css/oyindex.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/tools/css/notetag.css"><link rel="stylesheet" href="/tools/css/commentsbar.css"><link rel="stylesheet" href="/tools/css/bb.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2333811_ubwll4rutkn.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/plugins.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/hclonely.github.io@1.4.7/css/custom/pace-theme-flash.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw iconfont icon-liaotian"></i> <span>碎碎念</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-iconfontlink"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-daohang1"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/aboout/"><i class="fa-fw iconfont icon-crmuser"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-bianjiwenzhang"></i> <span>找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-label_icon"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-wenjian"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiangzi"></i> <span>菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-huatong"></i> <span>哔哔</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://imoyt.top/"><i class="fa-fw iconfont icon-zhandian"></i> <span>分站</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont icon-yinyue"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/logs/"><i class="fa-fw iconfont icon-rizhi"></i> <span>更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://console.leancloud.app/apps"><i class="fa-fw iconfont icon-houtaiguanli"></i> <span>Leancloud</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/21.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">OYの博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw iconfont icon-liaotian"></i> <span>碎碎念</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-iconfontlink"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-daohang1"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/aboout/"><i class="fa-fw iconfont icon-crmuser"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-bianjiwenzhang"></i> <span>找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-label_icon"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-wenjian"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiangzi"></i> <span>菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-huatong"></i> <span>哔哔</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://imoyt.top/"><i class="fa-fw iconfont icon-zhandian"></i> <span>分站</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont icon-yinyue"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/logs/"><i class="fa-fw iconfont icon-rizhi"></i> <span>更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://console.leancloud.app/apps"><i class="fa-fw iconfont icon-houtaiguanli"></i> <span>Leancloud</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">谷粒商城—分布式基础(二)<a class="post-edit-link" href="https://github.com/OYCodeSite/HexoButterFly/tree/main/source/_posts/Java项目/谷粒商城/谷粒商城-分布式基础(二).md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-07T12:30:00.000Z" title="发表于 2021-05-07 12:30:00">2021-05-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-17T15:29:42.589Z" title="更新于 2022-06-17 15:29:42">2022-06-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">26k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>120分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="谷粒商城—分布式基础(二)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote><p><strong>语雀文档库:</strong> <a target="_blank" rel="noopener" href="https://www.yuque.com/imoyt/zssuuf">https://www.yuque.com/imoyt/zssuuf</a></p></blockquote><h2 id="一、-递归树形结构获取数据"><a href="#一、-递归树形结构获取数据" class="headerlink" title="一、 递归树形结构获取数据"></a>一、 递归树形结构获取数据</h2><p>在注册中心中“product”命名空间中，创建“gulimall-product.yml”配置文件：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170649.png" alt="image-20200425153735737"></p><p>将“application.yml”内容拷贝到该配置文件中</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment">#MySQL配置</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.137.14:3306/gulimall_pms?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-product</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.137</span><span class="number">.14</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/**/*.xml</span></span><br></pre></td></tr></table></figure><p>在本地创建“bootstrap.properties”文件，指明配置中心的位置和使用到的配置文件：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">gulimall-product</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">192.168.137.14:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">3c50ffaa-010b-4b59-9372-902e35059232</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].data-id</span>=<span class="string">gulimall-product.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p>然后启动 gulimall-product，查看到该服务已经出现在了 nacos 的注册中心中了</p><p>修改“io.niceseason.gulimall.product.service.CategoryService”类，添加如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list/tree&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntities = categoryService.listWithTree();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> categoryEntities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：<a target="_blank" rel="noopener" href="http://localhost:10000/product/category/list/tree">http://localhost:10000/product/category/list/tree</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170654.png" alt="image-20200425154348716"></p><p>如何区别是哪种分类级别？</p><p>答：可以通过分类的 parent_cid 来进行判断，如果是一级分类，其值为 0.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list/tree&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntities = categoryService.listWithTree();</span><br><span class="line">    <span class="comment">//找到所有的一级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; level1Menus = categoryEntities.stream()</span><br><span class="line">            .filter(item -&gt; item.getParentCid() == <span class="number">0</span>)</span><br><span class="line">            .map(menu-&gt;&#123;</span><br><span class="line">                menu.setChildCategoryEntity(getChildrens(menu,categoryEntities));</span><br><span class="line">                <span class="keyword">return</span> menu;</span><br><span class="line">            &#125;)</span><br><span class="line">            .sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> (menu1.getSort() ==<span class="literal">null</span> ? <span class="number">0</span>:menu1.getSort())- (menu2.getSort()==<span class="literal">null</span>?<span class="number">0</span>:menu2.getSort());</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> level1Menus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getChildrens</span><span class="params">(CategoryEntity root,List&lt;CategoryEntity&gt; all)</span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;CategoryEntity&gt; childrens = all.stream().filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getParentCid() == root.getCatId();</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        item.setChildCategoryEntity(getChildrens(item, all));</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;).sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> (menu1.getSort() ==<span class="literal">null</span> ? <span class="number">0</span>:menu1.getSort())- (menu2.getSort()==<span class="literal">null</span>?<span class="number">0</span>:menu2.getSort());</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> childrens;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>下面是得到的部分 JSON 数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;图书、音像、电子书刊&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;电子书刊&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">165</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;电子书&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">166</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;网络原创&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">167</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数字杂志&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">168</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;多媒体图书&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;音像&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">169</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;音乐&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">170</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;影视&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catId&quot;</span><span class="punctuation">:</span> <span class="number">171</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;教育音像&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentCid&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catLevel&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;showStatus&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productUnit&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;childCategoryEntity&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br></pre></td></tr></table></figure><p>启动后端项目 renren-fast</p><p>启动前端项目 renren-fast-vue：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure><p>访问： <a target="_blank" rel="noopener" href="http://localhost:8001/#/login">http://localhost:8001/#/login</a></p><p>创建一级菜单：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170700.png" alt="image-20200425164019287"></p><p>创建完成后，在后台的管理系统中会创建一条记录：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170703.png" alt="image-20200425164201813"></p><p>然后创建子菜单：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170706.png" alt="image-20200425164509143"></p><p>创建 renren-fast-vue\src\views\modules\product 目录，子所以是这样来创建，是因为 product/category，对应于 product-category</p><p>在该目录下，新建“category.vue”文件：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-tree</span> <span class="attr">:data</span>=<span class="string">&quot;menus&quot;</span> <span class="attr">:props</span>=<span class="string">&quot;defaultProps&quot;</span> @<span class="attr">node-click</span>=<span class="string">&quot;handleNodeClick&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-tree</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//这里可以导入其他文件（比如：组件，工具js，第三方插件js，json文件，图片文件等等）</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//例如：import 《组件名称》 from &#x27;《组件路径》&#x27;;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//import引入的组件需要注入到对象中才能使用</span></span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//监听属性 类似于data概念</span></span></span><br><span class="line"><span class="language-javascript">  <span class="attr">computed</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//监控data中的数据变化</span></span></span><br><span class="line"><span class="language-javascript">  <span class="attr">watch</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">menus</span>: [],</span></span><br><span class="line"><span class="language-javascript">       <span class="attr">defaultProps</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">children</span>: <span class="string">&quot;childrens&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">label</span>: <span class="string">&quot;name&quot;</span></span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">handleNodeClick</span>(<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">getMenus</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">dataListLoading</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.$http(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&quot;/product/category/list/tree&quot;</span>),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">method</span>: <span class="string">&quot;get&quot;</span></span></span><br><span class="line"><span class="language-javascript">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取到数据&quot;</span>, data);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">menus</span>=data;</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//生命周期 - 创建完成（可以访问当前this实例）</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//生命周期 - 挂载完成（可以访问DOM元素）</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">beforeCreate</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 创建之前</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">beforeMount</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 挂载之前</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">beforeUpdate</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 更新之前</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">updated</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 更新之后</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">beforeDestroy</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 销毁之前</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">destroyed</span>(<span class="params"></span>) &#123;&#125;, <span class="comment">//生命周期 - 销毁完成</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">activated</span>(<span class="params"></span>) &#123;&#125; <span class="comment">//如果页面有keep-alive缓存功能，这个函数会触发</span></span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br></pre></td></tr></table></figure><p>刷新页面出现 404 异常，查看请求发现，请求的是“<a target="_blank" rel="noopener" href="http://localhost:8080/renren-fast/product/category/list/tree%E2%80%9D">http://localhost:8080/renren-fast/product/category/list/tree”</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170710.png" alt="image-20200425173615149"></p><p>这个请求是不正确的，正确的请求是：<a target="_blank" rel="noopener" href="http://localhost:10000/product/category/list/tree%EF%BC%8C">http://localhost:10000/product/category/list/tree，</a></p><p>修正这个问题：</p><p>替换“static\config\index.js”文件中的“window.SITE_CONFIG[‘baseUrl’]”</p><p>替换前：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.SITE_CONFIG[&#x27;baseUrl&#x27;] = &#x27;http://localhost:8080/renren-fast&#x27;;</span><br></pre></td></tr></table></figure><p>替换后：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.SITE_CONFIG[&#x27;baseUrl&#x27;] = &#x27;http://localhost:88/api&#x27;;</span><br></pre></td></tr></table></figure><p><a href="http://localhost:88，这个地址是我们网关微服务的接口。">http://localhost:88，这个地址是我们网关微服务的接口。</a></p><p>这里我们需要通过网关来完成路径的映射，因此将 renren-fast 注册到 nacos 注册中心中，并添加配置中心</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">renren-fast</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.137</span><span class="number">.14</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">renren-fast</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.137</span><span class="number">.8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">ee409c3f-3206-4a3b-ba65-7376922a886d</span></span><br></pre></td></tr></table></figure><p>配置网关路由，前台的所有请求都是经由“<a target="_blank" rel="noopener" href="http://localhost:88/api%E2%80%9D%E6%9D%A5%E8%BD%AC%E5%8F%91%E7%9A%84%EF%BC%8C%E5%9C%A8%E2%80%9Cgulimall-gateway%E2%80%9D%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%EF%BC%9A">http://localhost:88/api”来转发的，在“gulimall-gateway”中添加路由规则：</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">admin_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://renren-fast</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/**</span></span><br></pre></td></tr></table></figure><p>但是这样做也引入了另外的一个问题，再次访问：<a target="_blank" rel="noopener" href="http://localhost:8001/#/login%EF%BC%8C%E5%8F%91%E7%8E%B0%E9%AA%8C%E8%AF%81%E7%A0%81%E4%B8%8D%E5%86%8D%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8001/#/login，发现验证码不再显示：</a></p><p>分析原因：</p><ol><li>现在的验证码请求路径为，<a target="_blank" rel="noopener" href="http://localhost:88/api/captcha.jpg?uuid=69c79f02-d15b-478a-8465-a07fd09001e6">http://localhost:88/api/captcha.jpg?uuid=69c79f02-d15b-478a-8465-a07fd09001e6</a></li><li>原始的验证码请求路径：<a target="_blank" rel="noopener" href="http://localhost:8001/renren-fast/captcha.jpg?uuid=69c79f02-d15b-478a-8465-a07fd09001e6">http://localhost:8001/renren-fast/captcha.jpg?uuid=69c79f02-d15b-478a-8465-a07fd09001e6</a></li></ol><p>在 admin_route 的路由规则下，在访问路径中包含了“api”，因此它会将它转发到 renren-fast，网关在转发的时候，会使用网关的前缀信息，为了能够正常的取得验证码，我们需要对请求路径进行重写</p><p>关于请求路径重写：</p><p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/#the-rewritepath-gatewayfilter-factory">6.16. The <code>RewritePath</code> <code>GatewayFilter</code> Factory</a></p><p>The <code>RewritePath</code> <code>GatewayFilter</code> factory takes a path <code>regexp</code> parameter and a <code>replacement</code> parameter. This uses Java regular expressions for a flexible way to rewrite the request path. The following listing configures a <code>RewritePath</code> <code>GatewayFilter</code>:</p><p>Example 41. application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">rewritepath_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/foo/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/red(?&lt;segment&gt;/?.*),</span> <span class="string">$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><p>For a request path of <code>/red/blue</code>, this sets the path to <code>/blue</code> before making the downstream request. Note that the <code>$</code> should be replaced with <code>$\</code> because of the YAML specification.</p><p>修改“admin_route”路由规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">admin_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://renren-fast</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),</span> <span class="string">/renren-fast/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><p>再次访问：<a target="_blank" rel="noopener" href="http://localhost:8001/#/login%EF%BC%8C%E9%AA%8C%E8%AF%81%E7%A0%81%E8%83%BD%E5%A4%9F%E6%AD%A3%E5%B8%B8%E7%9A%84%E5%8A%A0%E8%BD%BD%E4%BA%86%E3%80%82">http://localhost:8001/#/login，验证码能够正常的加载了。</a></p><p>但是很不幸新的问题又产生了，访问被拒绝了</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170715.png" alt="image-20200425192722821"></p><p>问题描述：已拦截跨源请求：同源策略禁止读取位于 <a target="_blank" rel="noopener" href="http://localhost:88/api/sys/login">http://localhost:88/api/sys/login</a> 的远程资源。（原因：CORS 头缺少 ‘Access-Control-Allow-Origin’）。</p><p>问题分析：这是一种跨域问题。访问的域名和端口和原来的请求不同，请求就会被限制</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170717.png" alt="image-20200425192902637"></p><p>跨域流程：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170722.png" alt="image-20200425193136641"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170725.png" alt="image-20200425193523849"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170731.png" alt="image-20200425193614185"></p><p>解决方法：在网关中定义“GulimallCorsConfiguration”类，该类用来做过滤，允许所有的请求跨域。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallCorsConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsWebFilter <span class="title function_">corsWebFilter</span><span class="params">()</span>&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source=<span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>,corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsWebFilter</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次访问：<a target="_blank" rel="noopener" href="http://localhost:8001/#/login">http://localhost:8001/#/login</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170736.png" alt="image-20200425195437299"></p><p><a target="_blank" rel="noopener" href="http://localhost:8001/renre">http://localhost:8001/renre</a> 已拦截跨源请求：同源策略禁止读取位于 <a target="_blank" rel="noopener" href="http://localhost:88/api/sys/login">http://localhost:88/api/sys/login</a> 的远程资源。（原因：不允许有多个 ‘Access-Control-Allow-Origin’ CORS 头）n-fast/captcha.jpg?uuid=69c79f02-d15b-478a-8465-a07fd09001e6</p><p>出现了多个请求，并且也存在多个跨源请求。</p><p>为了解决这个问题，需要修改 renren-fast 项目，注释掉“io.renren.config.CorsConfig”类。然后再次进行访问。</p><p>在显示分类信息的时候，出现了 404 异常，请求的 <a target="_blank" rel="noopener" href="http://localhost:88/api/product/category/list/tree">http://localhost:88/api/product/category/list/tree</a> 不存在</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170739.png" alt="image-20200425213240724"></p><p>这是因为网关上所做的路径映射不正确，映射后的路径为 <a target="_blank" rel="noopener" href="http://localhost:8001/renren-fast/product/category/list/tree">http://localhost:8001/renren-fast/product/category/list/tree</a></p><p>但是只有通过 <a target="_blank" rel="noopener" href="http://localhost:10000/product/category/list/tree">http://localhost:10000/product/category/list/tree</a> 路径才能够正常访问，所以会报 404 异常。</p><p>解决方法就是定义一个 product 路由规则，进行路径重写：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-product</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><p>在路由规则的顺序上，将精确的路由规则放置到模糊的路由规则的前面，否则的话，精确的路由规则将不会被匹配到，类似于异常体系中 try catch 子句中异常的处理顺序。</p><blockquote><p><strong>抽取代码片段 vue.code-snippets</strong></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;http-get请求&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httpget&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;this.\\$http(&#123;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;url:this.\\$http.adornUrl(&#x27;&#x27;),&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;method:&#x27;get&#x27;,&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;params:this.\\$http.adornParams(&#123;&#125;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;&#125;).then((&#123;data&#125;)=&gt;&#123;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;&#125;)&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httpGET请求&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;http-post请求&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httppost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;this.\\$http(&#123;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;url:this.\\$http.adornUrl(&#x27;&#x27;),&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;method:&#x27;post&#x27;,&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;data: this.\\$http.adornData(data, false)&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;&#125;).then((&#123;data&#125;)=&gt;&#123; &#125;)&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httpPOST请求&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="二、删除-添加数据"><a href="#二、删除-添加数据" class="headerlink" title="二、删除/添加数据"></a>二、删除/添加数据</h2><p>添加 delete 和 append 标识，并且增加复选框</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree</span><br><span class="line">   :data=&quot;menus&quot;</span><br><span class="line">   show-checkbox  //显示复选框</span><br><span class="line">   :props=&quot;defaultProps&quot;</span><br><span class="line">   :expand-on-click-node=&quot;false&quot; //设置节点点击时不展开</span><br><span class="line">   node-key=&quot;catId&quot;</span><br><span class="line"> &gt;</span><br><span class="line">   &lt;span class=&quot;custom-tree-node&quot; slot-scope=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">     &lt;span&gt;&#123;&#123; node.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">     &lt;span&gt;</span><br><span class="line">       &lt;el-button v-if=&quot;node.level &lt;= 2&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; append(data)&quot;&gt;Append&lt;/el-button&gt;</span><br><span class="line">       &lt;el-button</span><br><span class="line">         v-if=&quot;node.childNodes.length == 0&quot;</span><br><span class="line">         type=&quot;text&quot;</span><br><span class="line">         size=&quot;mini&quot;</span><br><span class="line">         @click=&quot;() =&gt; remove(node, data)&quot;</span><br><span class="line">       &gt;Delete&lt;/el-button&gt;</span><br><span class="line">     &lt;/span&gt;</span><br><span class="line">   &lt;/span&gt;</span><br><span class="line"> &lt;/el-tree&gt;</span><br></pre></td></tr></table></figure><p>测试删除数据，打开 postman 输入“ <a target="_blank" rel="noopener" href="http://localhost:88/api/product/category/delete">http://localhost:88/api/product/category/delete</a> ”，请求方式设置为 POST，为了比对效果，可以在删除之前查询数据库的 pms_category 表：</p><p><img src="/img/loading.gif" data-lazy-src="images/image-20200426112814069.png" alt="image-20200426112814069"></p><p>由于 delete 请求接收的是一个数组，所以这里使用 JSON 方式，传入了一个数组：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170744.png" alt="image-20200426113003531"></p><p>再次查询数据库能够看到 cat_id 为 1000 的数据已经被删除了。</p><p>修改“io.niceseason.gulimall.product.controller.CategoryController”类，添加如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] catIds)</span>&#123;</span><br><span class="line">        <span class="comment">//删除之前需要判断待删除的菜单那是否被别的地方所引用。</span></span><br><span class="line"><span class="comment">//		categoryService.removeByIds(Arrays.asList(catIds));</span></span><br><span class="line"></span><br><span class="line">        categoryService.removeMenuByIds(Arrays.asList(catIds));</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>io.niceseason.gulimall.product.service.impl.CategoryServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span>   <span class="keyword">void</span> <span class="title function_">removeMenuByIds</span><span class="params">(List&lt;Long&gt; asList)</span> &#123;</span><br><span class="line">    <span class="comment">//TODO 检查当前的菜单是否被别的地方所引用</span></span><br><span class="line">    <span class="comment">//categoryDao.deleteBatchIds(asList);</span></span><br><span class="line">    baseMapper.deleteBatchIds(asList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然而多数时候，我们并不希望删除数据，而是标记它被删除了，这就是逻辑删除；</p><p>可以设置 show_status 为 0，标记它已经被删除。</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170747.png" alt="image-20200426115332899"></p><p>mybatis-plus 的逻辑删除：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170751.png" alt="image-20200426115420393"></p><p>配置全局的逻辑删除规则，在“src/main/resources/application.yml”文件中添加如下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>修改“io.niceseason.gulimall.product.entity.CategoryEntity”类，添加上@TableLogic，表明使用逻辑删除：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否显示[0-不显示，1显示]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableLogic(value = &quot;1&quot;,delval = &quot;0&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre></td></tr></table></figure><p>然后在 POSTMan 中测试一下是否能够满足需要。另外在“src/main/resources/application.yml”文件中，设置日志级别，打印出 SQL 语句：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io.niceseason.gulimall.product:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p>打印的日志：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: UPDATE pms_category SET show_status=<span class="number">0</span> WHERE cat_id IN ( ? ) AND show_status=<span class="number">1</span></span><br><span class="line">==&gt; Parameters: <span class="number">1431</span>(Long)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">get changedGroupKeys:[]</span><br></pre></td></tr></table></figure><p>删除细节优化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">remove</span>(<span class="params">node, data</span>) &#123;</span><br><span class="line">    <span class="comment">//讲删除id传入数组</span></span><br><span class="line">    <span class="keyword">var</span> ids = [data.<span class="property">catId</span>];</span><br><span class="line">    <span class="comment">//删除前弹出确认框</span></span><br><span class="line">    <span class="variable language_">this</span>.$confirm(<span class="string">`是否删除【<span class="subst">$&#123;data.name&#125;</span>】菜单?`</span>, <span class="string">&quot;提示&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">confirmButtonText</span>: <span class="string">&quot;确定&quot;</span>,</span><br><span class="line">      <span class="attr">cancelButtonText</span>: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">          <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&quot;/product/category/delete&quot;</span>),</span><br><span class="line">          <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">          <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(ids, <span class="literal">false</span>),</span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">//成功删除后弹出提示</span></span><br><span class="line">          <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;菜单删除成功&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">//刷新出新的菜单</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">          <span class="comment">//设置需要默认展开的菜单，使得删除后当前目录处于展开的状态</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">expandedKey</span> = [node.<span class="property">parent</span>.<span class="property">data</span>.<span class="property">catId</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;remove&quot;</span>, node, data);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p><strong>添加数据</strong></p><p>在模板上添加分类对话框</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-dialog</span> <span class="attr">title</span>=<span class="string">&quot;添加分类&quot;</span> <span class="attr">:visible.sync</span>=<span class="string">&quot;dialogFormVisible&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-form</span> <span class="attr">:model</span>=<span class="string">&quot;category&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">&quot;分类名称&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;category.name&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">&quot;footer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dialog-footer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-button</span> @<span class="attr">click</span>=<span class="string">&quot;dialogFormVisible = false&quot;</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;addCategory&quot;</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-dialog</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在 data 属性中增加对话框显示属性<code>dialogFormVisible</code>和提交数据<code>category</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">menus</span>: [],</span><br><span class="line">      <span class="attr">defaultProps</span>: &#123;</span><br><span class="line">        <span class="attr">children</span>: <span class="string">&quot;childrens&quot;</span>,</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//展开菜单的id</span></span><br><span class="line">      <span class="attr">expandedKey</span>: [],</span><br><span class="line">      <span class="comment">//添加分类对话框默认关闭</span></span><br><span class="line">      <span class="attr">dialogFormVisible</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">//提交分类的数据</span></span><br><span class="line">      <span class="attr">category</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">parentCid</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">catLevel</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">showStatus</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">sort</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">productUnit</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">icon</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">catId</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>分别添加<code>添加</code>和<code>确定</code>对应函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击添加调用此函数</span></span><br><span class="line"><span class="title function_">append</span>(<span class="params">data</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;添加数据&quot;</span>, data);</span><br><span class="line">    <span class="comment">//显示对话框</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogFormVisible</span>=<span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//父id为当前点击数据id</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">parentCid</span> = data.<span class="property">catId</span>;</span><br><span class="line">    <span class="comment">//显示层级为当前点击数据下一级</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">catLevel</span> = data.<span class="property">catLevel</span> * <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">catId</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">icon</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">productUnit</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">sort</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">showStatus</span> = <span class="number">1</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="title function_">addCategory</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&#x27;/product/category/save&#x27;</span>),</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(<span class="variable language_">this</span>.<span class="property">category</span>, <span class="literal">false</span>)</span><br><span class="line">       &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;菜单保存成功&quot;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//关闭对话框</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dialogFormVisible</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//刷新出新的菜单</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">        <span class="comment">//设置需要默认展开的菜单</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">expandedKey</span> = [<span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">parentCid</span>];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><h2 id="三、修改数据"><a href="#三、修改数据" class="headerlink" title="三、修改数据"></a>三、修改数据</h2><p>添加修改按钮</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;() =&gt; edit(data)&quot;</span>&gt;</span>Edit<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使对话框回显数据并显示标题<code>修改分类</code>，由于与 <code>增加分类</code>公用统一对话框，所以需要添加属性<code>title</code>并定制函数<code>submitData()</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-dialog</span> <span class="attr">:title</span>=<span class="string">&quot;title&quot;</span> <span class="attr">:visible.sync</span>=<span class="string">&quot;dialogFormVisible&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-form</span> <span class="attr">:model</span>=<span class="string">&quot;category&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">&quot;分类名称&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;category.name&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">&quot;图标&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;category.icon&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">&quot;计量单位&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;category.productUnit&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">&quot;footer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dialog-footer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-button</span> @<span class="attr">click</span>=<span class="string">&quot;dialogFormVisible = false&quot;</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;submitData&quot;</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-dialog</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     <span class="attr">menus</span>: [],</span><br><span class="line">     <span class="attr">defaultProps</span>: &#123;</span><br><span class="line">       <span class="attr">children</span>: <span class="string">&quot;childrens&quot;</span>,</span><br><span class="line">       <span class="attr">label</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">//展开菜单的id</span></span><br><span class="line">     <span class="attr">expandedKey</span>: [],</span><br><span class="line">     <span class="attr">dialogFormVisible</span>: <span class="literal">false</span>,</span><br><span class="line">     <span class="attr">category</span>: &#123;</span><br><span class="line">       <span class="attr">catId</span>: <span class="literal">null</span>,</span><br><span class="line">       <span class="attr">name</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="attr">parentCid</span>: <span class="number">0</span>,</span><br><span class="line">       <span class="attr">catLevel</span>: <span class="number">0</span>,</span><br><span class="line">       <span class="attr">showStatus</span>: <span class="number">1</span>,</span><br><span class="line">       <span class="attr">sort</span>: <span class="number">0</span>,</span><br><span class="line">       <span class="attr">productUnit</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="attr">icon</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="attr">catId</span>: <span class="literal">null</span>,</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">//对话框显示标题：添加分类/修改分类</span></span><br><span class="line">     <span class="attr">title</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">     <span class="attr">dialogType</span>: <span class="string">&quot;&quot;</span> <span class="comment">// add/edit</span></span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line">     <span class="comment">//点击修改按钮调用函数</span></span><br><span class="line">      <span class="title function_">edit</span>(<span class="params">data</span>) &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">title</span> = <span class="string">&quot;修改分类&quot;</span>,</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">dialogFormVisible</span> = <span class="literal">true</span>,</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">dialogType</span>=<span class="string">&quot;edit&quot;</span>,</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;修改数据&quot;</span>, data);</span><br><span class="line">     <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">       <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">`/product/category/info/<span class="subst">$&#123;data.catId&#125;</span>`</span>),</span><br><span class="line">       <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">     &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;回显数据&quot;</span>, data.<span class="property">category</span>);</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">category</span> = data.<span class="property">category</span>;</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//点击确定按钮调用函数</span></span><br><span class="line">   <span class="title function_">editCategory</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">var</span> &#123;catId,name,icon,productUnit&#125;=<span class="variable language_">this</span>.<span class="property">category</span>;</span><br><span class="line">     <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">       <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&quot;/product/category/update&quot;</span>),</span><br><span class="line">       <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">       <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(&#123;catId,name,icon,productUnit&#125;, <span class="literal">false</span>),</span><br><span class="line">     &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">         <span class="attr">message</span>: <span class="string">&quot;菜单修改成功&quot;</span>,</span><br><span class="line">         <span class="attr">type</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="comment">//关闭对话框</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">dialogFormVisible</span> = <span class="literal">false</span>;</span><br><span class="line">       <span class="comment">//刷新出新的菜单</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">       <span class="comment">//设置需要默认展开的菜单</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">expandedKey</span> = [<span class="variable language_">this</span>.<span class="property">category</span>.<span class="property">parentCid</span>];</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//根据提交类型是add/edit选择调用不同的方法</span></span><br><span class="line">   <span class="title function_">submitData</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">dialogType</span>==<span class="string">&quot;add&quot;</span>?<span class="variable language_">this</span>.<span class="title function_">addCategory</span>():<span class="variable language_">this</span>.<span class="title function_">editCategory</span>();</span><br><span class="line">   &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="四、菜单拖动"><a href="#四、菜单拖动" class="headerlink" title="四、菜单拖动"></a>四、菜单拖动</h2><p><strong>开启拖拽功能</strong></p><p>在<code>&lt;el-tree&gt;</code>添加属性<code>draggable</code>开启拖拽功能</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-tree</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:data</span>=<span class="string">&quot;menus&quot;</span></span></span><br><span class="line"><span class="tag">  绑定的变量</span></span><br><span class="line"><span class="tag">  <span class="attr">:props</span>=<span class="string">&quot;defaultProps&quot;</span></span></span><br><span class="line"><span class="tag">  配置选项</span></span><br><span class="line"><span class="tag">  <span class="attr">:expand-on-click-node</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">  只有点击箭头才会展开收缩</span></span><br><span class="line"><span class="tag">  <span class="attr">show-checkbox</span></span></span><br><span class="line"><span class="tag">  显示多选框</span></span><br><span class="line"><span class="tag">  <span class="attr">node-key</span>=<span class="string">&quot;catId&quot;</span></span></span><br><span class="line"><span class="tag">  数据库的<span class="attr">id</span>作为<span class="attr">node</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:default-expanded-keys</span>=<span class="string">&quot;expandedKey&quot;</span></span></span><br><span class="line"><span class="tag">  默认展开的数组</span></span><br><span class="line"><span class="tag">  <span class="attr">:draggable</span>=<span class="string">&quot;draggable&quot;</span></span></span><br><span class="line"><span class="tag">  开启拖拽功能</span></span><br><span class="line"><span class="tag">  <span class="attr">:allow-drop</span>=<span class="string">&quot;allowDrop&quot;</span></span></span><br><span class="line"><span class="tag">  是否允许拖拽到目标结点，函数为<span class="attr">Function</span>(<span class="attr">draggingNode</span>源结点,</span></span><br><span class="line"><span class="tag">  <span class="attr">dropNode</span>目标结点,</span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>前中后类型)</span></span><br><span class="line"><span class="tag">  @<span class="attr">node-drop</span>=<span class="string">&quot;handleDrop&quot;</span></span></span><br><span class="line"><span class="tag">  拖拽成功处理函数，函数为<span class="attr">Function</span>(<span class="attr">draggingNode</span>源结点,</span></span><br><span class="line"><span class="tag">  <span class="attr">dropNode</span>拖拽成功后的父结点,</span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>前中后类型)</span></span><br><span class="line"><span class="tag">  <span class="attr">ref</span>=<span class="string">&quot;menuTree&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">el-tree</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>限制可拖拽范围</strong></p><p>由于我们的菜单是三级分类，所以未防止超出三级的情况，有部分情况不允许被拖入：比如被拖拽的节点本身包含两级菜单，将其拖进第二层级的节点，那么最深层级就达到了四级，为防止这种情况的出现，我们需要编写在<code>&lt;el-tree&gt;</code>中绑定<code>allow-drop</code>属性并编写<code>allowDrop()</code>函数</p><p><code>allowDrop()</code>的思路为将被拖拽节点的子节点通过递归遍历找出最深节点的<code>level</code>，然后将被拖拽节点的相对深度与目标节点的相对深度相加，看是否超出最大深度 3</p><p><strong>函数参数：</strong></p><ul><li><code>draggingNode</code>：正在拖拽的结点</li><li><code>dropNode</code>：拓展成功后的父节点，我们把他称为<strong>目的父节点</strong></li><li><code>type</code>：分为 before、after、inner。拖拽到某个结点上还是两个结点之间</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//拖拽时判定目标节点能否被放置。type 参数有三种情况：&#x27;prev&#x27;、&#x27;inner&#x27; 和 &#x27;next&#x27;，</span></span><br><span class="line"> <span class="comment">//分别表示放置在目标节点前、插入至目标节点和放置在目标节点后</span></span><br><span class="line"> <span class="title function_">allowDrop</span>(<span class="params">draggingNode, dropNode, type</span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;拖拽节点&quot;</span>,draggingNode,dropNode,type);</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">maxLevel</span>=draggingNode.<span class="property">level</span>;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">countNodeLevel</span>(draggingNode);</span><br><span class="line">   <span class="comment">//当前拖拽节点距离最深节点的深度</span></span><br><span class="line">   <span class="comment">//找到了拖拽结点的最大层级(深度)，那么就可以计算拖拽结点作为根节点的子树深度deep。;</span></span><br><span class="line"><span class="comment">//另外注意maxLevel每次拖拽都会更新，是拖拽结点的最大层级;</span></span><br><span class="line">   <span class="keyword">let</span> deep=(<span class="variable language_">this</span>.<span class="property">maxLevel</span>-draggingNode.<span class="property">level</span>)+<span class="number">1</span>;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;deep:&quot;</span>,deep,<span class="string">&quot;maxlevel:&quot;</span>,<span class="variable language_">this</span>.<span class="property">maxLevel</span>,<span class="string">&quot;dragging:&quot;</span>,draggingNode.<span class="property">level</span>);</span><br><span class="line">   <span class="keyword">if</span>(type==<span class="string">&quot;inner&quot;</span>)&#123;</span><br><span class="line">     <span class="keyword">return</span> deep+dropNode.<span class="property">level</span>&lt;=<span class="number">3</span>;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> deep+dropNode.<span class="property">parent</span>.<span class="property">level</span>&lt;=<span class="number">3</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"> <span class="comment">//判断当前拖动菜单的最深层级</span></span><br><span class="line"> <span class="title function_">countNodeLevel</span>(<span class="params">node</span>)&#123;</span><br><span class="line">     <span class="comment">//找到所有子节点，求出最大深度</span></span><br><span class="line">   <span class="keyword">if</span>(node.<span class="property">childNodes</span>!=<span class="literal">null</span>&amp;&amp;node.<span class="property">childNodes</span>.<span class="property">length</span>!=<span class="number">0</span>)&#123;</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;node.<span class="property">childNodes</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">     <span class="keyword">if</span>(node.<span class="property">childNodes</span>[i].<span class="property">level</span>&gt;<span class="variable language_">this</span>.<span class="property">maxLevel</span>)&#123;</span><br><span class="line">       <span class="comment">// 是赋值给了共享变量maxLevel</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">maxLevel</span>=node.<span class="property">childNodes</span>[i].<span class="property">level</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 递归子节点</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">countNodeLevel</span>(node.<span class="property">childNodes</span>[i]);</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure><p><strong>拖拽合法性</strong></p><p>我们得到了子树的深度 deep，就可以判断这个拖拽合不合法：</p><p>拖拽类型：以拖拽后新的父结点为基准分为：</p><ul><li><p>结点前、后（两个结点之间）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deep + dropNode.<span class="property">parent</span>.<span class="property">level</span> &lt;= <span class="number">3</span>;</span><br></pre></td></tr></table></figure></li><li><p>中（结点上）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deep + dropNode.<span class="property">level</span> &lt;= <span class="number">3</span>;</span><br></pre></td></tr></table></figure></li></ul><p><strong>拖拽完成</strong></p><p>拖拽完成后我们需要更新三个状态：</p><ol><li><p>当前节点最新的父节点 id，</p></li><li><p>当前拖拽节点的最新顺序</p><blockquote><p>遍历姊妹节点的顺序即为新顺序</p></blockquote></li><li><p>当前拖拽节点的最新层级</p><blockquote><p>当前拖拽层级变化需要更新拖拽节点及其子节点</p></blockquote></li></ol><p>拖拽完成后需要更新变化的节点，根据被拖拽节点的防止位置的不同，变化的部分也有所不同</p><ul><li><p>inner</p><p>父节点为<code>dropNode</code>节点</p><p>姊妹节点为<code>dropNode</code>的孩子节点</p></li><li><p>before/after</p><p>父节点为<code>dropNode</code>的父节点</p><p>姊妹节点为<code>dropNode</code>的父节点的孩子节点</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//拖拽成功完成时触发的事件</span></span><br><span class="line"> <span class="comment">//共四个参数，依次为：</span></span><br><span class="line"> <span class="comment">//被拖拽节点对应的 Node、结束拖拽时最后进入的节点、被拖拽节点的放置位置（before、after、inner）、event</span></span><br><span class="line"> <span class="title function_">handleDrop</span>(<span class="params">draggingNode, dropNode, dropType, ev</span>) &#123;</span><br><span class="line">   <span class="comment">//1、当前节点最新的父节点id</span></span><br><span class="line">   <span class="keyword">let</span> pCid=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">let</span> siblings=<span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span>(dropType==<span class="string">&quot;inner&quot;</span>)&#123;</span><br><span class="line">     pCid=dropNode.<span class="property">data</span>.<span class="property">catId</span>;</span><br><span class="line">     siblings=dropNode.<span class="property">childNodes</span>;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     pCid=dropNode.<span class="property">parent</span>.<span class="property">data</span>.<span class="property">catId</span>==<span class="literal">undefined</span>?<span class="number">0</span>:dropNode.<span class="property">parent</span>.<span class="property">data</span>.<span class="property">catId</span>;</span><br><span class="line">     siblings=dropNode.<span class="property">parent</span>.<span class="property">childNodes</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//2、当前拖拽节点的最新顺序，</span></span><br><span class="line">   <span class="comment">//3、当前拖拽节点的最新层级</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">pCid</span>.<span class="title function_">push</span>(pCid);</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;siblings.<span class="property">length</span>;i++)&#123;</span><br><span class="line">     <span class="keyword">if</span>(siblings[i].<span class="property">data</span>.<span class="property">catId</span>==draggingNode.<span class="property">data</span>.<span class="property">catId</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> catLevel=draggingNode.<span class="property">catLevel</span>;</span><br><span class="line">        <span class="comment">//被拖拽节点的层级发生变化</span></span><br><span class="line">        <span class="comment">//其子节点的层级也需要变化</span></span><br><span class="line">        <span class="keyword">if</span>(catLevel!=draggingNode.<span class="property">level</span>)&#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">updateChildNodeLevel</span>(siblings[i]);</span><br><span class="line">             catLevel=draggingNode.<span class="property">level</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">updateNodes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">catId</span>:siblings[i].<span class="property">data</span>.<span class="property">catId</span>,</span><br><span class="line">          catLevel,</span><br><span class="line">          <span class="attr">sort</span>:i,</span><br><span class="line">          <span class="attr">parentCid</span>:pCid,</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">updateNodes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">         <span class="attr">catId</span>:siblings[i].<span class="property">data</span>.<span class="property">catId</span>,</span><br><span class="line">         <span class="attr">sort</span>:i,</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">updateNodes</span>);</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"> <span class="comment">//更新子节点的层级</span></span><br><span class="line"> <span class="title function_">updateChildNodeLevel</span>(<span class="params">node</span>)&#123;</span><br><span class="line">     <span class="keyword">if</span>(node.<span class="property">childNodes</span>.<span class="property">length</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;node.<span class="property">childNodes</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">updateNodes</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">           <span class="attr">catId</span>:node.<span class="property">childNodes</span>[i].<span class="property">data</span>.<span class="property">catId</span>,</span><br><span class="line">           <span class="attr">catLevel</span>:node.<span class="property">childNodes</span>[i].<span class="property">level</span>,</span><br><span class="line">         &#125;);</span><br><span class="line">         <span class="variable language_">this</span>.<span class="title function_">updateChildNodeLevel</span>(node.<span class="property">childNodes</span>[i]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure><p><strong>修改分类 controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 批量修改层级</span></span><br><span class="line"><span class="comment">  * &#123;[&quot;catId&quot;:1,&quot;sort&quot;:0],[&quot;catId&quot;:2,&quot;catLeve1&quot;:2]&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update/sort&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">updateSort</span><span class="params">(<span class="meta">@RequestBody</span> CategoryEntity[] category)</span>&#123;</span><br><span class="line">    categoryService.updateBatchById(Arrays.asList(category));</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>设置菜单拖动开关</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-switch</span><br><span class="line">  v-model=&quot;draggable&quot;</span><br><span class="line">  active-text=&quot;开启拖拽&quot;</span><br><span class="line">  inactive-text=&quot;关闭拖拽&quot;</span><br><span class="line">&gt;&lt;/el-switch&gt;</span><br><span class="line">&lt;el-button v-if=&quot;draggable&quot; @click=&quot;batchSave&quot;&gt;批量保存&lt;/el-button&gt;</span><br></pre></td></tr></table></figure><blockquote><p>现在存在的一个问题是每次拖拽的时候，都会发送请求，更新数据库这样频繁的与数据库交互，现在想要实现一个拖拽过程中不更新数据库，拖拽完成后，通过<code>批量保存</code>统一提交拖拽后的数据。</p></blockquote><p><code>&lt;el-button v-if=&quot;draggable&quot; @click=&quot;batchSave&quot;&gt;批量保存&lt;/el-button&gt;</code></p><ul><li>v-if 是指开启开关后才显示</li><li>开启拖拽后应该使用的是 node 信息，而不是数据库信息，因为还没同步到数据库。把相关的信息都修改</li><li>之前为了防止上次数据遗落，归零了展开列表，这样列表又不展开了</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//批量保存拖动分类</span></span><br><span class="line">  <span class="title function_">batchSave</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&#x27;/product/category/update/sort&#x27;</span>),</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(<span class="variable language_">this</span>.<span class="property">updateNodes</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;菜单顺序等修改成功&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//刷新出新的菜单</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">      <span class="comment">//设置需要默认展开的菜单</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">expandedKey</span> = <span class="variable language_">this</span>.<span class="property">pCid</span>;</span><br><span class="line">      <span class="comment">//将更新节点置空</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">updateNodes</span> = [];</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">maxLevel</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>现在还存在一个问题，如果是将一个菜单连续的拖拽，最终还放到了原来的位置，但是 updateNode 中却出现了很多节点更新信息，这样显然也是一个问题。</p><h5 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h5><p>添加删除按钮</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button</span><br><span class="line">  type=&quot;danger&quot;</span><br><span class="line">  plain</span><br><span class="line">  size=&quot;small&quot;</span><br><span class="line">  @click=&quot;batchDelete&quot;</span><br><span class="line">&gt;批量删除&lt;/el-button&gt;</span><br></pre></td></tr></table></figure><p>在<code>&lt;el-tree&gt;</code>中添加 <code>ref=&quot;tree&quot;</code>属性以获得选中节点</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//批量删除</span></span><br><span class="line">  <span class="title function_">batchDelete</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="comment">// this.$refs表示当前el-tree的所有引用</span></span><br><span class="line">     <span class="keyword">let</span> checkNodes = <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">tree</span>.<span class="title function_">getCheckedNodes</span>();</span><br><span class="line">     <span class="keyword">let</span> ids=[];</span><br><span class="line">     <span class="keyword">let</span> names=[];</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;checkNodes.<span class="property">length</span>;i++)&#123;</span><br><span class="line">       ids.<span class="title function_">push</span>(checkNodes[i].<span class="property">catId</span>);</span><br><span class="line">       names.<span class="title function_">push</span>(checkNodes[i].<span class="property">name</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="variable language_">this</span>.$confirm(<span class="string">`是否删除【<span class="subst">$&#123;names&#125;</span>】菜单?`</span>, <span class="string">&quot;提示&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">confirmButtonText</span>: <span class="string">&quot;确定&quot;</span>,</span><br><span class="line">      <span class="attr">cancelButtonText</span>: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//获取选中节点</span></span><br><span class="line">    <span class="comment">//$refs表示所有属性，由于在之前定义了ref=&quot;tree&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&#x27;/product/category/delete&#x27;</span>),</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(ids, <span class="literal">false</span>)</span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;批量删除成功&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ).<span class="title function_">catch</span>();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="五、品牌管理菜单"><a href="#五、品牌管理菜单" class="headerlink" title="五、品牌管理菜单"></a>五、品牌管理菜单</h2><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170803.png" alt="image-20200428164054517"></p><p>（2）将“”逆向工程得到的 resources\src\views\modules\product 文件拷贝到 gulimall/renren-fast-vue/src/views/modules/product 目录下，也就是下面的两个文件</p><p>brand.vue brand-add-or-update.vue</p><p>但是显示的页面没有新增和删除功能，这是因为权限控制的原因，</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210424170807.png" alt="image-20200428170325515"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button</span><br><span class="line">  v-if=&quot;isAuth(&#x27;product:brand:save&#x27;)&quot;</span><br><span class="line">  type=&quot;primary&quot;</span><br><span class="line">  @click=&quot;addOrUpdateHandle()&quot;</span><br><span class="line">&gt;新增&lt;/el-button&gt;</span><br><span class="line">&lt;el-button</span><br><span class="line">  v-if=&quot;isAuth(&#x27;product:brand:delete&#x27;)&quot;</span><br><span class="line">  type=&quot;danger&quot;</span><br><span class="line">  @click=&quot;deleteHandle()&quot;</span><br><span class="line">  :disabled=&quot;dataListSelections.length &lt;= 0&quot;</span><br><span class="line">&gt;批量删除&lt;/el-button&gt;</span><br></pre></td></tr></table></figure><p>查看“isAuth”的定义位置：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501165327.png" alt="image-20200428170437592"></p><p>它是在“index.js”中定义，现在将它设置为返回值为 true，即可显示添加和删除功能。</p><p>再次刷新页面能够看到，按钮已经出现了：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501165332.png" alt="image-20200428170644511"></p><h3 id="添加“显示状态按钮”"><a href="#添加“显示状态按钮”" class="headerlink" title="添加“显示状态按钮”"></a>添加“显示状态按钮”</h3><p>brand.vue</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;template slot-scope=&quot;scope&quot;&gt; scope属性包含了一整行数据</span><br><span class="line">  定义显示效果</span><br><span class="line">  &lt;el-switch</span><br><span class="line">    v-model=&quot;scope.row.showStatus&quot;</span><br><span class="line">    active-color=&quot;#13ce66&quot;</span><br><span class="line">    inactive-color=&quot;#ff4949&quot;</span><br><span class="line">    @change=&quot;updateBrandStatus(scope.row)&quot; 变化会调用函数</span><br><span class="line">    :active-value = &quot;1&quot;</span><br><span class="line">    :inactive-value	= &quot;0&quot;</span><br><span class="line">  &gt;&lt;/el-switch&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">另外导入了</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import AddOrUpdate from &quot;./brand-add-or-update&quot;;</span><br><span class="line">他作为弹窗被brand.vue使用</span><br><span class="line">&lt;!-- 弹窗, 新增 / 修改 --&gt;</span><br><span class="line">&lt;add-or-update v-if=&quot;addOrUpdateVisible&quot; ref=&quot;addOrUpdate&quot; @refreshDataList=&quot;getDataList&quot;&gt;&lt;/add-or-update&gt;</span><br><span class="line"></span><br><span class="line">AddOrUpdate具体是个会话窗</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-dialog</span><br><span class="line">    :title=&quot;!dataForm.id ? &#x27;新增&#x27; : &#x27;修改&#x27;&quot;</span><br><span class="line">    :close-on-click-modal=&quot;false&quot;</span><br><span class="line">    :visible.sync=&quot;visible&quot;</span><br><span class="line">  &gt;</span><br><span class="line"></span><br><span class="line">dataForm.id 修改为 dataForm.brandId 不然新增和修改会显示错误</span><br></pre></td></tr></table></figure><p>brand-add-or-update.vue</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item label=&quot;显示状态&quot; prop=&quot;showStatus&quot;&gt;</span><br><span class="line">    &lt;el-switch v-model=&quot;dataForm.showStatus&quot;</span><br><span class="line">               active-color=&quot;#13ce66&quot;</span><br><span class="line">               inactive-color=&quot;#ff4949&quot;</span><br><span class="line">               :active-value=&quot;1&quot;</span><br><span class="line">               :inactive-value=&quot;0&quot;</span><br><span class="line">               &gt;</span><br><span class="line">    &lt;/el-switch&gt;</span><br><span class="line">&lt;/el-form-item&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//brand.vue 更新开关的状态</span></span><br><span class="line">    <span class="title function_">updateBrandStatus</span>(<span class="params">data</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;最新状态&quot;</span>, data);</span><br><span class="line">      <span class="keyword">let</span> &#123;brandId,showStatus&#125; = data;</span><br><span class="line">      <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&quot;/product/brand/update&quot;</span>),</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(&#123;brandId,showStatus&#125;, <span class="literal">false</span>)</span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;状态更新成功&quot;</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>更新品牌对应的 controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;product/brand&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrandController</span> &#123;</span><br><span class="line">    <span class="comment">/** * 修改 */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line">        brandService.updateById(brand);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>品牌实体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;pms_brand&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrandEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 品牌id */</span></span><br><span class="line">	<span class="meta">@TableId</span></span><br><span class="line">	<span class="keyword">private</span> Long brandId;</span><br><span class="line">	<span class="comment">/*** 品牌名 */</span></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="comment">/*** 品牌logo地址 */</span></span><br><span class="line">	<span class="keyword">private</span> String logo;</span><br><span class="line">	<span class="comment">/*** 介绍 */</span></span><br><span class="line">	<span class="keyword">private</span> String descript;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 显示状态[0-不显示；1-显示]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer showStatus;</span><br><span class="line">	<span class="comment">/** * 检索首字母 */</span></span><br><span class="line">	<span class="keyword">private</span> String firstLetter;</span><br><span class="line">	<span class="comment">/** * 排序 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer sort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加上传"><a href="#添加上传" class="headerlink" title="添加上传"></a>添加上传</h3><p>和传统的单体应用不同，这里我们选择将数据上传到分布式文件服务器上。</p><p>这里我们选择将图片放置到阿里云上，使用对象存储。</p><p>阿里云上使使用对象存储方式：</p><p><img src="/img/loading.gif" data-lazy-src="images/image-20200428182755992.png" alt="image-20200428182755992"></p><p>创建 Bucket</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222732.png" alt="image-20200428183041570"></p><p>上传文件：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222729.png" alt="image-20200428183213694"></p><p>上传成功后，取得图片的 URL</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222727.png" alt="image-20200428183644020"></p><p>这种方式是手动上传图片，实际上我们可以在程序中设置自动上传图片到阿里云对象存储。</p><p>上传模型：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222725.png" alt="image-20200428184029655"></p><p>查看阿里云关于文件上传的帮助： <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/32009.html?spm=a2c4g.11186623.6.768.549d59aaWuZMGJ">https://help.aliyun.com/document_detail/32009.html?spm=a2c4g.11186623.6.768.549d59aaWuZMGJ</a></p><h4 id="1、添加依赖包"><a href="#1、添加依赖包" class="headerlink" title="1、添加依赖包"></a>1、添加依赖包</h4><p>在 Maven 项目中加入依赖项（推荐方式）</p><p>在 Maven 工程中使用 OSS Java SDK，只需在 pom.xml 中加入相应依赖即可。以 3.8.0 版本为例，在<dependencies>内加入如下内容：</dependencies></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2、上传文件流"><a href="#2、上传文件流" class="headerlink" title="2、上传文件流"></a>2、上传文件流</h4><p>以下代码用于上传文件流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Endpoint以杭州为例，其它Region请按实际情况填写。</span></span><br><span class="line"><span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;http://oss-cn-hangzhou.aliyuncs.com&quot;</span>;</span><br><span class="line"><span class="comment">// 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建。</span></span><br><span class="line"><span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> <span class="string">&quot;&lt;yourAccessKeyId&gt;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">accessKeySecret</span> <span class="operator">=</span> <span class="string">&quot;&lt;yourAccessKeySecret&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建OSSClient实例。</span></span><br><span class="line"><span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件流。</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;&lt;yourlocalFile&gt;&quot;</span>);</span><br><span class="line">ossClient.putObject(<span class="string">&quot;&lt;yourBucketName&gt;&quot;</span>, <span class="string">&quot;&lt;yourObjectName&gt;&quot;</span>, inputStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭OSSClient。</span></span><br><span class="line">ossClient.shutdown();</span><br></pre></td></tr></table></figure><p>endpoint 的取值：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222722.png" alt="image-20200428190553350"></p><p>accessKeyId 和 accessKeySecret 需要创建一个 RAM 账号：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222720.png" alt="image-20200428190532924"></p><p>创建用户完毕后，会得到一个“AccessKey ID”和“AccessKeySecret”，然后复制这两个值到代码的“AccessKey ID”和“AccessKeySecret”。</p><p>另外还需要添加访问控制权限：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222612.png" alt="image-20200428191518591"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpload</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Endpoint以杭州为例，其它Region请按实际情况填写。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;oss-cn-shanghai.aliyuncs.com&quot;</span>;</span><br><span class="line">        <span class="comment">// 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> <span class="string">&quot;LTAI4G4W1RA4JXz2QhoDwHhi&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeySecret</span> <span class="operator">=</span> <span class="string">&quot;R99lmDOJumF2x43ZBKT259Qpe70Oxw&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上传文件流。</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;C:\\Users\\Administrator\\Pictures\\timg.jpg&quot;</span>);</span><br><span class="line">        ossClient.putObject(<span class="string">&quot;gulimall-images&quot;</span>, <span class="string">&quot;time.jpg&quot;</span>, inputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭OSSClient。</span></span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功.&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>更为简单的使用方式，是使用 SpringCloud Alibaba</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222607.png" alt="image-20200428195507730"></p><p>详细使用方法，见： <a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/108650.html">https://help.aliyun.com/knowledge_detail/108650.html</a></p><p>（1）添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>（2）创建“AccessKey ID”和“AccessKeySecret”</p><p>（3）配置 key，secret 和 endpoint 相关信息</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">access-key:</span> <span class="string">LTAI4G4W1RA4JXz2QhoDwHhi</span></span><br><span class="line"><span class="attr">secret-key:</span> <span class="string">R99lmDOJumF2x43ZBKT259Qpe70Oxw</span></span><br><span class="line"><span class="attr">oss:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">oss-cn-shanghai.aliyuncs.com</span></span><br></pre></td></tr></table></figure><p>（4）注入 OSSClient 并进行文件上传下载等操作</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222604.png" alt="image-20200428224840535"></p><p>但是这样来做还是比较麻烦，如果以后的上传任务都交给 gulimall-product 来完成，显然耦合度高。最好单独新建一个 Module 来完成文件上传任务。</p><h3 id="其他方式"><a href="#其他方式" class="headerlink" title="其他方式"></a>其他方式</h3><h4 id="1）新建-gulimall-third-party"><a href="#1）新建-gulimall-third-party" class="headerlink" title="1）新建 gulimall-third-party"></a>1）新建 gulimall-third-party</h4><h4 id="2）添加依赖，将原来-gulimall-common-中的“spring-cloud-starter-alicloud-oss”依赖移动到该项目中"><a href="#2）添加依赖，将原来-gulimall-common-中的“spring-cloud-starter-alicloud-oss”依赖移动到该项目中" class="headerlink" title="2）添加依赖，将原来 gulimall-common 中的“spring-cloud-starter-alicloud-oss”依赖移动到该项目中"></a>2）添加依赖，将原来 gulimall-common 中的“spring-cloud-starter-alicloud-oss”依赖移动到该项目中</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.bigdata.gulimall<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gulimall-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>另外也需要在“pom.xml”文件中，添加如下的依赖管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3）在主启动类中开启服务的注册和发现"><a href="#3）在主启动类中开启服务的注册和发现" class="headerlink" title="3）在主启动类中开启服务的注册和发现"></a>3）在主启动类中开启服务的注册和发现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure><h4 id="4）在-nacos-中注册"><a href="#4）在-nacos-中注册" class="headerlink" title="4）在 nacos 中注册"></a>4）在 nacos 中注册</h4><p>（1）创建命名空间“ gulimall-third-party ”</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222601.png" alt="image-20200429075831984"></p><p>（2）在“ gulimall-third-party”命名空间中，创建“ gulimall-third-party.yml”文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alicloud:</span></span><br><span class="line">      <span class="attr">access-key:</span> <span class="string">LTAI4G4W1RA4JXz2QhoDwHhi</span></span><br><span class="line">      <span class="attr">secret-key:</span> <span class="string">R99lmDOJumF2x43ZBKT259Qpe70Oxw</span></span><br><span class="line">      <span class="attr">oss:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">oss-cn-shanghai.aliyuncs.com</span></span><br></pre></td></tr></table></figure><h4 id="5）编写配置文件"><a href="#5）编写配置文件" class="headerlink" title="5）编写配置文件"></a>5）编写配置文件</h4><p>application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">30000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-third-party</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.137</span><span class="number">.14</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io.niceseason.gulimall.product:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><blockquote><p>注意去网关里配置转发，/api/thirdparty/…的路径改完后只有/…，但是其他服务是不去服务名的</p></blockquote><p>bootstrap.properties (2.2.x 版本)</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.nacos.config.name</span>=<span class="string">gulimall-third-party</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">192.168.137.14:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">f995d8ee-c53a-4d29-8316-a1ef54775e00</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].data-id</span>=<span class="string">gulimall-third-party.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p>2.1.X 版本需要改一下</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">gulimall-third-party</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">d973fe23-62bf-454d-9d3c-7ab4beb556d3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].data-id</span>=<span class="string">gulimall-third-party.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><h4 id="6）-编写测试类"><a href="#6）-编写测试类" class="headerlink" title="6） 编写测试类"></a>6） 编写测试类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.niceseason.gulimall.thirdparty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GulimallThirdPartyApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OSSClient ossClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpload</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Endpoint以杭州为例，其它Region请按实际情况填写。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;oss-cn-shanghai.aliyuncs.com&quot;</span>;</span><br><span class="line">        <span class="comment">// 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> <span class="string">&quot;LTAI4G4W1RA4JXz2QhoDwHhi&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeySecret</span> <span class="operator">=</span> <span class="string">&quot;R99lmDOJumF2x43ZBKT259Qpe70Oxw&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//上传文件流。</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;C:\\Users\\Administrator\\Pictures\\timg.jpg&quot;</span>);</span><br><span class="line">        ossClient.putObject(<span class="string">&quot;gulimall-images&quot;</span>, <span class="string">&quot;time3.jpg&quot;</span>, inputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭OSSClient。</span></span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面的逻辑中，我们的想法是先把字节流给服务器，服务器给阿里云，还是传到了服务器。我们需要一些前端代码完成这个功能，字节流就别来服务器了</p><h5 id="改进：服务端签名后直传"><a href="#改进：服务端签名后直传" class="headerlink" title="改进：服务端签名后直传"></a>改进：服务端签名后直传</h5><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31926.html?spm=a2c4g.11186623.6.1527.228d74b8V6IZuT">https://help.aliyun.com/document_detail/31926.html?spm=a2c4g.11186623.6.1527.228d74b8V6IZuT</a></p><p><strong>背景</strong></p><p>采用 JavaScript 客户端直接签名（参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31925.html#concept-frd-4gy-5db">JavaScript 客户端签名直传</a>）时，AccessKeyID 和 AcessKeySecret 会暴露在前端页面，因此存在严重的安全隐患。因此，OSS 提供了服务端签名后直传的方案。</p><p><strong>原理介绍</strong></p><p><a target="_blank" rel="noopener" href="http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/6875011751/p1472.png"><img src="/img/loading.gif" data-lazy-src="http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/6875011751/p1472.png" alt="img"></a></p><p>服务端签名后直传的原理如下：</p><ol><li>用户发送上传 Policy 请求到应用服务器。</li><li>应用服务器返回上传 Policy 和签名给用户。</li><li>用户直接上传数据到 OSS。</li></ol><p>编写“io.niceseason.gulimall.thirdparty.controller.OssController”类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.niceseason.gulimall.thirdparty.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.utils.BinaryUtil;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.MatchMode;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.PolicyConditions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OSS ossClient;</span><br><span class="line">    <span class="meta">@Value</span> (<span class="string">&quot;$&#123;spring.cloud.alicloud.oss.endpoint&#125;&quot;</span>)</span><br><span class="line">    String endpoint ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.oss.bucket&#125;&quot;)</span></span><br><span class="line">    String bucket ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.access-key&#125;&quot;)</span></span><br><span class="line">    String accessId ;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.secret-key&#125;&quot;)</span></span><br><span class="line">    String accessKey ;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oss/policy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">policy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;https://&quot;</span> + bucket + <span class="string">&quot;.&quot;</span> + endpoint; <span class="comment">// host的格式为 bucketname.endpoint</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> format; <span class="comment">// 用户上传文件时指定的前缀。</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; respMap=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expireEndTime</span> <span class="operator">=</span> System.currentTimeMillis() + expireTime * <span class="number">1000</span>;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expireEndTime);</span><br><span class="line">            <span class="type">PolicyConditions</span> <span class="variable">policyConds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PolicyConditions</span>();</span><br><span class="line">            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, <span class="number">0</span>, <span class="number">1048576000</span>);</span><br><span class="line">            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">postPolicy</span> <span class="operator">=</span> ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">            <span class="type">byte</span>[] binaryData = postPolicy.getBytes(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">encodedPolicy</span> <span class="operator">=</span> BinaryUtil.toBase64String(binaryData);</span><br><span class="line">            <span class="type">String</span> <span class="variable">postSignature</span> <span class="operator">=</span> ossClient.calculatePostSignature(postPolicy);</span><br><span class="line"></span><br><span class="line">            respMap= <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">            respMap.put(<span class="string">&quot;accessid&quot;</span>, accessId);</span><br><span class="line">            respMap.put(<span class="string">&quot;policy&quot;</span>, encodedPolicy);</span><br><span class="line">            respMap.put(<span class="string">&quot;signature&quot;</span>, postSignature);</span><br><span class="line">            respMap.put(<span class="string">&quot;dir&quot;</span>, dir);</span><br><span class="line">            respMap.put(<span class="string">&quot;host&quot;</span>, host);</span><br><span class="line">            respMap.put(<span class="string">&quot;expire&quot;</span>, String.valueOf(expireEndTime / <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Assert.fail(e.getMessage());</span></span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> respMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试： <a target="_blank" rel="noopener" href="http://localhost:30000/oss/policy">http://localhost:30000/oss/policy</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;accessid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LTAI4GCo3GXSVxHd4aSSCN4B&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJleHBpcmF0aW9uIjoiMjAyMS0wNS0wMVQxMTowMToxMC43MTlaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjAwMF0sWyJzdGFydHMtd2l0aCIsIiRrZXkiLCIyMDIxLTA1LTAxIl1dfQ==&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;signature&quot;</span><span class="punctuation">:</span> <span class="string">&quot;g/d52Kq2s5k7mmmN1SwEgfBsC8c=&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-05-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://oy-gulimall.oss-cn-shenzhen.aliyuncs.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expire&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1619866870&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>以后在上传文件时的访问路径为“ <a target="_blank" rel="noopener" href="http://localhost:88/api/thirdparty/oss/policy%E2%80%9D%EF%BC%8C">http://localhost:88/api/thirdparty/oss/policy”，</a></p><p>在“gulimall-gateway”中配置路由规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">third_party_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-third-party</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/thirdparty/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/thirdparty/(?&lt;segment&gt;/?.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><p>测试是否能够正常跳转： <a target="_blank" rel="noopener" href="http://localhost:88/api/thirdparty/oss/policy">http://localhost:88/api/thirdparty/oss/policy</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210501222550.png" alt="image-20200429111408164"></p><h3 id="上传组件"><a href="#上传组件" class="headerlink" title="上传组件"></a>上传组件</h3><p>放置项目提供的 upload 文件夹到 components/目录下，一个是单文件上传，另外一个是多文件上传</p><ul><li>policy.js 封装一个 Promise，发送/thirdparty/oss/policy 请求。vue 项目会自动加上 api 前缀</li><li>multiUpload.vue 多文件上传。要改，改方式如下</li><li>singleUpload.vue 单文件上传。要替换里面的 action 中的内容。action=”<a target="_blank" rel="noopener" href="http://gulimall-fermhan.oss-cn-qingdao.aliyuncs.com&quot;/">http://gulimall-fermhan.oss-cn-qingdao.aliyuncs.com&quot;</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gulimall\renren-fast-vue\src\components\upload</span><br></pre></td></tr></table></figure><p>要修改 vue 项目中心品牌 logo 地址，要改成下面形式：</p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210214184915.png"></p><p>brand-add-or-update.vue 中</p><ul><li>修改 el-form-item label=”品牌 logo 地址”内容。</li><li>要使用文件上传组件，先导入 import SingleUpload from “@/components/upload/singleUpload”;</li><li>填入<code>&lt;single-upload v-model=&quot;dataForm.logo&quot;&gt;&lt;/single-upload&gt;</code></li><li>写明要使用的组件,</li></ul><p>点击一下文件上传，发现发送了两个请求</p><p><code>localhost:88/api/thirdparty/oss/policy?t=1613300654238</code></p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210214191009.png"></p><blockquote><p>注： <a target="_blank" rel="noopener" href="https://space.bilibili.com/59372233">特立独行ベ猫</a> 的 vue 前端，他 policy.js 中多写了一个/，导致 404，去掉就好了</p><p>正确形式：localhost:88/api/thirdparty/oss/policy?t=1613300654238</p></blockquote><p>我们在后端准备好了签名 controller，那么前端是在哪里获取的呢</p><p>policy.js</p><p>逻辑为先去访问我们的服务器获取 policy，然后取阿里云，所以我们至少要发送 2 个请求</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&quot;@/utils/httpRequest.js&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">policy</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">http</span>(&#123;</span><br><span class="line">      <span class="comment">// 先去获取签名</span></span><br><span class="line">      <span class="attr">url</span>: http.<span class="title function_">adornUrl</span>(<span class="string">&quot;/third/party/oss/policy&quot;</span>),</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">      <span class="attr">params</span>: http.<span class="title function_">adornParams</span>(&#123;&#125;),</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而文件上传前调用的方法： :before-upload=”beforeUpload”</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">发现该方法返回了一个<span class="keyword">new</span> <span class="title class_">Promise</span>，调用了<span class="title function_">policy</span>()，该方法是policy.<span class="property">js</span>中的</span><br><span class="line"><span class="keyword">import</span> &#123; policy &#125; <span class="keyword">from</span> <span class="string">&quot;./policy&quot;</span>;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"><span class="title function_">beforeUpload</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> _self = <span class="variable language_">this</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">policy</span>() <span class="comment">// 获取签名后得到相应</span></span><br><span class="line">          .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 意思是说policy获取到签名后，把签名信息保存起来</span></span><br><span class="line">            <span class="comment">// console.log(&quot;这是什么$&#123;filename&#125;&quot;);</span></span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">policy</span> = response.<span class="property">data</span>.<span class="property">policy</span>;</span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">signature</span> = response.<span class="property">data</span>.<span class="property">signature</span>;</span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">ossaccessKeyId</span> = response.<span class="property">data</span>.<span class="property">accessid</span>;</span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">key</span> = response.<span class="property">data</span>.<span class="property">dir</span> +<span class="title function_">getUUID</span>()+<span class="string">&quot;_$&#123;filename&#125;&quot;</span>;</span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">dir</span> = response.<span class="property">data</span>.<span class="property">dir</span>;</span><br><span class="line">            _self.<span class="property">dataObj</span>.<span class="property">host</span> = response.<span class="property">data</span>.<span class="property">host</span>;</span><br><span class="line">            <span class="title function_">resolve</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 总的来说什么意思呢？</span></span><br><span class="line">            <span class="comment">// 上传之前先请求签名，保存起来签名</span></span><br><span class="line">            <span class="comment">// 根据action=&quot;http://gulimall-fermhan.oss-cn-qingdao.aliyuncs.com&quot;</span></span><br><span class="line">            <span class="comment">// 结合data信息，提交到云端</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;出错了...&quot;</span>,err)</span><br><span class="line">            <span class="title function_">reject</span>(<span class="literal">false</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>在 vue 中看是 response.data.policy，在控制台看 response.policy。所以去 java 里面改返回值为 R。return R.ok().put(“data”,respMap);</p><h2 id="六、-JSR303-校验"><a href="#六、-JSR303-校验" class="headerlink" title="六、 JSR303 校验"></a>六、 JSR303 校验</h2><p>问题引入：填写 form 时应该有前端校验，后端也应该有校验</p><ul><li><p>前端的校验是 element-ui 表单验证<a target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN/component/form">https://element.eleme.cn/#/zh-CN/component/form</a></p><ul><li><p>Form 组件提供了表单验证的功能，只需要通过 <code>rules</code> 属性传入约定的验证规则，并将 Form-Item 的 <code>prop</code> 属性设置为需校验的字段名即可。校验规则参见 <a target="_blank" rel="noopener" href="https://github.com/yiminghe/async-validator">async-validator</a></p></li><li><p>使用自定义校验规则可以解决字母限制的问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title function_">validatePass2</span> = (<span class="params">rule, value, callback</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (value === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;请再次输入密码&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value !== <span class="variable language_">this</span>.<span class="property">ruleForm</span>.<span class="property">pass</span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;两次输入密码不一致!&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">rules</span>: &#123;</span><br><span class="line">        <span class="attr">checkPass</span>: [</span><br><span class="line">            &#123; <span class="attr">validator</span>: validatePass2, <span class="attr">trigger</span>: <span class="string">&#x27;blur&#x27;</span> &#125;</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// brand-add-or-update.vue firstLetter: [ &#123; validator: (rule, value, callback)</span><br><span class="line">=&gt; &#123; if (value == &quot;&quot;) &#123; callback(new Error(&quot;首字母必须填写&quot;)); &#125; else if</span><br><span class="line">(!/^[a-zA-Z]$/.test(value)) &#123; callback(new Error(&quot;首字母必须a-z或者A-Z之间&quot;));</span><br><span class="line">&#125; else &#123; callback(); &#125; &#125;, trigger: &quot;blur&quot; &#125; ], sort: [ &#123; validator: (rule,</span><br><span class="line">value, callback) =&gt; &#123; if (value == &quot;&quot;) &#123; callback(new</span><br><span class="line">Error(&quot;排序字段必须填写&quot;)); &#125; else if (Number.isInteger(value) || value&lt;0) &#123;</span><br><span class="line">callback(new Error(&quot;排序必须是一个大于等于0的整数&quot;)); &#125; else &#123; callback(); &#125;</span><br><span class="line">&#125;, trigger: &quot;blur&quot; &#125; ]</span><br></pre></td></tr></table></figure></li><li><p>后端：@NotNull 等</p></li></ul><h3 id="NotNull-等"><a href="#NotNull-等" class="headerlink" title="@NotNull 等"></a>@NotNull 等</h3><p><strong>步骤 1：使用校验注解</strong></p><p>在 Java 中提供了一系列的校验方式，它这些校验方式在“<code>javax.validation.constraints</code>”包中，提供了如@Email，@NotNull 等注解。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--jsr3参数校验器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">里面依赖了hibernate-validator</span><br></pre></td></tr></table></figure><p>在非空处理方式上提供了@NotNull，@NotBlank 和@NotEmpty</p><p>（1）@NotNull 该属性不能为 null</p><p>（2）@NotEmpty 该字段不能为 null 或<code>&quot;&quot;</code></p><p>支持以下几种类型</p><ul><li>CharSequence (length of character sequence is evaluated)字符序列（字符序列长度的计算）</li><li>Collection (collection size is evaluated) 集合长度的计算</li><li>Map (map size is evaluated) map 长度的计算</li><li>Array (array length is evaluated) 数组长度的计算</li><li>上面什么意思呢？就是说如果标注的是 map，它会帮你看长度</li></ul><p>（3）@NotBlank：不能为空，不能仅为一个空格</p><h3 id="Valid-内置异常"><a href="#Valid-内置异常" class="headerlink" title="@Valid 内置异常"></a>@Valid 内置异常</h3><p><strong>步骤 2：在请求方法种，使用校验注解@Valid，开启校验，</strong></p><blockquote><p>这里内置异常的意思是发生异常时返回的 json 不是我们的 R 对象，而是 mvc 的内置类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line">brandService.save(brand);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>测试： <a target="_blank" rel="noopener" href="http://localhost:88/api/product/brand/save">http://localhost:88/api/product/brand/save</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210502001906.png" alt="image-20210502001904925"></p><p>在 postman 种发送上面的请求</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-04-29T09:20:46.383+0000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bad Request&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;NotBlank.brandEntity.name&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank.name&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank.java.lang.String&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;brandEntity.name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;defaultMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;不能为空&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;objectName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandEntity&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rejectedValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindingFailure&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NotBlank&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation failed for object=&#x27;brandEntity&#x27;. Error count: 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/product/brand/save&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>能够看到”defaultMessage”: “不能为空”，这些错误消息定义在“hibernate-validator”的“\org\hibernate\validator\ValidationMessages_zh_CN.properties”文件中。在该文件中定义了很多的错误规则：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">javax.validation.constraints.AssertFalse.message</span>     = <span class="string">只能为false</span></span><br><span class="line"><span class="attr">javax.validation.constraints.AssertTrue.message</span>      = <span class="string">只能为true</span></span><br><span class="line"><span class="attr">javax.validation.constraints.DecimalMax.message</span>      = <span class="string">必须小于或等于&#123;value&#125;</span></span><br><span class="line"><span class="attr">javax.validation.constraints.DecimalMin.message</span>      = <span class="string">必须大于或等于&#123;value&#125;</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Digits.message</span>          = <span class="string">数字的值超出了允许范围(只允许在&#123;integer&#125;位整数和&#123;fraction&#125;位小数范围内)</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Email.message</span>           = <span class="string">不是一个合法的电子邮件地址</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Future.message</span>          = <span class="string">需要是一个将来的时间</span></span><br><span class="line"><span class="attr">javax.validation.constraints.FutureOrPresent.message</span> = <span class="string">需要是一个将来或现在的时间</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Max.message</span>             = <span class="string">最大不能超过&#123;value&#125;</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Min.message</span>             = <span class="string">最小不能小于&#123;value&#125;</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Negative.message</span>        = <span class="string">必须是负数</span></span><br><span class="line"><span class="attr">javax.validation.constraints.NegativeOrZero.message</span>  = <span class="string">必须是负数或零</span></span><br><span class="line"><span class="attr">javax.validation.constraints.NotBlank.message</span>        = <span class="string">不能为空</span></span><br><span class="line"><span class="attr">javax.validation.constraints.NotEmpty.message</span>        = <span class="string">不能为空</span></span><br><span class="line"><span class="attr">javax.validation.constraints.NotNull.message</span>         = <span class="string">不能为null</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Null.message</span>            = <span class="string">必须为null</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Past.message</span>            = <span class="string">需要是一个过去的时间</span></span><br><span class="line"><span class="attr">javax.validation.constraints.PastOrPresent.message</span>   = <span class="string">需要是一个过去或现在的时间</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Pattern.message</span>         = <span class="string">需要匹配正则表达式&quot;&#123;regexp&#125;&quot;</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Positive.message</span>        = <span class="string">必须是正数</span></span><br><span class="line"><span class="attr">javax.validation.constraints.PositiveOrZero.message</span>  = <span class="string">必须是正数或零</span></span><br><span class="line"><span class="attr">javax.validation.constraints.Size.message</span>            = <span class="string">个数必须在&#123;min&#125;和&#123;max&#125;之间</span></span><br><span class="line"></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.CreditCardNumber.message</span>        = <span class="string">不合法的信用卡号码</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Currency.message</span>                = <span class="string">不合法的货币 (必须是&#123;value&#125;其中之一)</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.EAN.message</span>                     = <span class="string">不合法的&#123;type&#125;条形码</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Email.message</span>                   = <span class="string">不是一个合法的电子邮件地址</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Length.message</span>                  = <span class="string">长度需要在&#123;min&#125;和&#123;max&#125;之间</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.CodePointLength.message</span>         = <span class="string">长度需要在&#123;min&#125;和&#123;max&#125;之间</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.LuhnCheck.message</span>               = <span class="string">$&#123;validatedValue&#125;的校验码不合法, Luhn模10校验和不匹配</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Mod10Check.message</span>              = <span class="string">$&#123;validatedValue&#125;的校验码不合法, 模10校验和不匹配</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Mod11Check.message</span>              = <span class="string">$&#123;validatedValue&#125;的校验码不合法, 模11校验和不匹配</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.ModCheck.message</span>                = <span class="string">$&#123;validatedValue&#125;的校验码不合法, $&#123;modType&#125;校验和不匹配</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.NotBlank.message</span>                = <span class="string">不能为空</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.NotEmpty.message</span>                = <span class="string">不能为空</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.ParametersScriptAssert.message</span>  = <span class="string">执行脚本表达式&quot;&#123;script&#125;&quot;没有返回期望结果</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.Range.message</span>                   = <span class="string">需要在&#123;min&#125;和&#123;max&#125;之间</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.SafeHtml.message</span>                = <span class="string">可能有不安全的HTML内容</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.ScriptAssert.message</span>            = <span class="string">执行脚本表达式&quot;&#123;script&#125;&quot;没有返回期望结果</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.URL.message</span>                     = <span class="string">需要是一个合法的URL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.time.DurationMax.message</span>        = <span class="string">必须小于$&#123;inclusive == true ? &#x27;或等于&#x27; : &#x27;&#x27;&#125;$&#123;days == 0 ? &#x27;&#x27; : days += &#x27;天&#x27;&#125;$&#123;hours == 0 ? &#x27;&#x27; : hours += &#x27;小时&#x27;&#125;$&#123;minutes == 0 ? &#x27;&#x27; : minutes += &#x27;分钟&#x27;&#125;$&#123;seconds == 0 ? &#x27;&#x27; : seconds += &#x27;秒&#x27;&#125;$&#123;millis == 0 ? &#x27;&#x27; : millis += &#x27;毫秒&#x27;&#125;$&#123;nanos == 0 ? &#x27;&#x27; : nanos += &#x27;纳秒&#x27;&#125;</span></span><br><span class="line"><span class="attr">org.hibernate.validator.constraints.time.DurationMin.message</span>        = <span class="string">必须大于$&#123;inclusive == true ? &#x27;或等于&#x27; : &#x27;&#x27;&#125;$&#123;days == 0 ? &#x27;&#x27; : days += &#x27;天&#x27;&#125;$&#123;hours == 0 ? &#x27;&#x27; : hours += &#x27;小时&#x27;&#125;$&#123;minutes == 0 ? &#x27;&#x27; : minutes += &#x27;分钟&#x27;&#125;$&#123;seconds == 0 ? &#x27;&#x27; : seconds += &#x27;秒&#x27;&#125;$&#123;millis == 0 ? &#x27;&#x27; : millis += &#x27;毫秒&#x27;&#125;$&#123;nanos == 0 ? &#x27;&#x27; : nanos += &#x27;纳秒&#x27;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>想要自定义错误消息，可以覆盖默认的错误提示信息，如@NotBlank 的默认 message 是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NotBlank &#123;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&#123;javax.validation.constraints.NotBlank.message&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>可以在添加注解的时候，修改 message：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank(message = &quot;品牌名必须非空&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure><p>当再次发送请求时，得到的错误提示信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-04-29T09:36:04.125+0000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bad Request&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;NotBlank.brandEntity.name&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank.name&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank.java.lang.String&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;NotBlank&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;brandEntity.name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;name&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;defaultMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;品牌名必须非空&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;objectName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandEntity&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rejectedValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindingFailure&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NotBlank&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Validation failed for object=&#x27;brandEntity&#x27;. Error count: 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/product/brand/save&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>但是这种返回的错误结果并不符合我们的业务需要。</p><h3 id="局部异常处理-BindResult"><a href="#局部异常处理-BindResult" class="headerlink" title="局部异常处理 BindResult"></a>局部异常处理 BindResult</h3><p>步骤 3：给校验的 Bean 后，紧跟一个 BindResult，就可以获取到校验的结果。拿到校验的结果，就可以自定义的封装。</p><p>如下两个方法是一体的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BrandEntity brand, BindingResult result)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>( result.hasErrors())&#123;</span><br><span class="line">          Map&lt;String,String&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">          <span class="comment">//1.获取错误的校验结果</span></span><br><span class="line">          result.getFieldErrors().forEach((item)-&gt;&#123;</span><br><span class="line">              <span class="comment">//获取发生错误时的message</span></span><br><span class="line">              <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> item.getDefaultMessage();</span><br><span class="line">              <span class="comment">//获取发生错误的字段</span></span><br><span class="line">              <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> item.getField();</span><br><span class="line">              map.put(field,message);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">return</span> R.error(<span class="number">400</span>,<span class="string">&quot;提交的数据不合法&quot;</span>).put(<span class="string">&quot;data&quot;</span>,map);</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">brandService.save(brand);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这种是针对于该请求设置了一个内容校验，如果针对于每个请求都单独进行配置，显然不是太合适，实际上可以统一的对于异常进行处理。</p><h3 id="统一异常处理-ExceptionHandler"><a href="#统一异常处理-ExceptionHandler" class="headerlink" title="统一异常处理@ExceptionHandler"></a>统一异常处理<code>@ExceptionHandler</code></h3><p>上文说到 @ ExceptionHandler 需要进行异常处理的方法必须与出错的方法在同一个 Controller 里面。那么当代码加入了 @ControllerAdvice，则不需要必须在同一个 controller 中了。这也是 Spring 3.2 带来的新特性。从名字上可以看出大体意思是控制器增强。 也就是说，@controlleradvice + @ ExceptionHandler 也可以实现全局的异常捕捉。</p><p>可以使用 SpringMvc 所提供的@ControllerAdvice，通过“basePackages”能够说明处理哪些路径下的异常。</p><p>（1）抽取一个异常处理类</p><ul><li><code>@ControllerAdvice</code>标注在类上，通过“basePackages”能够说明处理哪些路径下的异常。</li><li><code>@ExceptionHandler(value = 异常类型.class)</code> 标注在方法上</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.niceseason.gulimall.product.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.niceseason.common.utils.R;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 集中处理所有异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice(basePackages = &quot;io.niceseason.gulimall.product.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallExceptionAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleValidException</span><span class="params">(MethodArgumentNotValidException exception)</span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> exception.getBindingResult();</span><br><span class="line">        bindingResult.getFieldErrors().forEach(fieldError -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> fieldError.getDefaultMessage();</span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> fieldError.getField();</span><br><span class="line">            map.put(field,message);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.error(<span class="string">&quot;数据校验出现问题&#123;&#125;,异常类型&#123;&#125;&quot;</span>,exception.getMessage(),exception.getClass());</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="number">400</span>,<span class="string">&quot;数据校验出现问题&quot;</span>).put(<span class="string">&quot;data&quot;</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（2）测试： <a target="_blank" rel="noopener" href="http://localhost:88/api/product/brand/save">http://localhost:88/api/product/brand/save</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210502172833.png" alt="image-20200429183334783"></p><h4 id="（3）默认异常处理"><a href="#（3）默认异常处理" class="headerlink" title="（3）默认异常处理"></a>（3）默认异常处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(value = Throwable.class)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">handleException</span><span class="params">(Throwable throwable)</span>&#123;</span><br><span class="line">    log.error(<span class="string">&quot;未知异常&#123;&#125;,异常类型&#123;&#125;&quot;</span>,throwable.getMessage(),throwable.getClass());</span><br><span class="line">    <span class="keyword">return</span> R.error(BizCodeEnum.UNKNOW_EXEPTION.getCode(),BizCodeEnum.UNKNOW_EXEPTION.getMsg());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（4）错误状态码"><a href="#（4）错误状态码" class="headerlink" title="（4）错误状态码"></a>（4）错误状态码</h4><p>上面代码中，针对于错误状态码，是我们进行随意定义的，然而正规开发过程中，错误状态码有着严格的定义规则，如该在项目中我们的错误状态码定义</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210502172837.png" alt="image-20200429183748249"></p><p>为了定义这些错误状态码，我们可以单独定义一个常量类，用来存储这些错误状态码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.niceseason.common.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 错误码和错误信息定义类</span></span><br><span class="line"><span class="comment"> * 1. 错误码定义规则为5为数字</span></span><br><span class="line"><span class="comment"> * 2. 前两位表示业务场景，最后三位表示错误码。例如：100001。10:通用 001:系统未知异常</span></span><br><span class="line"><span class="comment"> * 3. 维护错误码后需要维护错误描述，将他们定义为枚举形式</span></span><br><span class="line"><span class="comment"> * 错误码列表：</span></span><br><span class="line"><span class="comment"> *  10: 通用</span></span><br><span class="line"><span class="comment"> *      001：参数格式校验</span></span><br><span class="line"><span class="comment"> *  11: 商品</span></span><br><span class="line"><span class="comment"> *  12: 订单</span></span><br><span class="line"><span class="comment"> *  13: 购物车</span></span><br><span class="line"><span class="comment"> *  14: 物流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BizCodeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    UNKNOW_EXEPTION(<span class="number">10000</span>,<span class="string">&quot;系统未知异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    VALID_EXCEPTION( <span class="number">10001</span>,<span class="string">&quot;参数格式校验失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    BizCodeEnum(<span class="type">int</span> code, String msg) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（5）测试： <a target="_blank" rel="noopener" href="http://localhost:88/api/product/brand/save">http://localhost:88/api/product/brand/save</a></p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210502172842.png" alt="image-20200429191830967" style="zoom:67%"><h2 id="七、分组校验功能（完成多场景的复杂校验）"><a href="#七、分组校验功能（完成多场景的复杂校验）" class="headerlink" title="七、分组校验功能（完成多场景的复杂校验）"></a>七、分组校验功能（完成多场景的复杂校验）</h2><p>前面解决了统一异常处理，但是现状有新的需求是对同一实体类参数也要区分场景</p><p>如果新增和修改两个接口需要验证的字段不同，比如 id 字段，新增可以不传递，但是修改必须传递 id，我们又不可能写两个 vo 来满足不同的校验规则。所以就需要用到分组校验来实现。</p><p>步骤：</p><ul><li>创建分组接口 Insert.class Update.class</li><li>在 VO 的属性中标注@NotBlank 等注解，并指定要使用的分组，如<code>@NotNull(message = &quot;用户姓名不能为空&quot;,groups = &#123;Insert.class,Update.class&#125;)</code></li><li>controller 的方法上或者方法参数上写要处理的分组的接口信息，如<code>@Validated(AddGroup.class)</code></li></ul><h3 id="1、-NotNull-groups-A-class"><a href="#1、-NotNull-groups-A-class" class="headerlink" title="1、@NotNull(groups={A.class})"></a>1、@NotNull(groups={A.class})</h3><p>1、给校验注解，标注上 groups，指定什么情况下才需要进行校验</p><p>如：指定在更新和添加的时候，都需要进行校验</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotNull(message = &quot;修改必须定制品牌id&quot;, groups = &#123;UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@Null(message = &quot;新增不能指定id&quot;, groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@TableId</span></span><br><span class="line"><span class="keyword">private</span> Long brandId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 品牌logo地址 修改可以不带上logoURL</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@NotBlank(groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@URL(message = &quot;logo必须是一个合法的URL地址&quot;, groups=&#123;AddGroup.class, UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String logo;</span><br><span class="line">注意上面因为<span class="meta">@NotBlank</span>没有指定UpdateGroup分组，所以不生效。此时update时可以不携带，但带了一定得是url地址</span><br></pre></td></tr></table></figure><p>在这种情况下，没有指定分组的校验注解，默认是不起作用的。想要起作用就必须要加 groups。</p><h3 id="2、-Validated"><a href="#2、-Validated" class="headerlink" title="2、@Validated"></a>2、@Validated</h3><p>业务方法参数上使用@Validated 注解</p><p>@Validated 的 value 值指定要使用的一个或多个分组</p><p>JSR-303 defines validation groups as custom annotations which an application declares for the sole purpose of using<br>them as type-safe group arguments, as implemented in SpringValidatorAdapter.</p><p>JSR-303 将验证组定义为自定义注释，应用程序声明的唯一目的是将它们用作类型安全组参数，如 SpringValidatorAdapter 中实现的那样。</p><p>Other SmartValidator implementations may support class arguments in other ways as well.</p><p>其他 SmartValidator 实现也可以以其他方式支持类参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增场景添加 新增分组注解</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Validated(AddGroup.class)</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span> &#123;</span><br><span class="line">    brandService.save(brand);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除场景添加 删除分组注解</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] brandIds)</span> &#123;</span><br><span class="line">    brandService.removeByIds(Arrays.asList(brandIds));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总结：controller 接收到之后，根据@Validated 表明的分组信息，品牌对应的校验注解。</p><h3 id="3、分组校验的默认校验"><a href="#3、分组校验的默认校验" class="headerlink" title="3、分组校验的默认校验"></a>3、分组校验的默认校验</h3><p>这里要是指定了分组，实体类上的注解就是指定了分组的注解才生效，</p><p>没有指定分组的默认不生效，要是没有指定分组，就是对没有指定分组的注解生效，指定分组的注解就不生效了</p><p>可以在自定义的异常分组接口中继承<code>Default</code>类。所有没有写明 group 的都属于 Default 分组。</p><blockquote><p>此外还可以在实体类上标注@GroupSequece({A.class,B.class})指定校验顺序</p><p>通过@GroupSequence 指定验证顺序：先验证 A 分组，如果有错误立即返回而不会验证 B 分组，接着如果 A 分组验证通过了，那么才去验证 B 分组，最后指定 User.class 表示那些没有分组的在最后。这样我们就可以实现按顺序验证分组了。</p><p>关于 Default，此处我 springvalidation 默认生成的验证接口，验证的范围是所有带有验证信息的属性，</p><p>若是属性上方写了验证组，则是验证该组内的属性</p><p>若是验证实体类类上写了 GroupSequence({}) 则说明重写了 Default 验证接口，Default 就按照 GroupSequence 里所写的组信息进行验证</p></blockquote><h2 id="八、自定义校验功能"><a href="#八、自定义校验功能" class="headerlink" title="八、自定义校验功能"></a>八、自定义校验功能</h2><p>Hibernate Validator 提供了一系列内置的校验注解，可以满足大部分的校验需求。但是，仍然有一部分校验需要特殊定制，例如某个字段的校验，我们提供两种校验强度，当为<code>normal</code>强度时我们<strong>除了&lt;&gt;号之外</strong>，都允许出现。当为<code>strong</code>强度时，我们只允许出现常用<strong>汉字，数字，字母</strong>。内置的注解对此则无能为力，我们试着通过自定义校验来解决这个问题。</p><p>场景：要校验<code>showStatus</code>的 0/1 状态，可以用正则，但我们可以利用其他方式解决复杂场景。比如我们想要下面的场景</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 显示状态[0-不显示；1-显示]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@NotNull(groups = &#123;AddGroup.class, UpdateStatusGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@ListValue(vals = &#123;0,1&#125;, groups = &#123;AddGroup.class, UpdateGroup.class, UpdateStatusGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre></td></tr></table></figure><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--校验--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--高版本需要javax.el--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1-b08<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1、编写一个自定义的校验注解"><a href="#1、编写一个自定义的校验注解" class="headerlink" title="1、编写一个自定义的校验注解"></a>1、编写一个自定义的校验注解</h3><p>必须有 3 个属性</p><ul><li>message()错误信息</li><li>groups()分组校验</li><li>payload()自定义负载信息</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = &#123; ListValueConstraintValidator.class&#125;)</span></span><br><span class="line"><span class="meta">@Target(&#123; METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListValue &#123;</span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&#123;io.niceseason.common.valid.ListValue.message&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Payload</span>&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为上面的 message 值对应的最终字符串需要去 ValidationMessages.properties 中获得，所以我们在 common 中新建文件<code>ValidationMessages.properties</code></p><p>文件内容</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com.atguigu.common.valid.ListValue.message</span>=<span class="string">必须提交指定的值 [0,1]</span></span><br></pre></td></tr></table></figure><h3 id="2、编写一个自定义的校验器"><a href="#2、编写一个自定义的校验器" class="headerlink" title="2、编写一个自定义的校验器"></a>2、编写一个自定义的校验器</h3><p>上面只是定义了异常消息，但是怎么验证是否异常还没说，下面的 ConstraintValidator 就是说的</p><p>比如我们要限定某个属性值必须在一个给定的集合里，那么就通过重写 initialize()方法，指定可以有哪些元素。</p><p>而 controller 接收到的数据用 isValid(验证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListValueConstraintValidator</span> <span class="keyword">implements</span> <span class="title class_">ConstraintValidator</span>&lt;ListValue,Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; set=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(ListValue constraintAnnotation)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] value = constraintAnnotation.value();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : value) &#123;</span><br><span class="line">            set.add(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValid</span><span class="params">(Integer value, ConstraintValidatorContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  set.contains(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>具体的校验类需要实现<code>ConstraintValidator</code>接口，第一个泛型参数是所对应的校验注解类型，第二个是校验对象类型。在初始化方法<code>initialize</code>中，我们可以先做一些别的初始化工作，例如这里我们获取到注解上的 value 并保存下来，然后生成 set 对象。</p><p>真正的验证逻辑由<code>isValid</code>完成，如果传入形参的属性值在这个 set 里就返回 true，否则返回 false</p><h3 id="3、关联自定义的校验器和自定义的校验注解"><a href="#3、关联自定义的校验器和自定义的校验注解" class="headerlink" title="3、关联自定义的校验器和自定义的校验注解"></a>3、关联自定义的校验器和自定义的校验注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Constraint(validatedBy = &#123; ListValueConstraintValidator.class&#125;)</span></span><br></pre></td></tr></table></figure><p>一个校验注解可以匹配多个校验器</p><h3 id="4、使用实例"><a href="#4、使用实例" class="headerlink" title="4、使用实例"></a>4、使用实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示状态[0-不显示；1-显示]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ListValue(value = &#123;0,1&#125;,groups =&#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre></td></tr></table></figure><blockquote><p>如验证手机号格式，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/GAMEloft9/article/details/81699500">https://blog.csdn.net/GAMEloft9/article/details/81699500</a></p></blockquote><h2 id="九、商品-SPU-和-SKU-管理"><a href="#九、商品-SPU-和-SKU-管理" class="headerlink" title="九、商品 SPU 和 SKU 管理"></a>九、商品 SPU 和 SKU 管理</h2><p>重新执行“sys_menus.sql”</p><ul><li><p>SPU：standard product unit(标准化产品单元)：是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该集合描述了一个产品的特性。</p><ul><li>如 iphoneX 是 SPU</li></ul></li><li><p>SKU：stock keeping unit(库存量单位)：库存进出计量的基本单元，可以是件/盒/托盘等单位。SKU 是对于大型连锁超市 DC 配送中心物流管理的一个必要的方法。现在已经被引申为产品统一编号的简称，每种产品对应有唯一的 SKU 号。</p><ul><li>如 iphoneX 64G 黑色 是 SKU</li></ul></li><li><p>基础属性：同一个 SPU 拥有的特性叫<strong>基本属性</strong>。如机身长度，这个是手机共用的属性。而每款手机的属性值不同</p><ul><li>也可以叫规格参数</li></ul></li><li><p>销售属性：能决定库存量的叫<strong>销售属性</strong>。如颜色</p></li></ul><p>3、基本属性〖规格参数〗与销售属性<br>每个分类下的商品共享规格参数，与销售属性。只是有些商品不一定要用这个分类下全部的属性；</p><ul><li>属性是以三级分类组织起来的</li><li>规格参数中有些是可以提供检索的</li><li><strong>规格参数</strong>也是<strong>基本属性</strong>，他们具有自己的分组</li><li>属性的分组也是以三级分类组织起来的</li><li>属性名确定的，但是值是每一个商品不同来决定的</li></ul><h4 id="pms-数据库表"><a href="#pms-数据库表" class="headerlink" title="==pms 数据库表=="></a>==pms 数据库表==</h4><p>pms 数据库下的 attr 属性表，attr-group 表</p><ul><li>attr-group-id：几号分组</li><li>catelog-id：什么类别下的，比如手机</li></ul><p>根据商品找到 spu-id，attr-id</p><p>属性关系-规格参数-销售属性-三级分类 关联关系</p><blockquote><p>每个分类有特点的属性</p></blockquote><p>先通过分类找打对应的数学分组，然后根据属性分组查到拥有的数学</p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210215122413.png"></p><p>SPU-SKU 属性表</p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210215122619.png"></p><p>荣耀 V20 有两个属性，网络和像素，但是这两个属性的 spu 是同一个，代表是同款手机。</p><p>sku 表里保存 spu 是同一手机，sku 可能相同可能不同，相同代表是同一款，不同代表是不同款。</p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210217111305.png"></p><p>属性表说明每个属性的 枚举值</p><p>分类表有所有的分类，但有父子关系</p><h2 id="十、品牌管理和关联分类"><a href="#十、品牌管理和关联分类" class="headerlink" title="十、品牌管理和关联分类"></a>十、品牌管理和关联分类</h2><p>点击子组件，父组件触发事件</p><blockquote><p>前端代码不自己编写了，复制/代码/前端/modules/文件夹里面的内容复制到 vs 中</p><p>如果左侧显示没有视频全，是因为没有执行 sys_menus.sql</p></blockquote><h5 id="接口文档地址"><a href="#接口文档地址" class="headerlink" title="接口文档地址"></a>接口文档地址</h5><p><a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135">https://easydoc.xyz/s/78237135</a></p><h4 id="1、属性分组"><a href="#1、属性分组" class="headerlink" title="1、属性分组"></a>1、属性分组</h4><p>后台：商品系统/平台属性/属性分组</p><p>现在想要实现点击菜单的左边，能够实现在右边展示数据</p><p>现在想要实现点击菜单的左边，能够实现在右边展示数据</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210502172808.png" alt="image-20200430215649355"></p><p>根据其他的请求地址 <a target="_blank" rel="noopener" href="http://localhost:8001/#/product-attrgroup">http://localhost:8001/#/product-attrgroup</a></p><p>所以应该有 product/attrgroup.vue。我们之前写过 product/cateory.vue，现在我们要抽象到 common/cateory.vue（也就是左侧的 tree 单独成一个 vue 组件）</p><p>1）左侧内容：</p><p>要在左面显示菜单，右面显示表格。复制<code>&lt;el-row :gutter=&quot;20&quot;&gt;。。。</code>，放到 attrgroup.vue 的<code>&lt;template&gt;</code>。20 表示列间距</p><p>去 element-ui 文档里找到布局，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-row :gutter=&quot;20&quot;&gt;</span><br><span class="line">    &lt;el-col :span=&quot;6&quot;&gt; &lt;div class=&quot;grid-content bg-purple&quot;&gt;&lt;/div&gt;&lt;/el-col&gt;</span><br><span class="line">    &lt;el-col :span=&quot;18&quot;&gt;&lt;div class=&quot;grid-content bg-purple&quot;&gt;&lt;/div&gt;&lt;/el-col&gt;</span><br><span class="line">&lt;/el-row&gt;</span><br></pre></td></tr></table></figure><p>分为 2 个模块，分别占 6 列和 18 列（分别是 tree 和当前 spu 等信息）</p><p>有了布局之后，要在里面放内容。接下来要抽象一个分类 vue。新建 common/category，生成 vue 模板。把之前写的 2-tree 放到<code>&lt;template&gt;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree</span><br><span class="line">  :data=&quot;menus&quot;</span><br><span class="line">  :props=&quot;defaultProps&quot;</span><br><span class="line">  node-key=&quot;catId&quot;</span><br><span class="line">  ref=&quot;menuTree&quot;</span><br><span class="line">  @node-click=&quot;nodeClick&quot;</span><br><span class="line">&gt;&lt;/el-tree&gt;</span><br><span class="line">所以他把menus绑定到了菜单上， 所以我们应该在export default &#123;中有menus的信息</span><br><span class="line">该具体信息会随着点击等事件的发生会改变值（或比如created生命周期时），</span><br><span class="line">tree也就同步变化了</span><br></pre></td></tr></table></figure><p>common/category 写好后，就可以在 attrgroup.vue 中导入使用了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import Category from &quot;../common/category&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  //import引入的组件需要注入到对象中才能使用。组件名:自定义的名字，一致可以省略</span><br><span class="line">  components: &#123; Category&#125;,</span><br></pre></td></tr></table></figure><p>导入了之后，就可以在<code>attrgroup.vue</code>中找合适位置放好</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-row :gutter=&quot;20&quot;&gt;</span><br><span class="line">    &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">      &lt;category @tree-node-click=&quot;treenodeclick&quot;&gt;&lt;/category&gt; &lt;/el-col</span><br><span class="line">  &gt;&lt;/el-row&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>2）右侧表格内容：</p><p>开始填写属性分组页面右侧的表格</p><p>复制 gulimall-product\src\main\resources\src\views\modules\product\attrgroup.vue 中的部分内容 div 到<code>attrgroup.vue</code></p><p>批量删除是弹窗 add-or-update</p><p>导入 data、结合 components</p><h4 id="2、父子组件传递数据"><a href="#2、父子组件传递数据" class="headerlink" title="2、父子组件传递数据"></a>2、父子组件传递数据</h4><p>要实现功能：点击左侧，右侧表格对应内容显示。</p><p>父子组件传递数据：category.vue 点击时，引用它的 attgroup.vue 能感知到， 然后通知到 add-or-update</p><p>比如嵌套 div，里层 div 有事件后冒泡到外层 div（是指一次点击调用了两个 div 的点击函数）</p><p>1）子组件给父组件传递数据，事件机制；</p><p>在 category 中绑定 node-click 事件，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree</span><br><span class="line">  :data=&quot;menus&quot;</span><br><span class="line">  :props=&quot;defaultProps&quot;</span><br><span class="line">  node-key=&quot;catId&quot;</span><br><span class="line">  ref=&quot;menuTree&quot;</span><br><span class="line">  @node-click=&quot;nodeClick&quot;</span><br><span class="line">&gt;&lt;/el-tree&gt;</span><br></pre></td></tr></table></figure><h4 id="3、this-emit"><a href="#3、this-emit" class="headerlink" title="3、this.$emit()"></a>3、this.$emit()</h4><p>2）子组件给父组件发送一个事件，携带上数据；</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">nodeClick</span>(<span class="params">data,Node,component</span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;子组件&quot;</span>,data,<span class="title class_">Node</span>,component);</span><br><span class="line">   <span class="variable language_">this</span>.$emit(<span class="string">&quot;tree-node-click&quot;</span>,data,<span class="title class_">Node</span>,component);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>this.$emit(事件名,”携带的数据”);</p><p>3）父组件中的获取发送的事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;category @tree-node-click=&quot;treeNodeClick&quot;&gt;&lt;/category&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取发送的事件数据</span></span><br><span class="line"><span class="title function_">treenodeclick</span>(<span class="params">data, node, component</span>) &#123;</span><br><span class="line">    <span class="comment">//只有点击三层分类时才进行查询</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">level</span> == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">catId</span> = data.<span class="property">catId</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">getDataList</span>(); <span class="comment">//重新查询</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="title function_">getDataList</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataListLoading</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">`/product/attrgroup/list/<span class="subst">$&#123;<span class="variable language_">this</span>.catId&#125;</span>`</span>),</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="attr">params</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornParams</span>(&#123;</span><br><span class="line">            <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">pageIndex</span>,</span><br><span class="line">            <span class="attr">limit</span>: <span class="variable language_">this</span>.<span class="property">pageSize</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">key</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dataList</span> = data.<span class="property">page</span>.<span class="property">list</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">totalPage</span> = data.<span class="property">page</span>.<span class="property">totalCount</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dataList</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">totalPage</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataListLoading</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>4）分组新增&amp;级联选择器</p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503012549.png" alt="2" style="zoom:38%"><p>由于三级分类的<code>children</code>属性为<code>[]</code>,因此显示效果如上，为了避免这种效果，我们可以为该字段添加注解 <code>@JsonInclude(JsonInclude.Include.NON_EMPTY)</code>,表示当只有该字段不为空时才会返回该属性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;CategoryEntity&gt; children;</span><br></pre></td></tr></table></figure><p>4）分组修改与回显</p><p>由于修改时所属分类不能正常回显，因为缺少完整的三级路径，因此我们在<code>AttrGroupEntity</code>中添加字段<code>catelogPath</code>,并使用递归查找</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Long[] catelogPath;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/info/&#123;attrGroupId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;attrGroupId&quot;)</span> Long attrGroupId)</span>&#123;</span><br><span class="line">    <span class="type">AttrGroupEntity</span> <span class="variable">attrGroup</span> <span class="operator">=</span> attrGroupService.getById(attrGroupId);</span><br><span class="line">    Long[] catelogPath=categoryService.findCatelogPathById(attrGroup.getCatelogId());</span><br><span class="line">    attrGroup.setCatelogPath(catelogPath);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;attrGroup&quot;</span>, attrGroup);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用递归查找该路径</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long[] findCatelogPathById(Long categorygId) &#123;</span><br><span class="line">    List&lt;Long&gt; path = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    findPath(categorygId, path);</span><br><span class="line">    Collections.reverse(path);</span><br><span class="line">    Long[] objects = path.toArray(<span class="keyword">new</span> <span class="title class_">Long</span>[path.size()]);</span><br><span class="line">    <span class="keyword">return</span>  objects;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findPath</span><span class="params">(Long categorygId, List&lt;Long&gt; path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (categorygId!=<span class="number">0</span>)&#123;</span><br><span class="line">        path.add(categorygId);</span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">byId</span> <span class="operator">=</span> getById(categorygId);</span><br><span class="line">        findPath(byId.getParentCid(),path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>优化：会话关闭时清空内容，防止下次开启还遗留数据</p><p><code>attrgroup-add-or-update.vue</code></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20210503010806.png" alt="image-20210503010805200"></p><h4 id="4、分页插件"><a href="#4、分页插件" class="headerlink" title="4、分页插件"></a>4、分页插件</h4><ul><li><p>官网：<a target="_blank" rel="noopener" href="https://mp.baomidou.com/guide/page.html">https://mp.baomidou.com/guide/page.html</a></p></li><li><p>个人 mybatis-plus 笔记：<a href="https://oy6090.top/posts/5d2bcff8/">https://oy6090.top/posts/5d2bcff8/</a></p></li></ul><h5 id="mp-常用注解"><a href="#mp-常用注解" class="headerlink" title="mp 常用注解"></a>mp 常用注解</h5><p>比如@TableName，标注在实体类上，使用的时候定义 mapper 接口指定实体类泛型即可</p><p>也可以使用@TableField 映射属性和数据库字段</p><p>@TableLogic 用于逻辑删除</p><h5 id="wrapper"><a href="#wrapper" class="headerlink" title="wrapper"></a>wrapper</h5><p>查询条件用 QueryWrapper 包装</p><p>wrapper.allEq(map);用于指定字段值</p><p>wrapper.gt(“age”,2);// 大于 // 用于指定字段与常数关系</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">QueryWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>();</span><br><span class="line">wrapper.orderByDesc(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">wrapper.orderByAsc(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">wrapper.having(<span class="string">&quot;id &gt; 8&quot;</span>);</span><br><span class="line">mapper.selectList(wrapper).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">mapper.selectBatchIds(Arrays.asList(<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>));</span><br></pre></td></tr></table></figure><h5 id="mp-分页使用"><a href="#mp-分页使用" class="headerlink" title="mp 分页使用"></a>mp 分页使用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.baomidou.cloud.service.*.mapper*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PaginationInterceptor <span class="title function_">paginationInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PaginationInterceptor</span> <span class="variable">paginationInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaginationInterceptor</span>();</span><br><span class="line">        <span class="comment">// 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false</span></span><br><span class="line">        <span class="comment">// paginationInterceptor.setOverflow(false);</span></span><br><span class="line">        <span class="comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span></span><br><span class="line">        <span class="comment">// paginationInterceptor.setLimit(500);</span></span><br><span class="line">        <span class="comment">// 开启 count 的 join 优化,只针对部分 left join</span></span><br><span class="line">        paginationInterceptor.setCountSqlParser(<span class="keyword">new</span> <span class="title class_">JsqlParserCountOptimize</span>(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">return</span> paginationInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://mp.baomidou.com/">参考 MyBatis-Plus 官网</a></p><ul><li>接口<code>IPage&lt;User&gt; selectPageVo(Page&lt;?&gt; page, Integer state);</code></li><li>xml：不变</li><li>接收的返回值<code>IPage&lt;T&gt;</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="type">Page</span> <span class="variable">result</span> <span class="operator">=</span> mapper.selectPage(page,<span class="literal">null</span>);</span><br><span class="line">result.getRecords()</span><br></pre></td></tr></table></figure><blockquote><p>如果要自定义 SQL，在接口里单独写@Select 注解或者在 xml 里写好即可</p></blockquote><h5 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h5><p>在 Service 实现层 this.page(Page,QueryWrapper)</p><p>项目中用的分页方式，不是自己创建 page 对象，而是根据 url 的参数自动封装</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.common.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Query</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IPage&lt;T&gt; <span class="title function_">getPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getPage(params, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IPage&lt;T&gt; <span class="title function_">getPage</span><span class="params">(Map&lt;String, Object&gt; params,  // 参数有curPage limit order  sidx  asc</span></span><br><span class="line"><span class="params">                            String defaultOrderField,// 默认排序字段</span></span><br><span class="line"><span class="params">                            <span class="type">boolean</span> isAsc)</span> &#123; <span class="comment">// 默认降序</span></span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">curPage</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// new Page&lt;&gt;(curPage, limit);   .</span></span><br><span class="line">        <span class="comment">// page.addOrder(OrderItem.asc(orderField));</span></span><br><span class="line">        <span class="comment">// page.addOrder(OrderItem.desc(orderField));</span></span><br><span class="line">        <span class="comment">// page.addOrder(OrderItem.asc(defaultOrderField));</span></span><br><span class="line">        <span class="comment">// page.addOrder(OrderItem.desc(defaultOrderField));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 页码</span></span><br><span class="line">        <span class="keyword">if</span>(params.get(Constant.PAGE) != <span class="literal">null</span>)&#123;</span><br><span class="line">            curPage = Long.parseLong((String)params.get(Constant.PAGE));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 偏移</span></span><br><span class="line">        <span class="keyword">if</span>(params.get(Constant.LIMIT) != <span class="literal">null</span>)&#123;</span><br><span class="line">            limit = Long.parseLong((String)params.get(Constant.LIMIT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分页对象  mybatis-plus内容，实现Ipage</span></span><br><span class="line">        Page&lt;T&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(curPage, limit);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分页参数</span></span><br><span class="line">        params.put(Constant.PAGE, page);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排序字段</span></span><br><span class="line">        <span class="comment">// 防止SQL注入（因为sidx、order是通过拼接SQL实现排序的，会有SQL注入风险）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderField</span> <span class="operator">=</span> SQLFilter.sqlInject((String)params.get(Constant.ORDER_FIELD));</span><br><span class="line">        <span class="type">String</span> <span class="variable">order</span> <span class="operator">=</span> (String)params.get(Constant.ORDER);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前端字段排序</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotEmpty(orderField) &amp;&amp; StringUtils.isNotEmpty(order))&#123;</span><br><span class="line">            <span class="keyword">if</span>(Constant.ASC.equalsIgnoreCase(order)) &#123;</span><br><span class="line">                <span class="keyword">return</span>  page.addOrder(OrderItem.asc(orderField));</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> page.addOrder(OrderItem.desc(orderField));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果已经传来了排序字段，已经返回了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 没有排序字段，则不排序</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(defaultOrderField))&#123;</span><br><span class="line">            <span class="keyword">return</span> page;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认排序</span></span><br><span class="line">        <span class="keyword">if</span>(isAsc) &#123;</span><br><span class="line">            page.addOrder(OrderItem.asc(defaultOrderField));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            page.addOrder(OrderItem.desc(defaultOrderField));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="常规用法：XML-自定义分页"><a href="#常规用法：XML-自定义分页" class="headerlink" title="常规用法：XML 自定义分页"></a>常规用法：XML 自定义分页</h5><blockquote><p>这种用法其实是 mybatis 的内容</p></blockquote><ul><li>UserMapper.java 方法内容</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;<span class="comment">//可以继承或者不继承BaseMapper</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page 分页对象,xml中可以从里面进行取值,传递参数 Page 即自动分页,必须放在第一位(你可以继承Page实现自己的分页对象)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state 状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 分页对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IPage&lt;User&gt; <span class="title function_">selectPageVo</span><span class="params">(Page&lt;?&gt; page, Integer state)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>UserMapper.xml 等同于编写一个普通 list 查询，mybatis-plus 自动替你分页</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectPageVo&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.baomidou.cloud.entity.UserVo&quot;</span>&gt;</span></span><br><span class="line">    SELECT id,name FROM user WHERE state=#&#123;state&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>UserServiceImpl.java 调用分页方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IPage&lt;User&gt; <span class="title function_">selectUserPage</span><span class="params">(Page&lt;User&gt; page, Integer state)</span> &#123;</span><br><span class="line">    <span class="comment">// 不进行 count sql 优化，解决 MP 无法自动优化 SQL 问题，这时候你需要自己查询 count 部分</span></span><br><span class="line">    <span class="comment">// page.setOptimizeCountSql(false);</span></span><br><span class="line">    <span class="comment">// 当 total 为小于 0 或者设置 setSearchCount(false) 分页插件不会进行 count 查询</span></span><br><span class="line">    <span class="comment">// 要点!! 分页返回的对象与传入的对象是同一个</span></span><br><span class="line">    <span class="keyword">return</span> userMapper.selectPageVo(page, state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// BrandServiceImpl</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;BrandEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(key))&#123;</span><br><span class="line">        <span class="comment">// 字段等于  or  模糊查询</span></span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, key).or().like(<span class="string">&quot;name&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 按照分页信息和查询条件  进行查询</span></span><br><span class="line">    IPage&lt;BrandEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">        <span class="comment">// 传入一个IPage对象，他是接口，实现类是Page</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>&lt;BrandEntity&gt;().getPage(params),</span><br><span class="line">        wrapper</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Ipage"><a href="#Ipage" class="headerlink" title="Ipage"></a>Ipage</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Page对象指定页码和条数，其中的泛型是数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// this.page()是Iservice里的方法</span></span><br><span class="line"><span class="keyword">default</span> &lt;E <span class="keyword">extends</span> <span class="title class_">IPage</span>&lt;T&gt;&gt; E <span class="title function_">page</span><span class="params">(E page,</span></span><br><span class="line"><span class="params">                                    Wrapper&lt;T&gt; queryWrapper)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getBaseMapper().selectPage(page, queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、关联分类"><a href="#5、关联分类" class="headerlink" title="5、关联分类"></a>5、关联分类</h4><p>新增的华为、小米、oppo 都应该是手机下的品牌，但是品牌对分类可能是一对多的，比如小米对应手机和电视</p><p>多对多的关系应该有 relation 表</p><p>修改 CategoryBrandRelationController 的逻辑</p><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/SxysgcEF">https://easydoc.xyz/doc/75716633/ZUqEdvA4/SxysgcEF</a></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20210503012536.png"></p><p>根据品牌 id 查出关联所有信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;catelog/list&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">cateloglist</span><span class="params">(<span class="meta">@RequestParam</span> Long brandId)</span>&#123;</span><br><span class="line">      QueryWrapper&lt;CategoryBrandRelationEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">      queryWrapper.eq(<span class="string">&quot;brand_id&quot;</span>, brandId);</span><br><span class="line">      List&lt;CategoryBrandRelationEntity&gt; data = categoryBrandRelationService.list(queryWrapper);</span><br><span class="line">      <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>新增关联</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503012549.png"></p><h5 id="关联表的优化："><a href="#关联表的优化：" class="headerlink" title="关联表的优化："></a>关联表的优化：</h5><p>分类名本可以在 brand 表中，但因为<strong>关联查询对数据库性能有影响</strong>，在电商中大表数据从不做关联，哪怕<strong>分步查</strong>也不用关联</p><p>所以像 name 这种冗余字段可以保存，优化 save，<strong>保存时用关联表存好，但 select 时不用关联</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> CategoryBrandRelationEntity categoryBrandRelation)</span>&#123;</span><br><span class="line"><span class="comment">//		categoryBrandRelationService.save(categoryBrandRelation);</span></span><br><span class="line">        categoryBrandRelationService.saveDetail(categoryBrandRelation);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//由于从表单中只能获取分类、品牌的id，因此需要从数据库将其name字段查出，并保存至关联表</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDetail</span><span class="params">(CategoryBrandRelationEntity categoryBrandRelation)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> categoryBrandRelation.getBrandId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">catelogId</span> <span class="operator">=</span> categoryBrandRelation.getCatelogId();</span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandDao.selectById(brandId);</span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryDao.selectById(catelogId);</span><br><span class="line">        categoryBrandRelation.setBrandName(brandEntity.getName());</span><br><span class="line">        categoryBrandRelation.setCatelogName(categoryEntity.getName());</span><br><span class="line">        <span class="built_in">this</span>.save(categoryBrandRelation);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最终效果：</p><p><img src="/img/loading.gif" data-lazy-src="https://fermhan.oss-cn-qingdao.aliyuncs.com/img/20210216204033.png"></p><h5 id="保持冗余字段的数据一致"><a href="#保持冗余字段的数据一致" class="headerlink" title="保持冗余字段的数据一致"></a>保持冗余字段的数据一致</h5><p>但是如果分类表里的 name 发送变化，那么品牌表里的分类 name 字段应该同步变化。</p><p>所以应该修改 brand-controller，使之 update 时检测分类表里的 name 进行同步</p><h2 id="十一、-规格参数新增与-VO"><a href="#十一、-规格参数新增与-VO" class="headerlink" title="十一、 规格参数新增与 VO"></a>十一、 规格参数新增与 VO</h2><p>规格参数新增时，请求的 URL：Request URL:</p><p><a target="_blank" rel="noopener" href="http://localhost:88/api/product/attr/base/list/0?t=1588731762158&amp;page=1&amp;limit=10&amp;key=">http://localhost:88/api/product/attr/base/list/0?t=1588731762158&amp;page=1&amp;limit=10&amp;key=</a></p><p>当有新增字段时，我们往往会在 entity 实体类中新建一个字段，并标注数据库中不存在该字段，然而这种方式并不规范</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503162455.png" alt="1588732021702"></p><p>比较规范的做法是，新建一个 vo 文件夹，将每种不同的对象，按照它的功能进行了划分。在 java 中，涉及到了这几种类型</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503162459.png" alt="1588732152646"></p><p>Request URL: <a target="_blank" rel="noopener" href="http://localhost:88/api/product/attr/save%EF%BC%8C%E7%8E%B0%E5%9C%A8%E7%9A%84%E6%83%85%E5%86%B5%E6%98%AF%EF%BC%8C%E5%AE%83%E5%9C%A8%E4%BF%9D%E5%AD%98%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%BF%9D%E5%AD%98%E4%BA%86">http://localhost:88/api/product/attr/save，现在的情况是，它在保存的时候，只是保存了</a> attr，并没有保存 attrgroup，为了解决这个问题，我们新建了一个 vo/AttrVo，在原 AttrEntity 基础上增加了 attrGroupId 字段，使得保存新增数据的时候，也保存了它们之间的关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrVo</span> <span class="keyword">extends</span> <span class="title class_">AttrEntity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且由于查询时显示了所属分类名和所属分组名，并且在修改时要回显其三级分类，所以我们要为返回时的属性定制 vo</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503162502.png"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503162506.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrRespVo</span> <span class="keyword">extends</span> <span class="title class_">AttrVo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 			&quot;catelogName&quot;: &quot;手机/数码/手机&quot;, //所属分类名字</span></span><br><span class="line"><span class="comment">     * 			&quot;groupName&quot;: &quot;主体&quot;, //所属分组名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String catelogName;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long[] catelogPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过” BeanUtils.copyProperties(attr,attrEntity);”能够实现在两个 Bean 之间拷贝数据，但是两个 Bean 的字段要相同</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAttr</span><span class="params">(AttrVo attr)</span> &#123;</span><br><span class="line">     <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrEntity</span>();</span><br><span class="line">     BeanUtils.copyProperties(attr,attrEntity);</span><br><span class="line">     <span class="built_in">this</span>.save(attrEntity);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>问题：现在有两个查询，一个是查询部分，另外一个是查询全部，但是又必须这样来做吗？还是有必要的，但是可以在后台进行设计，两种查询是根据 catId 是否为零进行区分的。</p><h2 id="十二、规格-参数与销售属性的增删改查"><a href="#十二、规格-参数与销售属性的增删改查" class="headerlink" title="十二、规格 参数与销售属性的增删改查"></a>十二、规格 参数与销售属性的增删改查</h2><p><strong>查询</strong></p><p>可以通过在添加路径变量<code>&#123;attrType&#125;</code>同时用一个方法查询销售属性和规格参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;attrType&#125;/list/&#123;catelogId&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">infoCatelog</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathVariable(&quot;catelogId&quot;)</span> <span class="type">long</span> catelogId,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathVariable(&quot;attrType&quot;)</span> String attrType)</span> &#123;</span><br><span class="line">       <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrService.queryPage(params,catelogId,attrType);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params, <span class="type">long</span> catelogId,String attrType)</span> &#123;</span><br><span class="line">       <span class="comment">//根据attrType进行查询，1规格参数，2销售属性</span></span><br><span class="line">       QueryWrapper&lt;AttrEntity&gt; attrEntityQueryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrEntity&gt;().eq(<span class="string">&quot;attr_type&quot;</span>,<span class="string">&quot;base&quot;</span>.equalsIgnoreCase(attrType)?<span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">       <span class="comment">//如果参数带有分类id，则按分类查询</span></span><br><span class="line">       <span class="keyword">if</span> (catelogId != <span class="number">0</span>) &#123;</span><br><span class="line">           attrEntityQueryWrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">       <span class="comment">//搜索的模糊查询</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">           attrEntityQueryWrapper.and((wrapper) -&gt; wrapper.eq(<span class="string">&quot;attr_id&quot;</span>, key).or().like(<span class="string">&quot;attr_name&quot;</span>, key));</span><br><span class="line">       &#125;</span><br><span class="line">       IPage&lt;AttrEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrEntity&gt;().getPage(params),</span><br><span class="line">               attrEntityQueryWrapper</span><br><span class="line">       );</span><br><span class="line">       List&lt;AttrEntity&gt; records = page.getRecords();</span><br><span class="line">       List&lt;AttrRespVo&gt; collect = records.stream().map((entity) -&gt; &#123;</span><br><span class="line">           <span class="type">AttrRespVo</span> <span class="variable">respVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrRespVo</span>();</span><br><span class="line">           BeanUtils.copyProperties(entity, respVo);</span><br><span class="line">           <span class="comment">//查询分类并设置分类名</span></span><br><span class="line">           <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;cat_id&quot;</span>, entity.getCatelogId()));</span><br><span class="line">           respVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">           <span class="comment">//如果是查询规格参数才查询设置分组名</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="string">&quot;base&quot;</span>.equalsIgnoreCase(attrType)) &#123;</span><br><span class="line">               <span class="comment">//查询参数、分组关系</span></span><br><span class="line">               <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrAttrgroupRelationEntity</span> <span class="operator">=</span> attrAttrgroupRelationDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, entity.getAttrId()));</span><br><span class="line">               <span class="comment">//如果分组id不为空。则查出分组名</span></span><br><span class="line">               <span class="keyword">if</span> (attrAttrgroupRelationEntity != <span class="literal">null</span> &amp;&amp; attrAttrgroupRelationEntity.getAttrGroupId() != <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrGroupEntity&gt;().eq(<span class="string">&quot;attr_group_id&quot;</span>, attrAttrgroupRelationEntity.getAttrGroupId()));</span><br><span class="line">                   <span class="comment">//设置分组名</span></span><br><span class="line">                   respVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> respVo;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       <span class="type">PageUtils</span> <span class="variable">pageUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">       pageUtils.setList(collect);</span><br><span class="line">       <span class="keyword">return</span> pageUtils;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>保存</strong></p><p>使用<code>AttrVo</code>封装属性，如果<code>AttrGroupId</code>非空，则为规则参数，需要更新属性-分组表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> AttrVo attr)</span>&#123;</span><br><span class="line">	attrService.saveAttr(attr);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> R.ok();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAttr</span><span class="params">(AttrVo attr)</span> &#123;</span><br><span class="line">       <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrEntity</span>();</span><br><span class="line">       BeanUtils.copyProperties(attr,attrEntity);</span><br><span class="line">       <span class="built_in">this</span>.save(attrEntity);</span><br><span class="line">       <span class="comment">//如果分组id不为空，说明是规格参数而不是销售属性，则对属性-分组表进行更新</span></span><br><span class="line">       <span class="keyword">if</span> (attr.getAttrGroupId() != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrAttrgroupRelationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">           attrAttrgroupRelationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">           attrAttrgroupRelationEntity.setAttrId(attrEntity.getAttrId());</span><br><span class="line">           attrAttrgroupRelationDao.insert(attrAttrgroupRelationEntity);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>修改</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   	<span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AttrVo attr)</span>&#123;</span><br><span class="line"><span class="comment">//		attrService.updateById(attr);</span></span><br><span class="line">        attrService.updateAttr(attr);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateAttr</span><span class="params">(AttrVo attr)</span> &#123;</span><br><span class="line">        <span class="type">AttrEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrEntity</span>();</span><br><span class="line">        BeanUtils.copyProperties(attr,entity);</span><br><span class="line">        <span class="built_in">this</span>.baseMapper.updateById(entity);</span><br><span class="line">        <span class="comment">//只有当属性分组不为空时，说明更新的是规则参数，则需要更新关联表</span></span><br><span class="line">        <span class="keyword">if</span> (attr.getAttrGroupId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//查询属性-分组名对应关系</span></span><br><span class="line">            <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrAttrgroupRelationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">            attrAttrgroupRelationEntity.setAttrId(attr.getAttrId());</span><br><span class="line">            attrAttrgroupRelationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> attrAttrgroupRelationDao.selectCount(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrAttrgroupRelationEntity.getAttrId()));</span><br><span class="line">            <span class="comment">//在关联表中已有该属性分组数据时进行更新，否则插入新数据</span></span><br><span class="line">            <span class="keyword">if</span> (c&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                attrAttrgroupRelationDao.update(attrAttrgroupRelationEntity, <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attr.getAttrId()));</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                attrAttrgroupRelationDao.insert(attrAttrgroupRelationEntity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>修改回显时查询数据</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/info/&#123;attrId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;attrId&quot;)</span> Long attrId)</span>&#123;</span><br><span class="line">        AttrRespVo respVo=attrService.getAttrInfo(attrId);</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;attr&quot;</span>, respVo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AttrRespVo <span class="title function_">getAttrInfo</span><span class="params">(Long attrId)</span> &#123;</span><br><span class="line">        <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.baseMapper.selectById(attrId);</span><br><span class="line">        <span class="type">AttrRespVo</span> <span class="variable">respVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrRespVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(attrEntity,respVo);</span><br><span class="line">        <span class="comment">//查询并设置分组名</span></span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrAttrgroupRelationEntity</span> <span class="operator">=</span> attrAttrgroupRelationDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrEntity.getAttrId()));</span><br><span class="line">        <span class="comment">//如果分组id不为空。则查出分组名</span></span><br><span class="line">        <span class="keyword">if</span> (attrAttrgroupRelationEntity != <span class="literal">null</span> &amp;&amp; attrAttrgroupRelationEntity.getAttrGroupId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrGroupEntity&gt;().eq(<span class="string">&quot;attr_group_id&quot;</span>, attrAttrgroupRelationEntity.getAttrGroupId()));</span><br><span class="line">            <span class="comment">//设置分组名</span></span><br><span class="line">            respVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">            respVo.setAttrGroupId(attrGroupEntity.getAttrGroupId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询到分类信息</span></span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;cat_id&quot;</span>, attrEntity.getCatelogId()));</span><br><span class="line">        <span class="comment">//设置分类名</span></span><br><span class="line">        respVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">        <span class="comment">//查询并设置分类路径</span></span><br><span class="line">        Long[] catelogPathById = categoryService.findCatelogPathById(categoryEntity.getCatId());</span><br><span class="line">        respVo.setCatelogPath(catelogPathById);</span><br><span class="line">        <span class="keyword">return</span> respVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="细节优化"><a href="#细节优化" class="headerlink" title="细节优化"></a>细节优化</h3><p>​ 在品牌管理中修改了品牌名，同时也让关联的表也同时发生修改</p><ul><li><strong>BrandController.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@Validated(UpdateGroup.class)</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line"><span class="comment">//		brandService.updateById(brand);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 优化当主表中的名称发生改变，其他关联表也发生改变</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        brandService.updateDetail(brand);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><strong>BrandServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDetail</span><span class="params">(BrandEntity brand)</span> &#123;</span><br><span class="line">    <span class="comment">// 保证冗余字段的数据一致</span></span><br><span class="line">    <span class="built_in">this</span>.updateById(brand);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(brand.getName()))&#123;</span><br><span class="line">        <span class="comment">// 同步更新其他关联表中的数据</span></span><br><span class="line">        CategoryBrandRelationService.updateBrand(brand.getBrandId(),brand.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 更新其他关联</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>CategoryBrandRelationServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateBrand</span><span class="params">(Long brandId, String name)</span> &#123;</span><br><span class="line">    <span class="type">CategoryBrandRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CategoryBrandRelationEntity</span>();</span><br><span class="line">    relationEntity.setBrandId(brandId);</span><br><span class="line">    relationEntity.setBrandName(name);</span><br><span class="line">    <span class="built_in">this</span>.update(relationEntity,<span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;CategoryBrandRelationEntity&gt;().eq(<span class="string">&quot;brand_id&quot;</span>,brandId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>效果展示</code></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503163433.png" alt="image-20210503163432241"></p><ul><li>关联表也发生改变</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503163500.png" alt="image-20210503163459401"></p><h2 id="十三、-查询分组关联属性和删除关联"><a href="#十三、-查询分组关联属性和删除关联" class="headerlink" title="十三、 查询分组关联属性和删除关联"></a>十三、 查询分组关联属性和删除关联</h2><h4 id="1、获取属性分组的关联的所有属性"><a href="#1、获取属性分组的关联的所有属性" class="headerlink" title="1、获取属性分组的关联的所有属性"></a>1、获取属性分组的关联的所有属性</h4><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/LnjzZHPj">https://easydoc.xyz/doc/75716633/ZUqEdvA4/LnjzZHPj</a></p><p>发送请求：/product/attrgroup/{attrgroupId}/attr/relation</p><ul><li><strong>AttrGroupController.java 和 AttrServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/attr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">attrRelation</span><span class="params">(<span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span> Long attrgroupId)</span> &#123;</span><br><span class="line">    List&lt;AttrEntity&gt; entities = attrService.getRelationAttr(attrgroupId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,entities);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// AttrServiceImpl.java</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AttrEntity&gt; <span class="title function_">getRelationAttr</span><span class="params">(Long attrgroupId)</span> &#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; entities = relationDao.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_group_id&quot;</span>, attrgroupId));</span><br><span class="line"></span><br><span class="line">    List&lt;Long&gt; attrIds = entities.stream().map((attr) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(attrIds == <span class="literal">null</span> || attrIds.size() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Collection&lt;AttrEntity&gt; attrEntities = <span class="built_in">this</span>.listByIds(attrIds);</span><br><span class="line">    <span class="keyword">return</span> (List&lt;AttrEntity&gt;) attrEntities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503224000.png" alt="image-20210503223937629"></p><p>如何查找：既然给出了 attr_group_id，那么到中间表中查询出来所关联的 attr_id，然后得到最终的所有属性即可。</p><p>可能出现 null 值的问题</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210503224152.png" alt="image-20210503224150861"></p><h4 id="2、移除属性分组的关联的属性"><a href="#2、移除属性分组的关联的属性" class="headerlink" title="2、移除属性分组的关联的属性"></a>2、移除属性分组的关联的属性</h4><ul><li>创建 AttrGroupRelationVo 对象</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrGroupRelationVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;attrId&quot;:1,&quot;attrGroupId&quot;:2</span></span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>AttrGroupController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除属性与分组的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@url</span> /product/attrgroup/attr/relation/delete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vos</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation/delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">deleteRelation</span><span class="params">(<span class="meta">@RequestBody</span> AttrGroupRelationVo[] vos)</span>&#123;</span><br><span class="line">    attrService.deleteRelation(vos);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteRelation</span><span class="params">(AttrGroupRelationVo[] vos)</span> &#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; entities = Arrays.asList(vos).stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">        BeanUtils.copyProperties(item, relationEntity);</span><br><span class="line">        <span class="keyword">return</span> relationEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    relationDao.deleteBatchRelation(entities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrAttrgroupRelationDao.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AttrAttrgroupRelationDao</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;AttrAttrgroupRelationEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">deleteBatchRelation</span><span class="params">(<span class="meta">@Param(&quot;entities&quot;)</span> List&lt;AttrAttrgroupRelationEntity&gt; entities)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrAttrgroupRelationDao.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteBatchRelation&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    DELETE FROM `pms_attr_attrgroup_relation` WHERE</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;entities&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">separator</span>=<span class="string">&quot; OR &quot;</span>&gt;</span></span><br><span class="line">        (attr_id=#&#123;item.attrId&#125; AND attr_group_id=#&#123;item.attrGroupId&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="十四、-查询分组未关联的属性"><a href="#十四、-查询分组未关联的属性" class="headerlink" title="十四、 查询分组未关联的属性"></a>十四、 查询分组未关联的属性</h2><p>/product/attrgroup/{attrgroupId}/noattr/relation</p><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/d3EezLdO">https://easydoc.xyz/doc/75716633/ZUqEdvA4/d3EezLdO</a></p><p>获取属性分组里面还没有关联的本分类里面的其他基本属性，方便添加新的关联</p><p>Request URL: <a target="_blank" rel="noopener" href="http://localhost:88/api/product/attrgroup/1/noattr/relation?t=1588780783441&amp;page=1&amp;limit=10&amp;key=">http://localhost:88/api/product/attrgroup/1/noattr/relation?t=1588780783441&amp;page=1&amp;limit=10&amp;key=</a></p><p><img src="/img/loading.gif" data-lazy-src="images/1588780868214.png" alt="1588780868214"></p><p>属性分组，对应于“pms_attr_group”表，每个分组下，需要查看到关联了哪些属性信息，销售属性不需要和分组进行关联，但是规格参数要和属性分组进行关联。</p><p>规格参数：对应于<code>pms_attr</code>表，attr_type=1，需要显示分组信息</p><p>销售属性：对应于 pms_attr`表，attr_type=0，不需要显示分组信息</p><p>分组 ID 为 9 的分组：Request URL: <a target="_blank" rel="noopener" href="http://localhost:88/api/product/attrgroup/9/noattr/relation?t=1588822258669&amp;page=1&amp;limit=10&amp;key=">http://localhost:88/api/product/attrgroup/9/noattr/relation?t=1588822258669&amp;page=1&amp;limit=10&amp;key=</a></p><p>对应的数据库字段</p><p>attr_group_id attr_group_name sort descript icon catelog_id</p><hr><pre><code>        9  主体                    1  型号 平台                   wu               454
       10  显卡                    1  显存容量                    wu               454
       11  输入设备                  1  鼠标 键盘                   wu               454
       12  主板                    1  显卡类型 芯片组                wu               454
       13  规格                    1  尺寸                      wu               454
</code></pre><p>查询 attrgroupId=9 的属性分组：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrgroupId);</span><br></pre></td></tr></table></figure><p>获取到分类信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long catelogId = attrGroupEntity.getCatelogId();</span><br></pre></td></tr></table></figure><p>目标：获取属性分组没有关联的其他属性</p><p>也就是获取 attrgroupId=9 的属性分组中，关联的分类 catelog_id =454 （台式机），其他基本属性</p><p>在该属性分组中，现在已经关联的属性：</p><p><img src="/img/loading.gif" data-lazy-src="images/1588822997675.png" alt="1588822997675"></p><p>本分类下，存在哪些基本属性？</p><p>没有关联的其他属性</p><p>已经关联的属性，这些属性是如何关联上的？</p><p>答：在创建规格参数的时候，已经设置了需要关联哪些属性分组。</p><p>想要知道还没有关联哪些，先查看关联了哪些，如何排除掉这些就是未关联的</p><p>在中间表中显示了属性和属性分组之间的关联关系，在属性表中显示了所有的属性，</p><p>先查询中间表，得到所有已经关联的属性的 id，然后再次查询属性表，排除掉已经建立关联的属性 ID，将剩下的属性 ID 和属性建立起关联关系</p><ul><li>AttrGroupController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/noattr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">attrNoRelation</span><span class="params">(<span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span>Long attrgroupId,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam</span> Map&lt;String,Object&gt; params)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrService.getNoRelationAttr(params,attrgroupId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>,page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">getNoRelationAttr</span><span class="params">(Map&lt;String, Object&gt; params, Long attrgroupId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 当前分组只能关联自己所属的分类的所有属性</span></span><br><span class="line">    <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrgroupId);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">catelogId</span> <span class="operator">=</span> attrGroupEntity.getCatelogId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、当前分组只能关联别的分组没有引用的属性</span></span><br><span class="line">    <span class="comment">// 2.1 当前分类下的其他分组</span></span><br><span class="line">    List&lt;AttrGroupEntity&gt; group = attrGroupDao.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrGroupEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId));</span><br><span class="line">    List&lt;Long&gt; collect = group.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrGroupId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.2 这些分组关联的属性</span></span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; groupId = relationDao.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().in(<span class="string">&quot;attr_group_id&quot;</span>, collect));</span><br><span class="line">    List&lt;Long&gt; attrIds = groupId.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3 从当前分类中所有属性中移除这些属性</span></span><br><span class="line">    QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId).eq(<span class="string">&quot;attr_type&quot;</span>, ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode());</span><br><span class="line">    <span class="keyword">if</span>(attrIds != <span class="literal">null</span> &amp;&amp; attrIds.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        wrapper.notIn(<span class="string">&quot;attr_id&quot;</span>,attrIds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(key))&#123;</span><br><span class="line">        wrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;attr_id&quot;</span>,key).or().like(<span class="string">&quot;attr_name&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;AttrEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrEntity&gt;().getPage(params), wrapper);</span><br><span class="line"></span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">pageUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pageUtils;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>效果展示</code></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210504003521.png" alt="image-20210504003519872"></p><h2 id="十五、添加属性和分组的关联关系"><a href="#十五、添加属性和分组的关联关系" class="headerlink" title="十五、添加属性和分组的关联关系"></a>十五、添加属性和分组的关联关系</h2><p>请求类型：Request URL: <a target="_blank" rel="noopener" href="http://localhost:88/api/product/attrgroup/attr/relation">http://localhost:88/api/product/attrgroup/attr/relation</a></p><p>请求方式：POST</p><p>请求数据：[{“attrId”:10,”attrGroupId”:9}]</p><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/VhgnaedC">https://easydoc.xyz/doc/75716633/ZUqEdvA4/VhgnaedC</a></p><p>响应数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>本质就是在中间表 pms_attr_attrgroup_relation 中，添加一条记录的过程</p><ul><li>AttrGroupController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">addRelation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;AttrGroupRelationVo&gt; vos)</span>&#123;</span><br><span class="line"></span><br><span class="line">    relationService.saveBathch(vos);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrAttrgroupRelationServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveBathch</span><span class="params">(List&lt;AttrGroupRelationVo&gt; vos)</span> &#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; collect = vos.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">        BeanUtils.copyProperties(item, relationEntity);</span><br><span class="line">        <span class="keyword">return</span> relationEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.saveBatch(collect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="十六、发布商品"><a href="#十六、发布商品" class="headerlink" title="十六、发布商品"></a>十六、发布商品</h2><h4 id="1、获取所有会员等级"><a href="#1、获取所有会员等级" class="headerlink" title="1、获取所有会员等级"></a>1、获取所有会员等级</h4><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/jCFganpf">https://easydoc.xyz/doc/75716633/ZUqEdvA4/jCFganpf</a></p><p>在“gulimall-gateway”中修改“”文件，添加对于 member 的路由</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">gulimall-member</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-member</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/member/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><p>在“gulimall-member”中，创建“bootstrap.properties”文件，内容如下：</p><p><code>2.2.X</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.nacos.config.name</span>=<span class="string">gulimall-member</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">192.168.137.14:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">1198d1a7-e6e9-4176-bbbe-c8c5a30533e5</span></span><br><span class="line"><span class="comment"># 应用服务 WEB 访问端口</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8000</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].data-id</span>=<span class="string">gulimall-member.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.extension-configs[0].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p><code>2.1.x</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">gulimall-member</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">1198d1a7-e6e9-4176-bbbe-c8c5a30533e5</span></span><br><span class="line"><span class="comment"># 应用服务 WEB 访问端口</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8000</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].data-id</span>=<span class="string">gulimall-member.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><h4 id="2、获取分类关联的品牌"><a href="#2、获取分类关联的品牌" class="headerlink" title="2、获取分类关联的品牌"></a>2、获取分类关联的品牌</h4><p>API：<a target="_blank" rel="noopener" href="https://easydoc.xyz/doc/75716633/ZUqEdvA4/HgVjlzWV">https://easydoc.xyz/doc/75716633/ZUqEdvA4/HgVjlzWV</a></p><ul><li>BrandVo.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrandVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &quot;brandId&quot;: 0,</span></span><br><span class="line"><span class="comment">     * &quot;brandName&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> String  brandName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CategoryBrandRelationController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/brands/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">relationBrandsList</span><span class="params">(<span class="meta">@RequestParam(value = &quot;catId&quot;,required = true)</span> Long catId)</span>&#123;</span><br><span class="line">    List&lt;BrandEntity&gt; vos = categoryBrandRelationService.getBrandByCatId(catId);</span><br><span class="line"></span><br><span class="line">    List&lt;BrandVo&gt; collect = vos.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">BrandVo</span> <span class="variable">brandVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrandVo</span>();</span><br><span class="line">        brandVo.setBrandId(item.getBrandId());</span><br><span class="line">        brandVo.setBrandName(item.getName());</span><br><span class="line">        <span class="keyword">return</span> brandVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,collect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>CategoryBrandRelationServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">CategoryBrandRelationDao relationDao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">BrandService brandService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BrandEntity&gt; <span class="title function_">getBrandByCatId</span><span class="params">(Long catId)</span> &#123;</span><br><span class="line">    List&lt;CategoryBrandRelationEntity&gt; catelogId = relationDao.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryBrandRelationEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catId));</span><br><span class="line">    List&lt;BrandEntity&gt; collect = catelogId.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> item.getBrandId();</span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">byId</span> <span class="operator">=</span> brandService.getById(brandId);</span><br><span class="line">        <span class="keyword">return</span> byId;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>遇到 PubSub 问题</strong></p><p>分类变化后请求没有被监听无法发送查询品牌信息的请求</p><ol><li>首先安装 pubsub-js</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`npm install --save pubsub-js`</span><br></pre></td></tr></table></figure><ol start="2"><li><p>订阅方组件</p><p>在 src 下的 main.js 中引用：</p></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">PubSub</span> <span class="keyword">from</span> <span class="string">&quot;pubsub-js&quot;</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">PubSub</span> = <span class="title class_">PubSub</span>;</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210504122831.png"></p><h4 id="3、获取分类下所有分组-amp-关联属性"><a href="#3、获取分类下所有分组-amp-关联属性" class="headerlink" title="3、获取分类下所有分组&amp;关联属性"></a>3、获取分类下所有分组&amp;关联属性</h4><p>请求类型：/product/attrgroup/{catelogId}/withattr</p><p>请求方式：GET</p><p>请求 URL：<a target="_blank" rel="noopener" href="http://localhost:88/api/product/attrgroup/225/withattr?t=1588864569478">http://localhost:88/api/product/attrgroup/225/withattr?t=1588864569478</a></p><ul><li>AttrGroupWithAttrsVo.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrGroupWithAttrsVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分组id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 组名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String attrGroupName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String descript;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 组图标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所属分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long catelogId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrEntity&gt; attrs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrGroupController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;catelogId&#125;/withattr&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">getAttrGroupWithAttrs</span><span class="params">(<span class="meta">@PathVariable(&quot;catelogId&quot;)</span>Long catelogId)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、 查出当前分类下的所有属性分组</span></span><br><span class="line">    <span class="comment">// 2、 查出每个属性分组的所有属性</span></span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; vos = attrGroupService.getAttrGroupWithAttrByCatelogId(catelogId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,vos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AttrGroupServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AttrGroupWithAttrsVo&gt; <span class="title function_">getAttrGroupWithAttrByCatelogId</span><span class="params">(Long catelogId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查询分组信息</span></span><br><span class="line">    List&lt;AttrGroupEntity&gt; attrGroupEntityList = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrGroupEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 查询所有的属性</span></span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; collect = attrGroupEntityList.stream().map(group -&gt; &#123;</span><br><span class="line">        <span class="type">AttrGroupWithAttrsVo</span> <span class="variable">attrsVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrGroupWithAttrsVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(group, attrsVo);</span><br><span class="line">        List&lt;AttrEntity&gt; attrs = attrService.getRelationAttr(attrsVo.getAttrGroupId());</span><br><span class="line">        attrsVo.setAttrs(attrs);</span><br><span class="line">        <span class="keyword">return</span> attrsVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mysql 默认的隔离级别为读已提交，为了能够在调试过程中，获取到数据库中的数据信息，可以调整隔离级别为读未提交：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br></pre></td></tr></table></figure><p>但是它对于当前的事务窗口生效，如果想要设置全局的，需要加上 global 字段。</p><h4 id="4、保存-SPU-的基本信息"><a href="#4、保存-SPU-的基本信息" class="headerlink" title="4、保存 SPU 的基本信息"></a>4、保存 SPU 的基本信息</h4><p><strong>先创建以下 VO 对象</strong></p><p>在保存 SPU 界面，使用 F12 调出控制台获取页面存储的 json 数据，把数据复制出来使用 json 工具把它装换成 java 实体类（VO）</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210504134819.png" alt="image-20210504134818543"></p><p>JSON 工具 ：<a target="_blank" rel="noopener" href="https://www.bejson.com/">https://www.bejson.com/</a> ，转换好了以后 <strong>生成 javabean</strong> 在点击<strong>下载代码</strong>即可。</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210504135203.png" alt="image-20210504135201975"></p><p><code>生成bean</code></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210504135720.png" alt="image-20210504135719702"></p><p><strong>修改：</strong></p><ul><li>double 改为 BigDecimal</li><li>int 改为 Long</li><li>去掉 get、set 方法 使用 @Data 注解</li></ul><blockquote><p><strong>Sup 功能实现</strong></p></blockquote><ul><li>SpuInfoController.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 保存</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;product:spuinfo:save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SpuSaveVo vo)</span>&#123;</span><br><span class="line">    <span class="comment">//spuInfoService.save(spuInfo);</span></span><br><span class="line">    spuInfoService.saveSpuInfo(vo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SpuInfoServiceImpl.java ( 注意 saveSpuInfo 中 所有需要调用其他模块的实现类，我已经按顺序写出来 )</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SpuInfoDescService spuInfoDescService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SpuImagesService imagesService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">AttrService attrService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">CouponFeignService couponFeignService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">SkuImagesService skuImagesService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">SkuInfoService skuInfoService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">ProductAttrValueService attrValueService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">SkuSaleAttrValueService skuSaleAttrValueService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveSpuInfo</span><span class="params">(SpuSaveVo vo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、保存spu基本信息 pms_spu_info</span></span><br><span class="line">    <span class="type">SpuInfoEntity</span> <span class="variable">infoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuInfoEntity</span>();</span><br><span class="line">    BeanUtils.copyProperties(vo,infoEntity);</span><br><span class="line">    infoEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    infoEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="built_in">this</span>.saveBaseSpuInfo(infoEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、保存Spu的描述图片 pms_spu_info_desc</span></span><br><span class="line">    List&lt;String&gt; decript = vo.getDecript();</span><br><span class="line">    <span class="type">SpuInfoDescEntity</span> <span class="variable">descEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuInfoDescEntity</span>();</span><br><span class="line">    descEntity.setSpuId(infoEntity.getId());</span><br><span class="line">    descEntity.setDecript(String.join(<span class="string">&quot;,&quot;</span>,decript));</span><br><span class="line">    spuInfoDescService.saveSpuInfoDesc(descEntity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、保存spu的图片集 pms_spu_images</span></span><br><span class="line">    List&lt;String&gt; images = vo.getImages();</span><br><span class="line">    imagesService.saveImages(infoEntity.getId(),images);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、保存spu的规格参数;pms_product_attr_value</span></span><br><span class="line">    List&lt;BaseAttrs&gt; baseAttrs = vo.getBaseAttrs();</span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; collect = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">        <span class="type">ProductAttrValueEntity</span> <span class="variable">valueEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductAttrValueEntity</span>();</span><br><span class="line">        valueEntity.setAttrId(attr.getAttrId());</span><br><span class="line">        <span class="type">AttrEntity</span> <span class="variable">id</span> <span class="operator">=</span> attrService.getById(attr.getAttrId());</span><br><span class="line">        valueEntity.setAttrName(id.getAttrName());</span><br><span class="line">        valueEntity.setAttrValue(attr.getAttrValues());</span><br><span class="line">        valueEntity.setQuickShow(attr.getShowDesc());</span><br><span class="line">        valueEntity.setSpuId(infoEntity.getId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> valueEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    attrValueService.saveProductAttr(collect);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、保存spu的积分信息；gulimall_sms-&gt;sms_spu_bounds</span></span><br><span class="line">    <span class="type">Bounds</span> <span class="variable">bounds</span> <span class="operator">=</span> vo.getBounds();</span><br><span class="line">    <span class="type">SpuBoundTo</span> <span class="variable">spuBoundTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuBoundTo</span>();</span><br><span class="line">    BeanUtils.copyProperties(bounds,spuBoundTo);</span><br><span class="line">    spuBoundTo.setSpuId(infoEntity.getId());</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> couponFeignService.saveSpuBounds(spuBoundTo);</span><br><span class="line">    <span class="keyword">if</span>(r.getCode() != <span class="number">0</span>)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;远程保存spu积分信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、保存当前spu对应的所有sku信息；</span></span><br><span class="line"></span><br><span class="line">    List&lt;Skus&gt; skus = vo.getSkus();</span><br><span class="line">    <span class="keyword">if</span>(skus!=<span class="literal">null</span> &amp;&amp; skus.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        skus.forEach(item-&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">defaultImg</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (Images image : item.getImages()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(image.getDefaultImg() == <span class="number">1</span>)&#123;</span><br><span class="line">                    defaultImg = image.getImgUrl();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//    private String skuName;</span></span><br><span class="line">            <span class="comment">//    private BigDecimal price;</span></span><br><span class="line">            <span class="comment">//    private String skuTitle;</span></span><br><span class="line">            <span class="comment">//    private String skuSubtitle;</span></span><br><span class="line">            <span class="type">SkuInfoEntity</span> <span class="variable">skuInfoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuInfoEntity</span>();</span><br><span class="line">            BeanUtils.copyProperties(item,skuInfoEntity);</span><br><span class="line">            skuInfoEntity.setBrandId(infoEntity.getBrandId());</span><br><span class="line">            skuInfoEntity.setCatalogId(infoEntity.getCatalogId());</span><br><span class="line">            skuInfoEntity.setSaleCount(<span class="number">0L</span>);</span><br><span class="line">            skuInfoEntity.setSpuId(infoEntity.getId());</span><br><span class="line">            skuInfoEntity.setSkuDefaultImg(defaultImg);</span><br><span class="line">            <span class="comment">//5.1）、sku的基本信息；pms_sku_info</span></span><br><span class="line">            skuInfoService.saveSkuInfo(skuInfoEntity);</span><br><span class="line"></span><br><span class="line">            <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> skuInfoEntity.getSkuId();</span><br><span class="line"></span><br><span class="line">            List&lt;SkuImagesEntity&gt; imagesEntities = item.getImages().stream().map(img -&gt; &#123;</span><br><span class="line">                <span class="type">SkuImagesEntity</span> <span class="variable">skuImagesEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuImagesEntity</span>();</span><br><span class="line">                skuImagesEntity.setSkuId(skuId);</span><br><span class="line">                skuImagesEntity.setImgUrl(img.getImgUrl());</span><br><span class="line">                skuImagesEntity.setDefaultImg(img.getDefaultImg());</span><br><span class="line">                <span class="keyword">return</span> skuImagesEntity;</span><br><span class="line">            &#125;).filter(entity-&gt;&#123;</span><br><span class="line">                <span class="comment">//返回true就是需要，false就是剔除</span></span><br><span class="line">                <span class="keyword">return</span> !StringUtils.isEmpty(entity.getImgUrl());</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="comment">//5.2）、sku的图片信息；pms_sku_image</span></span><br><span class="line">            skuImagesService.saveBatch(imagesEntities);</span><br><span class="line">            <span class="comment">//TODO 没有图片路径的无需保存</span></span><br><span class="line"></span><br><span class="line">            List&lt;Attr&gt; attr = item.getAttr();</span><br><span class="line">            List&lt;SkuSaleAttrValueEntity&gt; skuSaleAttrValueEntities = attr.stream().map(a -&gt; &#123;</span><br><span class="line">                <span class="type">SkuSaleAttrValueEntity</span> <span class="variable">attrValueEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuSaleAttrValueEntity</span>();</span><br><span class="line">                BeanUtils.copyProperties(a, attrValueEntity);</span><br><span class="line">                attrValueEntity.setSkuId(skuId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> attrValueEntity;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="comment">//5.3）、sku的销售属性信息：pms_sku_sale_attr_value</span></span><br><span class="line">            skuSaleAttrValueService.saveBatch(skuSaleAttrValueEntities);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// //5.4）、sku的优惠、满减等信息；gulimall_sms-&gt;sms_sku_ladder\sms_sku_full_reduction\sms_member_price</span></span><br><span class="line">            <span class="type">SkuReductionTo</span> <span class="variable">skuReductionTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuReductionTo</span>();</span><br><span class="line">            BeanUtils.copyProperties(item,skuReductionTo);</span><br><span class="line">            skuReductionTo.setSkuId(skuId);</span><br><span class="line">            <span class="keyword">if</span>(skuReductionTo.getFullCount() &gt;<span class="number">0</span> || skuReductionTo.getFullPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">r1</span> <span class="operator">=</span> couponFeignService.saveSkuReduction(skuReductionTo);</span><br><span class="line">                <span class="keyword">if</span>(r1.getCode() != <span class="number">0</span>)&#123;</span><br><span class="line">                    log.error(<span class="string">&quot;远程保存sku优惠信息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveBaseSpuInfo</span><span class="params">(SpuInfoEntity infoEntity)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.insert(infoEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SpuInfoDescServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveSpuInfoDesc</span><span class="params">(SpuInfoDescEntity descEntity)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.insert(descEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SpuImagesServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveImages</span><span class="params">(Long id, List&lt;String&gt; images)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(images == <span class="literal">null</span> || images.size() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        List&lt;SpuImagesEntity&gt; collect = images.stream().map(img -&gt; &#123;</span><br><span class="line">            <span class="type">SpuImagesEntity</span> <span class="variable">spuImagesEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuImagesEntity</span>();</span><br><span class="line">            spuImagesEntity.setSpuId(id);</span><br><span class="line">            spuImagesEntity.setImgUrl(img);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> spuImagesEntity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.saveBatch(collect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 common 模块中创建 To 对象</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpuBoundTo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal buyBounds;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal growBounds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberPrice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuReductionTo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> fullCount;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal discount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> countStatus;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal fullPrice;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal reducePrice;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> priceStatus;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MemberPrice&gt; memberPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SkuInfoServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveSkuInfo</span><span class="params">(SkuInfoEntity skuInfoEntity)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.insert(skuInfoEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>创建 feign 接口远程调用 <strong>gulimall-coupon</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;gulimall-coupon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CouponFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/coupon/spubounds/save&quot;)</span></span><br><span class="line">    R <span class="title function_">saveSpuBounds</span><span class="params">(<span class="meta">@RequestBody</span> SpuBoundTo spuBoundTo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/coupon/skufullreduction/saveinfo&quot;)</span></span><br><span class="line">    R <span class="title function_">saveSkuReduction</span><span class="params">(<span class="meta">@RequestBody</span> SkuReductionTo skuReductionTo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>gulimall-coupon 模块方法实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpuBoundsController.java</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;coupon:spubounds:save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SpuBoundsEntity spuBounds)</span>&#123;</span><br><span class="line">    spuBoundsService.save(spuBounds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SkuFullReductionController.java</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/saveinfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">saveInfo</span><span class="params">(<span class="meta">@RequestBody</span> SkuReductionTo reductionTo)</span>&#123;</span><br><span class="line">    skuFullReductionService.saveSkuReduction(reductionTo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SkuFullReductionServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveSkuReduction</span><span class="params">(SkuReductionTo reductionTo)</span> &#123;</span><br><span class="line">    <span class="comment">//1、// //5.4）、gulimall_sms-&gt;sms_sku_ladder\sms_sku_full_reduction\sms_member_price</span></span><br><span class="line">    <span class="comment">//sms_sku_laddersku的优惠、满减等信息；</span></span><br><span class="line"></span><br><span class="line">    <span class="type">SkuLadderEntity</span> <span class="variable">skuLadderEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLadderEntity</span>();</span><br><span class="line">    skuLadderEntity.setSkuId(reductionTo.getSkuId());</span><br><span class="line">    skuLadderEntity.setFullCount(reductionTo.getFullCount());</span><br><span class="line">    skuLadderEntity.setDiscount(reductionTo.getDiscount());</span><br><span class="line">    skuLadderEntity.setAddOther(reductionTo.getCountStatus());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(reductionTo.getCountStatus() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        skuLadderService.save(skuLadderEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、sms_sku_full_reduction</span></span><br><span class="line">    <span class="type">SkuFullReductionEntity</span> <span class="variable">reductionEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuFullReductionEntity</span>();</span><br><span class="line">    BeanUtils.copyProperties(reductionTo,reductionEntity);</span><br><span class="line">    <span class="keyword">if</span>(reductionEntity.getFullPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.save(reductionEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、sms_member_price</span></span><br><span class="line">    List&lt;MemberPrice&gt; memberPrice = reductionTo.getMemberPrice();</span><br><span class="line"></span><br><span class="line">    List&lt;MemberPriceEntity&gt; collect = memberPrice.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">MemberPriceEntity</span> <span class="variable">priceEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberPriceEntity</span>();</span><br><span class="line">        priceEntity.setSkuId(reductionEntity.getSkuId());</span><br><span class="line">        priceEntity.setMemberLevelId(item.getId());</span><br><span class="line">        priceEntity.setMemberLevelName(item.getName());</span><br><span class="line">        priceEntity.setMemberPrice(item.getPrice());</span><br><span class="line">        priceEntity.setAddOther(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> priceEntity;</span><br><span class="line">    &#125;).filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getMemberPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    memberPriceService.saveBatch(collect);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-1、新增商品-BUG-汇总"><a href="#4-1、新增商品-BUG-汇总" class="headerlink" title="4.1、新增商品 BUG 汇总"></a>4.1、新增商品 BUG 汇总</h5><ol><li>修改 mysql 默认隔离级别，测试接口</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 将当前会话隔离级别等级设置成读未提交，可以读到未提交的数据</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br></pre></td></tr></table></figure><ol start="2"><li>插入的时候省略了 id 列，mybatis 将其当做自增列</li></ol><p><strong>SpuInfoDescEntity.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId(type = IdType.INPUT)</span></span><br><span class="line"><span class="keyword">private</span> Long spuId;</span><br></pre></td></tr></table></figure><ol start="3"><li>过滤掉 sku 默认未选中图片</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SkuImagesEntity&gt; skuImagesEntities = item.getImages().stream().map(image -&gt; &#123;</span><br><span class="line">    <span class="type">SkuImagesEntity</span> <span class="variable">skuImagesEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuImagesEntity</span>();</span><br><span class="line">    skuImagesEntity.setSkuId(skuId);</span><br><span class="line">    skuImagesEntity.setImgUrl(image.getImgUrl());</span><br><span class="line">    skuImagesEntity.setDefaultImg(image.getDefaultImg());</span><br><span class="line">    <span class="keyword">return</span> skuImagesEntity;</span><br><span class="line">&#125;).filter(entity-&gt;&#123;</span><br><span class="line">    <span class="comment">// 返回false就会剔除</span></span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(entity.getImgUrl());</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><ol start="4"><li>优惠无意义数据<br>1）满 0 件打 0 折【每个 sku 对应一条，笛卡尔积条 sku】<br>2）满 0 元减 0 元【每个 sku 对应一条，笛卡尔积条 sku】<br>3）会员价格为 0 的数据</li></ol><h4 id="5、spu-管理"><a href="#5、spu-管理" class="headerlink" title="5、spu 管理"></a>5、spu 管理</h4><h5 id="5-1、SPU-检索-时间格式化"><a href="#5-1、SPU-检索-时间格式化" class="headerlink" title="5.1、SPU 检索 时间格式化"></a>5.1、SPU 检索 时间格式化</h5><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210505142930.png" alt="image-20210505142811072"></p><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/9LISLvy7">https://easydoc.xyz/s/78237135/ZUqEdvA4/9LISLvy7</a></p><p><strong>时间格式化：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br><span class="line">    <span class="attr">time-zone:</span> <span class="string">GMT+8</span></span><br></pre></td></tr></table></figure><p><strong>SPU 检索</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SpuInfoController.java</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;product:spuinfo:list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span>&#123;</span><br><span class="line">    <span class="comment">//        PageUtils page = spuInfoService.queryPage(params);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> spuInfoService.queryPageCondition(params);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SpuInfoServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPageCondition</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;SpuInfoEntity&gt; wrapper= <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(key))&#123;</span><br><span class="line">        wrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;id&quot;</span>,key).or().like(<span class="string">&quot;spu_name&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// status=1 and (id=1 or spu_name like xxx)</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(status))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;publish_status&quot;</span>,status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">brandId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(brandId)&amp;&amp;!<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(brandId))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>,brandId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">catelogId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;catelogId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(catelogId)&amp;&amp;!<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(catelogId))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catalog_id&quot;</span>,catelogId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * status: 2</span></span><br><span class="line"><span class="comment">         * key:</span></span><br><span class="line"><span class="comment">         * brandId: 9</span></span><br><span class="line"><span class="comment">         * catelogId: 225</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">    IPage&lt;SpuInfoEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>&lt;SpuInfoEntity&gt;().getPage(params),</span><br><span class="line">        wrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-2-、获取-spu-规格"><a href="#5-2-、获取-spu-规格" class="headerlink" title="5.2 、获取 spu 规格"></a>5.2 、获取 spu 规格</h5><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/GhhJhkg7">https://easydoc.xyz/s/78237135/ZUqEdvA4/GhhJhkg7</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AttrController.java</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">ProductAttrValueService productAttrValueService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/base/listforspu/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">baseAttrlistforsup</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; entities = productAttrValueService.baseAttrlistforspu(spuId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,entities);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductAttrValueServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ProductAttrValueEntity&gt; <span class="title function_">baseAttrlistforspu</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; entities = <span class="built_in">this</span>.baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;ProductAttrValueEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>, spuId));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试</strong>：GET localhost:88/api/product/attr/base/listforspu/7</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210505150029.png" alt="image-20210505150028738"></p><p>问题现象：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507223928.png" alt="image-20200510182051355"></p><p>出现问题的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">attrUpdateShow</span>(<span class="params">row</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(row);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/product-attrupdate&quot;</span>,</span><br><span class="line">    <span class="attr">query</span>: &#123; <span class="attr">spuId</span>: row.<span class="property">id</span>, <span class="attr">catalogId</span>: row.<span class="property">catalogId</span> &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>暂时不知道如何解决问题。只能留待以后解决。经过测试发现，问题和上面的代码没有关系，问题出现在“attrupdate.vue”上，该 vue 页面无法通过浏览器访问，当输入访问 URL（ <a target="_blank" rel="noopener" href="http://localhost:8001/#/product-attrupdate">http://localhost:8001/#/product-attrupdate</a> ）的时候，就会出现 404，而其他的请求则不会出现这种情况，不知为何。</p><p>通过 POSTMAN 进行请求的时候，能够请求到数据。</p><p>经过分析发现，是因为在数据库中没有该页面的导航所导致的，为了修正这个问题，可以在“sys-menu”表中添加一行，内容位：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507223934.png" alt="image-20200510231012714"></p><p>这样当再次访问的时候，在“平台属性”下，会出现“规格维护”菜单，</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507223937.png" alt="image-20200510231041708"></p><p>当再次点击“规格”的时候，显示出菜单</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507223940.png" alt="image-20200510231200130"></p><p>不过这种菜单并不符合我们的需要，我们需要让它以弹出框的形式出现。</p><h5 id="5-3、修改商品价格"><a href="#5-3、修改商品价格" class="headerlink" title="5.3、修改商品价格"></a>5.3、修改商品价格</h5><p>接口文档： <a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/GhnJ0L85">https://easydoc.xyz/s/78237135/ZUqEdvA4/GhnJ0L85</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AttrController.java</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/update/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">updateSpuAttr</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestBody</span> List&lt;ProductAttrValueEntity&gt; entities)</span>&#123;</span><br><span class="line"></span><br><span class="line">    productAttrValueService.updateSpuAttr(spuId,entities);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductAttrValueServiceImpl.java</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateSpuAttr</span><span class="params">(Long spuId, List&lt;ProductAttrValueEntity&gt; entities)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 删除这个spuId之前对应的所有属性</span></span><br><span class="line">    <span class="built_in">this</span>.baseMapper.delete(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;ProductAttrValueEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>, spuId));</span><br><span class="line"></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; collect = entities.stream().map(item -&gt; &#123;</span><br><span class="line">        item.setSpuId(spuId);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.saveBatch(collect);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试</strong>： POST localhost:88/api/product/attr/update/7</p><p>响应数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;attrId&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attrName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU型号&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attrValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;麒麟990&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;quickShow&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;attrId&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attrName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU工艺&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attrValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7nm&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;quickShow&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h5 id="5-4-、商品上架"><a href="#5-4-、商品上架" class="headerlink" title="5.4 、商品上架"></a>5.4 、商品上架</h5><p>接口文档： <a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/DhOtFr4A">https://easydoc.xyz/s/78237135/ZUqEdvA4/DhOtFr4A</a></p><p>对原有接口进行了修改： 添加了下架功能</p><p><strong>supinfo.vue</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-table-column</span><br><span class="line">  fixed=&quot;right&quot;</span><br><span class="line">  header-align=&quot;center&quot;</span><br><span class="line">  align=&quot;center&quot;</span><br><span class="line">  width=&quot;150&quot;</span><br><span class="line">  label=&quot;操作&quot;</span><br><span class="line">&gt;</span><br><span class="line">    &lt;template slot-scope=&quot;scope&quot;&gt;</span><br><span class="line">&lt;el-button</span><br><span class="line">           v-if=&quot;scope.row.publishStatus == 0 || scope.row.publishStatus == 2&quot;</span><br><span class="line">           type=&quot;text&quot;</span><br><span class="line">           size=&quot;small&quot;</span><br><span class="line">           @click=&quot;productUp(scope.row.id , scope.row.publishStatus)&quot;</span><br><span class="line">           &gt;上架&lt;/el-button&gt;</span><br><span class="line">&lt;el-button</span><br><span class="line">           v-if=&quot;scope.row.publishStatus == 1&quot;</span><br><span class="line">           type=&quot;text&quot;</span><br><span class="line">           size=&quot;small&quot;</span><br><span class="line">           @click=&quot;productUp(scope.row.id, scope.row.publishStatus)&quot;</span><br><span class="line">           &gt;下架&lt;/el-button&gt;</span><br><span class="line">&lt;el-button type=&quot;text&quot; size=&quot;small&quot; @click=&quot;attrUpdateShow(scope.row)&quot;&gt;规格&lt;/el-button&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">&lt;/el-table-column&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data() &#123; return &#123; // 定义了 AttrType 属性 AttrType: &quot;&quot;, dataSub: null, .... &#125;;</span><br><span class="line">&#125;, methods: &#123; productUp(id, publishStatus) &#123; console.log(&quot;============&quot;,</span><br><span class="line">publishStatus); if (publishStatus === 0 || publishStatus === 2) &#123; this.AttrType</span><br><span class="line">= &quot;up&quot;; &#125; if (publishStatus === 1) &#123; this.AttrType = &quot;down&quot;; &#125; this.$http(&#123; url:</span><br><span class="line">this.$http.adornUrl(`/product/spuinfo/$&#123;id&#125;/$&#123;this.AttrType&#125;`),</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210505160206.png" alt="image-20210505160204870"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/&#123;spuId&#125;/&#123;AttrType&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">StatusUp</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId,<span class="meta">@PathVariable</span> String AttrType )</span>&#123;</span><br><span class="line">    spuInfoService.hasPublishStatus(spuId,AttrType);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hasPublishStatus</span><span class="params">(Long spuId, String attrType)</span> &#123;</span><br><span class="line">    <span class="type">SpuInfoEntity</span> <span class="variable">spuInfoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuInfoEntity</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;up&quot;</span>.equalsIgnoreCase(attrType))&#123;</span><br><span class="line">        spuInfoEntity.setPublishStatus(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;down&quot;</span>.equalsIgnoreCase(attrType))&#123;</span><br><span class="line">        spuInfoEntity.setPublishStatus(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.baseMapper.update(spuInfoEntity,<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SpuInfoEntity&gt;().eq(<span class="string">&quot;id&quot;</span>,spuId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="十八、-仓库管理"><a href="#十八、-仓库管理" class="headerlink" title="十八、 仓库管理"></a>十八、 仓库管理</h2><blockquote><p>首先配置好 yml、properties 文件中需要的配置，注册进 nacos 中，然后网关中也需要配置好</p></blockquote><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">gulimall-ware</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">a8106f50-a70a-4cef-a466-805f801a49d1</span></span><br><span class="line"><span class="comment"># 应用服务 WEB 访问端口</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">11000</span></span><br><span class="line"><span class="comment"># 以下是2.1.X 写法， 2.2.X 写法不同</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].data-id</span>=<span class="string">gulimall-ware.yml</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].group</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.ext-config[0].refresh</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2.2.X</span></span><br><span class="line"><span class="comment">#spring.cloud.nacos.config.extension-configs[0].data-id=gulimall-ware.yml</span></span><br><span class="line"><span class="comment">#spring.cloud.nacos.config.extension-configs[0].group=DEFAULT_GROUP</span></span><br><span class="line"><span class="comment">#spring.cloud.nacos.config.extension-configs[0].refresh=true</span></span><br></pre></td></tr></table></figure><p>网关：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">gulimall-ware</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-ware</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Path=/api/ware/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure><h4 id="1、仓库列表功能"><a href="#1、仓库列表功能" class="headerlink" title="1、仓库列表功能"></a>1、仓库列表功能</h4><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/mZgdqOWe">https://easydoc.xyz/s/78237135/ZUqEdvA4/mZgdqOWe</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ware/wareinfo/list</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;WareInfoEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(key))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;id&quot;</span>,key).or()</span><br><span class="line">            .like(<span class="string">&quot;name&quot;</span>,key)</span><br><span class="line">            .or().like(<span class="string">&quot;address&quot;</span>,key)</span><br><span class="line">            .or().like(<span class="string">&quot;areacode&quot;</span>,key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;WareInfoEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>&lt;WareInfoEntity&gt;().getPage(params),</span><br><span class="line">        wrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、查询商品库存"><a href="#2、查询商品库存" class="headerlink" title="2、查询商品库存"></a>2、查询商品库存</h4><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/hwXrEXBZ">https://easydoc.xyz/s/78237135/ZUqEdvA4/hwXrEXBZ</a></p><p>访问地址： /ware/waresku/list</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WareSkuServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skuId: 1</span></span><br><span class="line"><span class="comment">     * wareId: 2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    QueryWrapper&lt;WareSkuEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">skuId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(skuId))&#123;</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;sku_id&quot;</span>,skuId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">wareId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;wareId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(wareId))&#123;</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;ware_id&quot;</span>,wareId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;WareSkuEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Query</span>&lt;WareSkuEntity&gt;().getPage(params),</span><br><span class="line">           queryWrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、采购单维护"><a href="#3、采购单维护" class="headerlink" title="3、采购单维护"></a>3、采购单维护</h4><h5 id="3-1-、采购需求"><a href="#3-1-、采购需求" class="headerlink" title="3.1 、采购需求"></a>3.1 、采购需求</h5><p>指定采购数量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">两种创建逻辑：</span><br><span class="line">1、后台新增采购需求【人工】</span><br><span class="line">2、后台库存预警自动发出采购需求【自动化】</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210505164500.png" alt="image-20210505164459360"></p><p>接口文档： <a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/Ss4zsV7R">https://easydoc.xyz/s/78237135/ZUqEdvA4/Ss4zsV7R</a></p><p>访问路径： /ware/purchasedetail/list</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PurchaseDetailServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * status: 0,//状态</span></span><br><span class="line"><span class="comment">         *    wareId: 1,//仓库id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;PurchaseDetailEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(key))&#123;</span><br><span class="line">        <span class="comment">// purchase_id sku_id</span></span><br><span class="line">        queryWrapper.and(w -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;purchase_id&quot;</span>,key).or().eq(<span class="string">&quot;sku_id&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(status))&#123;</span><br><span class="line">        <span class="comment">//purchase_id  sku_id</span></span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;status&quot;</span>,status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">wareId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;wareId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(wareId))&#123;</span><br><span class="line">        <span class="comment">//purchase_id  sku_id</span></span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;ware_id&quot;</span>,wareId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;PurchaseDetailEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>&lt;PurchaseDetailEntity&gt;().getPage(params),</span><br><span class="line">        queryWrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2、合并采购需求"><a href="#3-2、合并采购需求" class="headerlink" title="3.2、合并采购需求"></a>3.2、合并采购需求</h5><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/cUlv9QvK">https://easydoc.xyz/s/78237135/ZUqEdvA4/cUlv9QvK</a></p><p>访问路径：/ware/purchase/merge</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210505230954.png" alt="image-20210505230946284"></p><ol><li>先要有一个采购单，再选中多个采购需求整合到某个采购单中新增一个采购单,同时分配采购人员</li></ol><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210506214236.png" alt="image-20210506214228151"></p><ol><li>采购单状态：新建、已分配、已领取、已完成、有异常</li><li>点击整合，查询未领取的采购单【新建+已分配 状态的采购单】，这些采购单允许合并，已领取的单子不能再作为合并对象。</li></ol><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210506214335.png" alt="image-20210506214333763"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210506214359.png" alt="image-20210506214358174"></p><ul><li><strong>PurchaseController.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/merge&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">merge</span><span class="params">(<span class="meta">@RequestBody</span> MergeVo mergeVo)</span>&#123;</span><br><span class="line"></span><br><span class="line">    purchaseService.mergePurchase(mergeVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;ware:purchase:save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> PurchaseEntity purchase)</span>&#123;</span><br><span class="line">    purchase.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    purchase.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    purchaseService.save(purchase);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PurchaseDetailService purchaseDetailService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mergePurchase</span><span class="params">(MergeVo mergeVo)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO 采购需求的状态必须是 新建、已分配 才可以合并</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isMerge</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    List&lt;Long&gt; items = mergeVo.getItems();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(items))&#123;</span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; byIds = purchaseDetailService.listByIds(items);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>; i &lt; byIds.size(); i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(byIds.get(i).getStatus() != WareConstant.PurchaseDetailStatusEnum.CREATED.getCode() &amp;&amp; byIds.get(i).getStatus() != WareConstant.PurchaseDetailStatusEnum.ASSIGNED.getCode() )&#123;</span><br><span class="line">                isMerge = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        isMerge = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(isMerge)&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">purchaseId</span> <span class="operator">=</span> mergeVo.getPurchaseId();</span><br><span class="line">        <span class="keyword">if</span>(purchaseId == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 1. 建立一个采购单</span></span><br><span class="line">            <span class="type">PurchaseEntity</span> <span class="variable">purchaseEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseEntity</span>();</span><br><span class="line"></span><br><span class="line">            purchaseEntity.setStatus(WareConstant.PurchaseStatusEnum.CREATED.getCode());</span><br><span class="line">            purchaseEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            purchaseEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            <span class="built_in">this</span>.save(purchaseEntity);</span><br><span class="line">            purchaseId = purchaseEntity.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        items = mergeVo.getItems();</span><br><span class="line">        <span class="comment">// 2、修改采购需求，将采购单purchaseId加进去</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">finalPurchaseId</span> <span class="operator">=</span> purchaseId;</span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; collect = items.stream().map(i -&gt; &#123;</span><br><span class="line">            <span class="type">PurchaseDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseDetailEntity</span>();</span><br><span class="line"></span><br><span class="line">            detailEntity.setId(i);</span><br><span class="line">            detailEntity.setPurchaseId(finalPurchaseId);</span><br><span class="line">            detailEntity.setStatus(WareConstant.PurchaseDetailStatusEnum.ASSIGNED.getCode());</span><br><span class="line">            <span class="keyword">return</span> detailEntity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        purchaseDetailService.updateBatchById(collect);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改更新时间</span></span><br><span class="line">        <span class="type">PurchaseEntity</span> <span class="variable">purchaseEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseEntity</span>();</span><br><span class="line">        purchaseEntity.setId(purchaseId);</span><br><span class="line">        purchaseEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="built_in">this</span>.updateById(purchaseEntity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-3、查询未领取的采购单"><a href="#3-3、查询未领取的采购单" class="headerlink" title="3.3、查询未领取的采购单"></a>3.3、查询未领取的采购单</h5><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/hI12DNrH">https://easydoc.xyz/s/78237135/ZUqEdvA4/hI12DNrH</a></p><p>访问地址：/ware/purchase/unreceive/list</p><ul><li><strong>PurchaseController.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/unreceive/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">unreceivelist</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> purchaseService.queryPageUnreceivePurchase(params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPageUnreceivePurchase</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    IPage&lt;PurchaseEntity&gt; page = <span class="built_in">this</span>.page(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Query</span>&lt;PurchaseEntity&gt;().getPage(params),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;PurchaseEntity&gt;().eq(<span class="string">&quot;status&quot;</span>,<span class="number">0</span>).or().eq(<span class="string">&quot;status&quot;</span>,<span class="number">1</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-4、领取采购单"><a href="#3-4、领取采购单" class="headerlink" title="3.4、领取采购单"></a>3.4、领取采购单</h5><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/vXMBBgw1">https://easydoc.xyz/s/78237135/ZUqEdvA4/vXMBBgw1</a></p><p>访问地址：/ware/purchase/received</p><p><strong>领取流程：</strong></p><ol><li><p>采购人员在手机 app 上看到自己的采购单，然后点击 领取【采购单状态变为已领取】</p></li><li><p>已领取的采购单 不能在继续分配 采配需求</p></li><li><p>被采购人员点击领取的采购单，关联的采购需求要同步修改为正在采购【采购单（已领取）== 采购需求（正在采购）】</p></li></ol><p><code>注意：</code> 需要测试领取是否成功之前需要先合并一个采购单。_怎么合并请这篇博客_：<strong>合并采购需求</strong></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210506214903.png" alt="image-20210506214902180"></p><ul><li><strong>PurchaseController.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/received&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">received</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; ids)</span>&#123;</span><br><span class="line">    purchaseService.received(ids);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 确定当前采购单实新建或者以分配状态</span></span><br><span class="line">    List&lt;PurchaseEntity&gt; collect = ids.stream().map(id -&gt; &#123;</span><br><span class="line">        <span class="type">PurchaseEntity</span> <span class="variable">byId</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        <span class="keyword">return</span> byId;</span><br><span class="line">    &#125;).filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (item.getStatus() == WareConstant.PurchaseStatusEnum.CREATED.getCode()</span><br><span class="line">            || item.getStatus() == WareConstant.PurchaseStatusEnum.ASSIGNED.getCode()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        item.setStatus(WareConstant.PurchaseStatusEnum.RECEIVE.getCode());</span><br><span class="line">        item.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变采购单的状态</span></span><br><span class="line">    <span class="built_in">this</span>.updateBatchById(collect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 改变采购项的状态</span></span><br><span class="line">    collect.forEach((item) -&gt; &#123;</span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; entities = purchaseDetailService.listDetailByPuchaseId(item.getId());</span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; detailEntities = entities.stream().map(items -&gt; &#123;</span><br><span class="line">            <span class="type">PurchaseDetailEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseDetailEntity</span>();</span><br><span class="line">            entity.setId(items.getId());</span><br><span class="line">            entity.setStatus(WareConstant.PurchaseDetailStatusEnum.BUYING.getCode());</span><br><span class="line">            <span class="keyword">return</span> entity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        purchaseDetailService.updateBatchById(detailEntities);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseDetailServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;PurchaseDetailEntity&gt; <span class="title function_">listDetailByPuchaseId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    List&lt;PurchaseDetailEntity&gt; purchase_id = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;PurchaseDetailEntity&gt;().eq(<span class="string">&quot;purchase_id&quot;</span>, id));</span><br><span class="line">    <span class="keyword">return</span> purchase_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试：</strong></p><p>访问地址：localhost:88/api/ware/purchase/received</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210506222332.png" alt="image-20210506222331219"></p><p>响应结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="3-5、完成采购"><a href="#3-5、完成采购" class="headerlink" title="3.5、完成采购"></a>3.5、完成采购</h5><p>接口文档：<a target="_blank" rel="noopener" href="https://easydoc.xyz/s/78237135/ZUqEdvA4/cTQHGXbK">https://easydoc.xyz/s/78237135/ZUqEdvA4/cTQHGXbK</a></p><p>访问地址：/ware/purchase/done</p><ol><li>提交了每个采购需求的状态【status，所以完成采购单，但是采购需求可能失败】</li></ol><p><em>ware 模块中创建两个 Vo</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PurchaseDoneVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Long id;<span class="comment">//采购单id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;PurchaseItemDoneVo&gt; items;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PurchaseItemDoneVo</span> &#123;</span><br><span class="line">    <span class="comment">//&#123;itemId:1,status:4,reason:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="keyword">private</span> Long itemId;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> String reason;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseController.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/done&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">finish</span><span class="params">(<span class="meta">@RequestBody</span> PurchaseDoneVo doneVo)</span>&#123;</span><br><span class="line">    purchaseService.done(doneVo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>PurchaseServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">(PurchaseDoneVo doneVo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> doneVo.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 改变采购项的状态</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    List&lt;PurchaseItemDoneVo&gt; items = doneVo.getItems();</span><br><span class="line"></span><br><span class="line">    List&lt;PurchaseDetailEntity&gt; updates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(PurchaseItemDoneVo item : items)&#123;</span><br><span class="line">        <span class="type">PurchaseDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseDetailEntity</span>();</span><br><span class="line">        <span class="keyword">if</span>(item.getStatus() == WareConstant.PurchaseDetailStatusEnum.HASERROR.getCode())&#123;</span><br><span class="line">            flag = <span class="literal">false</span>;</span><br><span class="line">            detailEntity.setStatus(item.getStatus());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            detailEntity.setStatus(WareConstant.PurchaseDetailStatusEnum.FINISH.getCode());</span><br><span class="line">            <span class="comment">// 3. 将成功采购的进行入库</span></span><br><span class="line">            <span class="type">PurchaseDetailEntity</span> <span class="variable">entity</span> <span class="operator">=</span> purchaseDetailService.getById(item.getItemId());</span><br><span class="line">            wareSkuService.addStock(entity.getSkuId(),entity.getWareId(),entity.getSkuNum());</span><br><span class="line">        &#125;</span><br><span class="line">        detailEntity.setId(item.getItemId());</span><br><span class="line">        updates.add(detailEntity);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    purchaseDetailService.updateBatchById(updates);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变采购订单状态</span></span><br><span class="line">    <span class="type">PurchaseEntity</span> <span class="variable">purchaseEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PurchaseEntity</span>();</span><br><span class="line">    purchaseEntity.setId(id);</span><br><span class="line">    purchaseEntity.setStatus(flag?WareConstant.PurchaseStatusEnum.FINISH.getCode():WareConstant.PurchaseStatusEnum.HASERROR.getCode());</span><br><span class="line">    purchaseEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="built_in">this</span>.updateById(purchaseEntity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>WareSkuServiceImpl.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addStock</span><span class="params">(Long skuId, Long wareId, Integer skuNum)</span> &#123;</span><br><span class="line">    <span class="comment">// 1、判断如果还没有这个库的记录新增</span></span><br><span class="line">    List&lt;WareSkuEntity&gt; entities = wareSkuDao.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;WareSkuEntity&gt;().eq(<span class="string">&quot;ware_id&quot;</span>, wareId));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(entities == <span class="literal">null</span> || entities.size() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="type">WareSkuEntity</span> <span class="variable">skuEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WareSkuEntity</span>();</span><br><span class="line">        skuEntity.setSkuId(skuId);</span><br><span class="line">        skuEntity.setStock(skuNum);</span><br><span class="line">        skuEntity.setWareId(wareId);</span><br><span class="line">        skuEntity.setStockLocked(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//TODO 远程查询sku的名字，如果失败，整个事务无需回滚</span></span><br><span class="line">        <span class="comment">//1、自己catch异常</span></span><br><span class="line">        <span class="comment">//TODO 还可以用什么办法让异常出现以后不回滚？高级</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">R</span> <span class="variable">info</span> <span class="operator">=</span> productFeignService.info(skuId);</span><br><span class="line">            Map&lt;String,Object&gt; data  = (Map&lt;String, Object&gt;) info.get(<span class="string">&quot;skuInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(info.getCode() == <span class="number">0</span>)&#123;</span><br><span class="line">                skuEntity.setSkuName((String) data.get(<span class="string">&quot;skuName&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        wareSkuDao.insert(skuEntity);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        wareSkuDao.addStock(skuId,wareId,skuNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>productFeignService.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;gulimall-product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/product/skuinfo/info/&#123;skuId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;skuId&quot;)</span> Long skuId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>WareSkuDao.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WareSkuDao</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;WareSkuEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addStock</span><span class="params">(<span class="meta">@Param(&quot;skuId&quot;)</span> Long skuId, <span class="meta">@Param(&quot;wareId&quot;)</span> Long wareId, <span class="meta">@Param(&quot;skuNum&quot;)</span> Integer skuNum)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>WareSkuDao.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;addStock&quot;</span>&gt;</span></span><br><span class="line">    UPDATE `wms_ware_sku` SET stock=stock+#&#123;skuNum&#125; WHERE sku_id=#&#123;skuId&#125; AND ware_id=#&#123;wareId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>测试：</strong></p><p>测试地址：localhost:88/api/ware/purchase/done</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;itemId&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;缺货&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;itemId&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">3</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507001044.png" alt="image-20210507001041527"></p><p>响应数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="十九、分布式基础篇总结"><a href="#十九、分布式基础篇总结" class="headerlink" title="十九、分布式基础篇总结"></a>十九、分布式基础篇总结</h2><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/no1_drawing_bed-master/20210507001910.png" alt="image-20210507001859900"></p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>谷粒商城—分布式基础(二)</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://oy6090.top/posts/3d7d679f/">https://oy6090.top/posts/3d7d679f/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display:inline-block;width:120px"><h>作者</h><div class="post-copyright-cc-info"><h>OY</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-05-07</h></div></div><div class="post-copyright-u" style="display:inline-block;width:120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-06-17</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E9%A1%B9%E7%9B%AE/">Java项目</a></div><div class="post_share"><div class="social-share" data-image="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/21.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://fastly.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/c84e54f/"><img class="prev-cover" src="https://oss.imoyt.top/img/20210516225040.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Java算法篇（一）</div></div></a></div><div class="next-post pull-right"><a href="/posts/b95a7f8d/"><img class="next-cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/20.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">谷粒商城项目Bug整理总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i> <span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/1b6f740d/" title="谷粒商城—分布式基础(一)"><img class="cover" src="https://oss.imoyt.top/img/20210502174039.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-02</div><div class="title">谷粒商城—分布式基础(一)</div></div></a></div><div><a href="/posts/f5810d24/" title="谷粒商城-高级篇（SSO-单点登录）"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-26</div><div class="title">谷粒商城-高级篇（SSO-单点登录）</div></div></a></div><div><a href="/posts/764a0b3/" title="谷粒商城-高级篇（分布式事务）"><img class="cover" src="https://oss.imoyt.top/blog_img/imoyt/26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-08</div><div class="title">谷粒商城-高级篇（分布式事务）</div></div></a></div><div><a href="/posts/e63bc92f/" title="谷粒商城-高级篇(分布式锁与缓存)"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-22</div><div class="title">谷粒商城-高级篇(分布式锁与缓存)</div></div></a></div><div><a href="/posts/f1fcc865/" title="谷粒商城-高级篇(检索服务)"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-04</div><div class="title">谷粒商城-高级篇(检索服务)</div></div></a></div><div><a href="/posts/46beec8e/" title="谷粒商城-高级篇(秒杀功能)"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/36.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-12</div><div class="title">谷粒商城-高级篇(秒杀功能)</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Waline</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__name">OY</div><div class="author-info__description">放弃不难，但坚持一定很酷</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/OyCodeSite"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/OyCodeSite" target="_blank" title="Github"><i class="iconfont icon-githubblack"></i></a><a class="social-icon" href="mailto:2097291754@qq.com" target="_blank" title="Email"><i class="iconfont icon-youxiang"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=2097291754" target="_blank" title="qq"><i class="iconfont icon-QQ2"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_45738810" target="_blank" title="CSDN"><i class="iconfont icon-csdn1"></i></a><a class="social-icon" href="https://travellings-zeta.vercel.app/" target="_blank" title="开往"><i class="iconfont icon-icon-technology-rocket"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">OY博客功能是用来记录学习的笔记以及一些基本的操作记录。如果你在阅读中遇到了什么问题，可以到留言板留言，也可以联系我哦! <img src="https://fastly.jsdelivr.net/gh/OY6090/pic@main/oy_img/20210208142850.gif"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E9%80%92%E5%BD%92%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-text">一、 递归树形结构获取数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%88%A0%E9%99%A4-%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE"><span class="toc-text">二、删除&#x2F;添加数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-text">三、修改数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%8F%9C%E5%8D%95%E6%8B%96%E5%8A%A8"><span class="toc-text">四、菜单拖动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-text">批量删除</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86%E8%8F%9C%E5%8D%95"><span class="toc-text">五、品牌管理菜单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E2%80%9C%E6%98%BE%E7%A4%BA%E7%8A%B6%E6%80%81%E6%8C%89%E9%92%AE%E2%80%9D"><span class="toc-text">添加“显示状态按钮”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%8A%E4%BC%A0"><span class="toc-text">添加上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="toc-text">1、添加依赖包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%B5%81"><span class="toc-text">2、上传文件流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E5%BC%8F"><span class="toc-text">其他方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%96%B0%E5%BB%BA-gulimall-third-party"><span class="toc-text">1）新建 gulimall-third-party</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%EF%BC%8C%E5%B0%86%E5%8E%9F%E6%9D%A5-gulimall-common-%E4%B8%AD%E7%9A%84%E2%80%9Cspring-cloud-starter-alicloud-oss%E2%80%9D%E4%BE%9D%E8%B5%96%E7%A7%BB%E5%8A%A8%E5%88%B0%E8%AF%A5%E9%A1%B9%E7%9B%AE%E4%B8%AD"><span class="toc-text">2）添加依赖，将原来 gulimall-common 中的“spring-cloud-starter-alicloud-oss”依赖移动到该项目中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%9C%A8%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E4%B8%AD%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0"><span class="toc-text">3）在主启动类中开启服务的注册和发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E5%9C%A8-nacos-%E4%B8%AD%E6%B3%A8%E5%86%8C"><span class="toc-text">4）在 nacos 中注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">5）编写配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%EF%BC%89-%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-text">6） 编写测试类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%EF%BC%9A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%AD%BE%E5%90%8D%E5%90%8E%E7%9B%B4%E4%BC%A0"><span class="toc-text">改进：服务端签名后直传</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E7%BB%84%E4%BB%B6"><span class="toc-text">上传组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81-JSR303-%E6%A0%A1%E9%AA%8C"><span class="toc-text">六、 JSR303 校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NotNull-%E7%AD%89"><span class="toc-text">@NotNull 等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Valid-%E5%86%85%E7%BD%AE%E5%BC%82%E5%B8%B8"><span class="toc-text">@Valid 内置异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-BindResult"><span class="toc-text">局部异常处理 BindResult</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-ExceptionHandler"><span class="toc-text">统一异常处理@ExceptionHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E9%BB%98%E8%AE%A4%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">（3）默认异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E9%94%99%E8%AF%AF%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-text">（4）错误状态码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD%EF%BC%88%E5%AE%8C%E6%88%90%E5%A4%9A%E5%9C%BA%E6%99%AF%E7%9A%84%E5%A4%8D%E6%9D%82%E6%A0%A1%E9%AA%8C%EF%BC%89"><span class="toc-text">七、分组校验功能（完成多场景的复杂校验）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-NotNull-groups-A-class"><span class="toc-text">1、@NotNull(groups&#x3D;{A.class})</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81-Validated"><span class="toc-text">2、@Validated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C%E7%9A%84%E9%BB%98%E8%AE%A4%E6%A0%A1%E9%AA%8C"><span class="toc-text">3、分组校验的默认校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD"><span class="toc-text">八、自定义校验功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3"><span class="toc-text">1、编写一个自定义的校验注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%A0%A1%E9%AA%8C%E5%99%A8"><span class="toc-text">2、编写一个自定义的校验器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%85%B3%E8%81%94%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%A0%A1%E9%AA%8C%E5%99%A8%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3"><span class="toc-text">3、关联自定义的校验器和自定义的校验注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="toc-text">4、使用实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%95%86%E5%93%81-SPU-%E5%92%8C-SKU-%E7%AE%A1%E7%90%86"><span class="toc-text">九、商品 SPU 和 SKU 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pms-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">&#x3D;&#x3D;pms 数据库表&#x3D;&#x3D;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86%E5%92%8C%E5%85%B3%E8%81%94%E5%88%86%E7%B1%BB"><span class="toc-text">十、品牌管理和关联分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E5%9C%B0%E5%9D%80"><span class="toc-text">接口文档地址</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84"><span class="toc-text">1、属性分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-text">2、父子组件传递数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81this-emit"><span class="toc-text">3、this.$emit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="toc-text">4、分页插件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mp-%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-text">mp 常用注解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#wrapper"><span class="toc-text">wrapper</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mp-%E5%88%86%E9%A1%B5%E4%BD%BF%E7%94%A8"><span class="toc-text">mp 分页使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Query"><span class="toc-text">Query</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E7%94%A8%E6%B3%95%EF%BC%9AXML-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E9%A1%B5"><span class="toc-text">常规用法：XML 自定义分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Ipage"><span class="toc-text">Ipage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%85%B3%E8%81%94%E5%88%86%E7%B1%BB"><span class="toc-text">5、关联分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E8%A1%A8%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%9A"><span class="toc-text">关联表的优化：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%9D%E6%8C%81%E5%86%97%E4%BD%99%E5%AD%97%E6%AE%B5%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4"><span class="toc-text">保持冗余字段的数据一致</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E6%96%B0%E5%A2%9E%E4%B8%8E-VO"><span class="toc-text">十一、 规格参数新增与 VO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E8%A7%84%E6%A0%BC-%E5%8F%82%E6%95%B0%E4%B8%8E%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-text">十二、规格 参数与销售属性的增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96"><span class="toc-text">细节优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%BB%84%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7%E5%92%8C%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94"><span class="toc-text">十三、 查询分组关联属性和删除关联</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E7%9A%84%E5%85%B3%E8%81%94%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7"><span class="toc-text">1、获取属性分组的关联的所有属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E7%A7%BB%E9%99%A4%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E7%9A%84%E5%85%B3%E8%81%94%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">2、移除属性分组的关联的属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%BB%84%E6%9C%AA%E5%85%B3%E8%81%94%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">十四、 查询分组未关联的属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E6%B7%BB%E5%8A%A0%E5%B1%9E%E6%80%A7%E5%92%8C%E5%88%86%E7%BB%84%E7%9A%84%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"><span class="toc-text">十五、添加属性和分组的关联关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E5%8F%91%E5%B8%83%E5%95%86%E5%93%81"><span class="toc-text">十六、发布商品</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E4%BC%9A%E5%91%98%E7%AD%89%E7%BA%A7"><span class="toc-text">1、获取所有会员等级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E7%9A%84%E5%93%81%E7%89%8C"><span class="toc-text">2、获取分类关联的品牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E4%B8%8B%E6%89%80%E6%9C%89%E5%88%86%E7%BB%84-amp-%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7"><span class="toc-text">3、获取分类下所有分组&amp;关联属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E4%BF%9D%E5%AD%98-SPU-%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-text">4、保存 SPU 的基本信息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81%E6%96%B0%E5%A2%9E%E5%95%86%E5%93%81-BUG-%E6%B1%87%E6%80%BB"><span class="toc-text">4.1、新增商品 BUG 汇总</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81spu-%E7%AE%A1%E7%90%86"><span class="toc-text">5、spu 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1%E3%80%81SPU-%E6%A3%80%E7%B4%A2-%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-text">5.1、SPU 检索 时间格式化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-%E3%80%81%E8%8E%B7%E5%8F%96-spu-%E8%A7%84%E6%A0%BC"><span class="toc-text">5.2 、获取 spu 规格</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3%E3%80%81%E4%BF%AE%E6%94%B9%E5%95%86%E5%93%81%E4%BB%B7%E6%A0%BC"><span class="toc-text">5.3、修改商品价格</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-%E3%80%81%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="toc-text">5.4 、商品上架</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E5%85%AB%E3%80%81-%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86"><span class="toc-text">十八、 仓库管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%BB%93%E5%BA%93%E5%88%97%E8%A1%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">1、仓库列表功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81%E5%BA%93%E5%AD%98"><span class="toc-text">2、查询商品库存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E9%87%87%E8%B4%AD%E5%8D%95%E7%BB%B4%E6%8A%A4"><span class="toc-text">3、采购单维护</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-%E3%80%81%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"><span class="toc-text">3.1 、采购需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81%E5%90%88%E5%B9%B6%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"><span class="toc-text">3.2、合并采购需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3%E3%80%81%E6%9F%A5%E8%AF%A2%E6%9C%AA%E9%A2%86%E5%8F%96%E7%9A%84%E9%87%87%E8%B4%AD%E5%8D%95"><span class="toc-text">3.3、查询未领取的采购单</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4%E3%80%81%E9%A2%86%E5%8F%96%E9%87%87%E8%B4%AD%E5%8D%95"><span class="toc-text">3.4、领取采购单</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5%E3%80%81%E5%AE%8C%E6%88%90%E9%87%87%E8%B4%AD"><span class="toc-text">3.5、完成采购</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%BB%E7%BB%93"><span class="toc-text">十九、分布式基础篇总结</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/46beec8e/" title="谷粒商城-高级篇(秒杀功能)"><img src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/36.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="谷粒商城-高级篇(秒杀功能)"></a><div class="content"><a class="title" href="/posts/46beec8e/" title="谷粒商城-高级篇(秒杀功能)">谷粒商城-高级篇(秒杀功能)</a><time datetime="2022-06-12T23:06:00.000Z" title="发表于 2022-06-12 23:06:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/622eb062/" title="b站大学学习路线"><img src="https://oss.imoyt.top/img/202204140006105.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="b站大学学习路线"></a><div class="content"><a class="title" href="/posts/622eb062/" title="b站大学学习路线">b站大学学习路线</a><time datetime="2022-04-14T12:00:00.000Z" title="发表于 2022-04-14 12:00:00">2022-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/a66c836/" title="谷粒商城-高级篇（订单服务）"><img src="https://oss.imoyt.top/blog_img/imoyt/15.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="谷粒商城-高级篇（订单服务）"></a><div class="content"><a class="title" href="/posts/a66c836/" title="谷粒商城-高级篇（订单服务）">谷粒商城-高级篇（订单服务）</a><time datetime="2022-04-08T23:30:00.000Z" title="发表于 2022-04-08 23:30:00">2022-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/764a0b3/" title="谷粒商城-高级篇（分布式事务）"><img src="https://oss.imoyt.top/blog_img/imoyt/26.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="谷粒商城-高级篇（分布式事务）"></a><div class="content"><a class="title" href="/posts/764a0b3/" title="谷粒商城-高级篇（分布式事务）">谷粒商城-高级篇（分布式事务）</a><time datetime="2022-04-08T23:15:00.000Z" title="发表于 2022-04-08 23:15:00">2022-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8bf03f92/" title="vscode配置 -- 编写C语言"><img src="https://oss.imoyt.top/blog_img/imoyt/18.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="vscode配置 -- 编写C语言"></a><div class="content"><a class="title" href="/posts/8bf03f92/" title="vscode配置 -- 编写C语言">vscode配置 -- 编写C语言</a><time datetime="2022-03-10T21:40:00.000Z" title="发表于 2022-03-10 21:40:00">2022-03-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By OY</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" alt="又拍云" rel="nofollow"><img src="https://s1.ax1x.com/2020/07/27/aPoebR.png" alt="又拍云" class="yunpai"></a>&nbsp;&nbsp;&nbsp; <a href="https://cloud.tencent.com/" target="_blank" alt="腾讯云" rel="nofollow"><img src="https://oss.imoyt.top/img/202205252228367.png" alt="腾讯云" class="yunpai"></a>&nbsp;&nbsp;&nbsp; <a href="https://travellings.now.sh/" target="_blank" alt="travellings" rel="nofollow"><img src="https://oss.imoyt.top/img/202205252230430.gif" alt="travellings" class="yunpai"></a><br><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img class="icp-icon" src="/img/icp1.png"><span>湘 ICP 备 2020020882 号-1</span></a> &nbsp;&nbsp; <a target="_blank" rel="noopener" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43108102000064"><img class="icp-icon" src="/img/icp.png"><span>湘公网安备 43108102000064 号</span></a><p class="ghbdages"><a href="https://hexo.io/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;&nbsp;<a href="https://github.com/jerryc127/hexo-theme-butterfly" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;&nbsp;<a href="https://www.jsdelivr.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a>&nbsp;&nbsp;<a href="https://vercel.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;&nbsp;<a href="https://github.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;&nbsp;<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA 4.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://fastly.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://fastly.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://fastly.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://fastly.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      true && mermaid.init()
    })
  }
}</script><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'oyblogs-3gzdbfvm65d47b6e',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'oyblogs-3gzdbfvm65d47b6e',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://fastly.jsdelivr.net/npm/twikoo@1.5.0/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://imnerd-api-beige.vercel.app/',
      avatar: 'monsterid',
      path: location.pathname,
      visitor: false,
      dark: '[data-theme="dark"]'
    }, null))
  }

  if (typeof Waline === 'function') initWaline() 
  else getScript('https://fastly.jsdelivr.net/npm/@waline/client/dist/Waline.min.js').then(initWaline)
}

if ('Twikoo' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="/tools/js/jquery.min.js"></script><script data-pjax src="/tools/js/oy.js"></script><script data-pjax src="/tools/js/index.js"></script><script async src="//at.alicdn.com/t/font_2264842_3izu8i5eoc2.js"></script><script src="https://myhkw.cn/player/js/player.js" id="myhk" key="161104765824" m="1"></script><script defer src="https://fastly.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"✨ 博客已更新 👉",backgroundColor:t,duration:5e5,pos:e,actionText:"✔ 点击刷新 💫",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",function(){showNotification()}),window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")}));</script><script async data-pjax src="https://fastly.jsdelivr.net/gh/HCLonely/hclonely.github.io@1.4.7/js/custom/pace.min.js"></script><script id="click-show-text" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,富强,文明,和谐,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async></script><script>!function(t,e,o,c,n,a,i){t.DaoVoiceObject=n,t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},t[n].l=1*new Date,a=e.createElement(o),i=e.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",i.parentNode.insertBefore(a,i)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/5a56cd55.js","daovoice")</script><script>var isChatBtn = true
daovoice('init', {
  app_id: '5a56cd55',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://fastly.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/link/"]):not([href="/artitalk/"]):not([href="/bb/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax], .pjax-reload script').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="pjax-reload"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","100ms"),arr[i].setAttribute("data-wow-offset","50"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("ghbdages"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInX"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay","50ms"),arr[i].setAttribute("data-wow-offset","50"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("article-sort-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","1")</script></div><script defer src="https://fastly.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script><script defer src="/tools/js/wow_init.js"></script></div></body></html>