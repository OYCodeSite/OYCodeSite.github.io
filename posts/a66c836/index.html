<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>谷粒商城-高级篇（订单服务） | OYの博客</title><meta name="keywords" content="Java项目"><meta name="author" content="OY"><meta name="copyright" content="OY"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、RabbitMQ见我自己总结的两篇博客  RabbitMQ 基础  SpringBoot 与消息   二、安装 RabbitMQ1234docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:managem"><meta property="og:type" content="article"><meta property="og:title" content="谷粒商城-高级篇（订单服务）"><meta property="og:url" content="https://oy6090.top/posts/a66c836/index.html"><meta property="og:site_name" content="OYの博客"><meta property="og:description" content="一、RabbitMQ见我自己总结的两篇博客  RabbitMQ 基础  SpringBoot 与消息   二、安装 RabbitMQ1234docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:managem"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://oss.imoyt.top/blog_img/imoyt/15.jpg"><meta property="article:published_time" content="2022-04-08T23:30:00.000Z"><meta property="article:modified_time" content="2023-08-14T14:58:56.197Z"><meta property="article:author" content="OY"><meta property="article:tag" content="Java项目"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://oss.imoyt.top/blog_img/imoyt/15.jpg"><link rel="shortcut icon" href="/img/favicons.png"><link rel="canonical" href="https://oy6090.top/posts/a66c836/"><link rel="preconnect" href="//fastly.jsdelivr.net"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/images/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/images/pwaicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/pwaicons/android-chrome-36x36.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/pwaicons/android-chrome-16x16.png"><link rel="mask-icon" href="/images/pwaicons/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"这篇文章最后更新于","messageNext":"天前，您需要注意相关的内容是否还可用，如有疑问请联系博主！"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: OY","link":"链接: ","source":"来源: OYの博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://fastly.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@main/butterflyCss/animate.min.css" media="print" onload='this.media="all"'><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"谷粒商城-高级篇（订单服务）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-14 14:58:56"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" data-pjax href="/tools/css/icofont.css"><link rel="stylesheet" href="/tools/css/font/iconfont.css"><link rel="stylesheet" href="/tools/css/oy.css"><link rel="stylesheet" href="/tools/css/oyindex.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/tools/css/notetag.css"><link rel="stylesheet" href="/tools/css/commentsbar.css"><link rel="stylesheet" href="/tools/css/bb.css"><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/plugins.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/hclonely.github.io@1.4.7/css/custom/pace-theme-flash.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw iconfont icon-liaotian"></i> <span>碎碎念</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-iconfontlink"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-daohang1"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/aboout/"><i class="fa-fw iconfont icon-crmuser"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-bianjiwenzhang"></i> <span>找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-label_icon"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-wenjian"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiangzi"></i> <span>菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-huatong"></i> <span>哔哔</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://imoyt.top/"><i class="fa-fw iconfont icon-zhandian"></i> <span>分站</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont icon-yinyue"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/logs/"><i class="fa-fw iconfont icon-rizhi"></i> <span>更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://console.leancloud.app/apps"><i class="fa-fw iconfont icon-houtaiguanli"></i> <span>Leancloud</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://oss.imoyt.top/blog_img/imoyt/15.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">OYの博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw iconfont icon-liaotian"></i> <span>碎碎念</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-iconfontlink"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-daohang1"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page" href="/aboout/"><i class="fa-fw iconfont icon-crmuser"></i> <span>关于我</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-bianjiwenzhang"></i> <span>找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-label_icon"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-wenjian"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiangzi"></i> <span>菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-huatong"></i> <span>哔哔</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://imoyt.top/"><i class="fa-fw iconfont icon-zhandian"></i> <span>分站</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw iconfont icon-yinyue"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/logs/"><i class="fa-fw iconfont icon-rizhi"></i> <span>更新日志</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://console.leancloud.app/apps"><i class="fa-fw iconfont icon-houtaiguanli"></i> <span>Leancloud</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">谷粒商城-高级篇（订单服务）<a class="post-edit-link" href="https://github.com/OYCodeSite/HexoButterFly/tree/main/source/_posts/Java项目/谷粒商城/谷粒商城-高级篇(订单服务).md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-08T23:30:00.000Z" title="发表于 2022-04-08 23:30:00">2022-04-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T14:58:56.197Z" title="更新于 2023-08-14 14:58:56">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="谷粒商城-高级篇（订单服务）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、RabbitMQ"><a href="#一、RabbitMQ" class="headerlink" title="一、RabbitMQ"></a>一、RabbitMQ</h2><p>见我自己总结的两篇博客</p><ul><li><p><a href="https://oy6090.top/posts/b543ced0/">RabbitMQ 基础</a></p></li><li><p><a href="https://oy6090.top/posts/1634411798/">SpringBoot 与消息</a></p></li></ul><h2 id="二、安装-RabbitMQ"><a href="#二、安装-RabbitMQ" class="headerlink" title="二、安装 RabbitMQ"></a>二、安装 RabbitMQ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:management</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改为自动重启：</span></span><br><span class="line">docker update rabbitmq --restart=always</span><br></pre></td></tr></table></figure><blockquote><ul><li>4369,25672(Erlang 发现&amp;集群端口)</li><li>5672,5671(AMQP 端口)</li><li>15672(web 管理后台端口)</li><li>61613,61614(STOMP 协议端口)</li><li>1883,8883(MQTT 协议端口)</li></ul></blockquote><ul><li>RabbitMQ 管理 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/networking.html">https://www.rabbitmq.com/networking.html</a></li></ul><blockquote><p>启动</p></blockquote><ul><li><a target="_blank" rel="noopener" href="http://192.168.56.10:15672/">http://192.168.56.10:15672/</a> 用户名和密码：guest<br><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227224127.png" alt="image-20211227224111033"></li></ul><p><strong>配置文件：</strong></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227224337.png" alt="1598619251787"></p><h2 id="三、整合-SpringBoot"><a href="#三、整合-SpringBoot" class="headerlink" title="三、整合 SpringBoot"></a>三、整合 SpringBoot</h2><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227225011.png" alt="image-20211227225010432"></p><blockquote><p><strong>1、在订单服务中引入依赖</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--rabbitmq--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>2、配置文件</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">    port: <span class="number">5672</span></span><br><span class="line">#    虚拟主机</span><br><span class="line">    virtual-host: /</span><br><span class="line">#    开启发送端抵达队列确认【发送端确认机制+本地事务表】</span><br><span class="line">    publisher-returns: <span class="literal">true</span></span><br><span class="line">#    开启发送确认【发送端确认机制+本地事务表】</span><br><span class="line">    publisher-confirm-type: correlated</span><br><span class="line">#    只要抵达队列，优先回调<span class="keyword">return</span> confirm</span><br><span class="line">    template:</span><br><span class="line">      mandatory: <span class="literal">true</span></span><br><span class="line">#    使用手动确认模式，关闭自动确认【消息丢失】</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、<span class="meta">@EnableRabbit</span> 加在启动类上【发送消息可以不需要这个注解，监听消息必须使用这个注解】</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、RabbitAutoConfiguration 生效，给容器自动配置了很多类</span><br><span class="line">	RabbitTemplate、AmqpAdmin、CachingConnectionFactory、RabbitMessagingTemplate</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、接收消息注解：</span><br><span class="line"><span class="meta">@RabbitListener(queues=&#123;&quot;hello-java-queue&quot;&#125;)</span></span><br><span class="line"><span class="meta">@RabbitHandler</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>3、基本使用</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、如何创建Exchanger、Queue、Binding</span><br><span class="line">	<span class="number">1</span>）使用AmqpAdmin</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建交换机</span></span><br><span class="line">        amqpAdmin.declareExchange(<span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;hello-java-exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>));</span><br><span class="line">        log.info(<span class="string">&quot;Exchange创建[&#123;&#125;]成功&quot;</span>, <span class="string">&quot;hello-java-exchange&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        amqpAdmin.declareQueue(<span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;hello-java-queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>));</span><br><span class="line">        log.info(<span class="string">&quot;Queue创建[&#123;&#125;]成功&quot;</span>, <span class="string">&quot;hello-java-queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建绑定</span></span><br><span class="line">        <span class="comment">// String destination【目的地，队列name或 交换机name(如果作为路由的话)】</span></span><br><span class="line">        <span class="comment">// Binding.DestinationType destinationType【目的地类型 queue还是exchange(路由)】</span></span><br><span class="line">        <span class="comment">// String exchange【交换机】</span></span><br><span class="line">        <span class="comment">// String routingKey【路由键】</span></span><br><span class="line">        <span class="comment">// @Nullable Map&lt;String, Object&gt; arguments【自定义参数】</span></span><br><span class="line">        amqpAdmin.declareBinding(<span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;hello-java-queue&quot;</span>, Binding.DestinationType.QUEUE,<span class="string">&quot;hello-java-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;hello.java&quot;</span>, <span class="literal">null</span>));</span><br><span class="line">        log.info(<span class="string">&quot;Binding创建[&#123;&#125;]成功&quot;</span>, <span class="string">&quot;hello-java-binding&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、如何发送消息【<span class="number">1</span>、交换机；<span class="number">2</span>、路由键；<span class="number">3</span>、消息】</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;hello-java-exchange&quot;</span>, <span class="string">&quot;hello.java&quot;</span>, <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、使用json格式的序列化器</span><br><span class="line">    否则使用jdk的序列化器</span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、接收消息【<span class="number">1</span>、精确交换机：一条消息只会被消费一次；<span class="number">2</span>、绑定队列就可以了】</span><br><span class="line">    <span class="number">1</span>）必须使用<span class="meta">@EnableRabbit</span></span><br><span class="line">    <span class="number">2</span>）监听方法必须放在<span class="meta">@Component</span>中</span><br><span class="line">    <span class="number">3</span>）<span class="meta">@RabbitListener(queues=&#123;&quot;hello-java-queue&quot;&#125;)</span>放在类上</span><br><span class="line">       <span class="meta">@RabbitHandler</span>：标在方法上【作用：重载处理不同类型的数据】</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227230904.png" alt="1598623702380"></p><p>接受消息代码：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227230907.png" alt="1598624514669"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227230911.png" alt="1598627460409"></p><h3 id="RabbitMQ-消息确认机制"><a href="#RabbitMQ-消息确认机制" class="headerlink" title="RabbitMQ 消息确认机制"></a>RabbitMQ 消息确认机制</h3><blockquote><p><strong>RabbitMQ 消息确认机制-可靠抵达【手动确认+拒绝（拒绝的进入死信路由）】</strong></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227231023.png" alt="1598625968345"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">事务消息：发送返回【信息才到达】</span><br><span class="line"></span><br><span class="line">保证消息不丢失，可靠抵达，可以使用事务消息，性能下降<span class="number">250</span>倍，为此引入 确认机制</span><br><span class="line">	发送端确认机制： 两个：</span><br><span class="line">	publisher confirmCallback 确认模式【如果投递到Broker了，回调confirmCallback方法】</span><br><span class="line">	publisher returnCallback未投递到queue 退回模式【如果没有投递到queue，调用returnCallback】</span><br><span class="line"></span><br><span class="line">    消费端确认机制：【消费者收到消息，给服务器发送确认，服务器删除该消息】</span><br><span class="line">	consumer ack机制（消息确认机制）【让Broker知道哪些消息被消费者正确消费了（如果没有则重新投递）】</span><br><span class="line">    	<span class="number">1</span>、默认是自动确认的，只要消息接收到，客户端会自动确认，服务端会移除这个消息</span><br><span class="line">    	BUG：消息丢失，消费者监听队列【所有消息会一次性发送到通道，所以自动确认宕机会导致消息丢失】</span><br><span class="line">    	<span class="number">2</span>、手动确认：处理一个确认一个【否则是未签收状态，服务器宕机则会重新进入ready状态不会丢失】</span><br><span class="line">    	参数<span class="number">1</span>：消息下标，参数<span class="number">2</span>：是否批量签收</span><br><span class="line">    	签收：channel.basicAck(message.getMessageProperties().getDeliverTag(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">最终解决方案：确认机制+本地事务表</span><br><span class="line"><span class="number">1</span>、发送消息的时候生成消息ID，然后在回调方法里面修改数据库里消息的状态</span><br><span class="line"><span class="number">2</span>、定时扫描数据库消息的状态，没有成功的重新投递一次</span><br><span class="line"><span class="number">3</span>、消费消息时使用手动签收机制【不要使用自动签收】</span><br><span class="line"></span><br><span class="line">配置：</span><br><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">    port: <span class="number">5672</span></span><br><span class="line">#    虚拟主机</span><br><span class="line">    virtual-host: /</span><br><span class="line">#    开启发送端抵达队列确认【发送端确认机制+本地事务表】</span><br><span class="line">    publisher-returns: <span class="literal">true</span></span><br><span class="line">#    开启发送确认【发送端确认机制+本地事务表】</span><br><span class="line">    publisher-confirm-type: correlated</span><br><span class="line">#    只要抵达队列，优先回调<span class="keyword">return</span> confirm</span><br><span class="line">    template:</span><br><span class="line">      mandatory: <span class="literal">true</span></span><br><span class="line">#    使用手动确认模式，关闭自动确认【消息丢失】</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定制RabbitTemplate</span></span><br><span class="line"><span class="comment">     * 1、服务收到消息就会回调</span></span><br><span class="line"><span class="comment">     *      1、spring.rabbitmq.publisher-confirms: true</span></span><br><span class="line"><span class="comment">     *      2、设置确认回调</span></span><br><span class="line"><span class="comment">     * 2、消息正确抵达队列就会进行回调</span></span><br><span class="line"><span class="comment">     *      1、spring.rabbitmq.publisher-returns: true</span></span><br><span class="line"><span class="comment">     *         spring.rabbitmq.template.mandatory: true</span></span><br><span class="line"><span class="comment">     *      2、设置确认回调ReturnCallback</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3、消费端确认(保证每个消息都被正确消费，此时才可以broker删除这个消息)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span>  <span class="comment">//MyRabbitConfig对象创建完成以后，执行这个方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRabbitTemplate</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1、只要消息抵达Broker就ack=true</span></span><br><span class="line"><span class="comment">         * correlationData：当前消息的唯一关联数据(这个是消息的唯一id)</span></span><br><span class="line"><span class="comment">         * ack：消息是否成功收到</span></span><br><span class="line"><span class="comment">         * cause：失败的原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//设置确认回调</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback((correlationData,ack,cause) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;confirm...correlationData[&quot;</span>+correlationData+<span class="string">&quot;]==&gt;ack:[&quot;</span>+ack+<span class="string">&quot;]==&gt;cause:[&quot;</span>+cause+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只要消息没有投递给指定的队列，就触发这个失败回调</span></span><br><span class="line"><span class="comment">         * message：投递失败的消息详细信息</span></span><br><span class="line"><span class="comment">         * replyCode：回复的状态码</span></span><br><span class="line"><span class="comment">         * replyText：回复的文本内容</span></span><br><span class="line"><span class="comment">         * exchange：当时这个消息发给哪个交换机</span></span><br><span class="line"><span class="comment">         * routingKey：当时这个消息用哪个路邮键</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message,replyCode,replyText,exchange,routingKey) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Fail Message[&quot;</span>+message+<span class="string">&quot;]==&gt;replyCode[&quot;</span>+replyCode+<span class="string">&quot;]&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;==&gt;replyText[&quot;</span>+replyText+<span class="string">&quot;]==&gt;exchange[&quot;</span>+exchange+<span class="string">&quot;]==&gt;routingKey[&quot;</span>+routingKey+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用方法：</span><br><span class="line">监听队列的方法参数上加上通道Channel</span><br><span class="line">然后channel 签收或拒绝 ack/reject（成为死信）</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227231039.png" alt="1598626298129"><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227231042.png" alt="1598626838638"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202204082327409.png" alt="1598627865733"></p><p>消费者消费：</p><p>签收+拒收【并返回服务器入队】multiple：批量签收，requeue：是否重新入队</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211227231132.png" alt="image-20211227231131739"></p><h2 id="四、项目搭建"><a href="#四、项目搭建" class="headerlink" title="四、项目搭建"></a>四、项目搭建</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1、等待付款（详情页）/mydata/nginx/html/static/order/detail</span><br><span class="line"></span><br><span class="line">2、订单页（订单列表页）/mydata/nginx/html/static/order/list</span><br><span class="line"></span><br><span class="line">3、结算页（订单确认页）/mydata/nginx/html/static/order/confirm</span><br><span class="line"></span><br><span class="line">4、收银页（支付页）/mydata/nginx/html/static/order/pay</span><br><span class="line"></span><br><span class="line"><span class="params">#</span> gulimall</span><br><span class="line">192.168.56.10 gulimall.com</span><br><span class="line">192.168.56.10 search.gulimall.com</span><br><span class="line">192.168.56.10 item.gulimall.com</span><br><span class="line">192.168.56.10 auth.gulimall.com</span><br><span class="line">192.168.56.10 cart.gulimall.com</span><br><span class="line">192.168.56.10 order.gulimall.com</span><br><span class="line"></span><br><span class="line">127.0.0.1 ssoserver.com</span><br><span class="line">127.0.0.1 client1.com</span><br><span class="line">127.0.0.1 client2.com</span><br><span class="line"></span><br><span class="line"><span class="params">#</span>网关</span><br><span class="line">      - id: gulimall<span class="built_in">_</span>order<span class="built_in">_</span>route</span><br><span class="line">        uri: lb://gulimall-order</span><br><span class="line">        predicates:</span><br><span class="line">        - Host=order.gulimall.com</span><br></pre></td></tr></table></figure><p>等待付款，详情页：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211228232522.png" alt="1598667020590"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211228232525.png" alt="1598667039261"></p><hr><p>订单页：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211228232529.png" alt="1598667069559"></p><hr><p>结算页，订单确认页：</p><p><img src="/img/loading.gif" data-lazy-src="D:/Typora/cache/1598667130041.png" alt="1598667130041"></p><hr><p>收银页：</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211228232532.png" alt="1598667165660"></p><h2 id="五、订单服务"><a href="#五、订单服务" class="headerlink" title="五、订单服务"></a>五、订单服务</h2><h3 id="1、订单流程"><a href="#1、订单流程" class="headerlink" title="1、订单流程"></a>1、订单流程</h3><p>订单生成 -&gt; 支付订单 -&gt; 卖家发货 -&gt; 确认收货 -&gt; 交易成功</p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/20211228232743.png" style="zoom:38%"><h3 id="2、登录拦截"><a href="#2、登录拦截" class="headerlink" title="2、登录拦截"></a>2、登录拦截</h3><p>因为订单系统必然涉及到用户信息，因此进入订单系统的请求必须是已经登录的，所以我们必须通过拦截器对为登录订单请求进行拦截</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;MemberResponseVo&gt; loginUser = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> (MemberResponseVo) session.getAttribute(AuthServerConstant.LOGIN_USER);</span><br><span class="line">        <span class="keyword">if</span>(memberResponseVo != <span class="literal">null</span>)&#123;</span><br><span class="line">            loginUser.set(memberResponseVo);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            session.setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line">            response.sendRedirect(<span class="string">&quot;http://auth.gulimall.com/login.html&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallWebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(loginInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、订单确认页"><a href="#3、订单确认页" class="headerlink" title="3、订单确认页"></a>3、订单确认页</h3><h4 id="3-1-模型抽取"><a href="#3-1-模型抽取" class="headerlink" title="3.1 模型抽取"></a>3.1 模型抽取</h4><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202201052240377.png" style="zoom:38%"><p>跳转到确认页时需要携带的数据模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConfirmVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 会员收获地址列表 **/</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MemberAddressVo&gt; memberAddressVos;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 所有选中的购物项 **/</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderItemVo&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 发票记录 **/</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 优惠券（会员积分） **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer integration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 防止重复提交的令牌 **/</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String orderToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    Map&lt;Long,Boolean&gt; stocks;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo item : items) &#123;</span><br><span class="line">                count += item.getCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单总额 **/</span></span><br><span class="line">    <span class="comment">//BigDecimal total;</span></span><br><span class="line">    <span class="comment">//计算订单总额</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalNum</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo item : items) &#123;</span><br><span class="line">                <span class="comment">//计算当前商品的总价格</span></span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">itemPrice</span> <span class="operator">=</span> item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount().toString()));</span><br><span class="line">                <span class="comment">//再计算全部商品的总价格</span></span><br><span class="line">                totalNum = totalNum.add(itemPrice);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> totalNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 应付价格 **/</span></span><br><span class="line">    <span class="comment">//BigDecimal payPrice;</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getPayPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getTotal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-数据获取"><a href="#3-2-数据获取" class="headerlink" title="3.2 数据获取"></a>3.2 数据获取</h4><ul><li>查询购物项、库存和收货地址都要远程调用远程服务，串行会浪费大量时间，因此我们使用 <code>CompletableFuture</code> 进行异步编排</li><li>可能由于延迟，订单提交按钮可能被点击多次，为了防止重复提交的问题，我们在返回订单确认页时，在 <code>redis</code> 中生成一个随机的令牌，过期时间为 30min，提交的订单会携带这个令牌，我们将会在订单提交的处理页面核验令牌。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/toTrade&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toTrade</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    <span class="type">OrderConfirmVo</span> <span class="variable">confirmVo</span> <span class="operator">=</span> orderService.confirmOrder();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;confirmOrder&quot;</span>, confirmVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;confirm&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderConfirmVo <span class="title function_">confirmOrder</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">    <span class="type">OrderConfirmVo</span> <span class="variable">orderConfirmVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderConfirmVo</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO :获取当前线程请求头信息(解决Feign异步调用丢失请求头问题)</span></span><br><span class="line">    <span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启第一个异步任务</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; addressFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每个线程都来共享之前的请求数据</span></span><br><span class="line">        RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、远程查询所有的收获地址列表</span></span><br><span class="line">        List&lt;MemberAddressVo&gt; address = memberFeignService.getAddress(memberResponseVo.getId());</span><br><span class="line">        orderConfirmVo.setMemberAddressVos(address);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; cartInfoFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每个线程都来功享之前的请求数据</span></span><br><span class="line">        RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查出所有选中购物项</span></span><br><span class="line">        List&lt;OrderItemVo&gt; checkedItems = cartFeignService.getCurrentCartItems();</span><br><span class="line">        orderConfirmVo.setItems(checkedItems);</span><br><span class="line">        <span class="comment">// fegin在远程调用之前要构造请求，调用很多的拦截器</span></span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、查询用户积分</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">integration</span> <span class="operator">=</span> memberResponseVo.getIntegration();</span><br><span class="line">    orderConfirmVo.setIntegeration(integration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、价格数据自动计算</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 5、防重令牌(防止表单重复提交)</span></span><br><span class="line">    <span class="comment">// 为用户设置一个token，三十分钟过期时间（存在redis）</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX+memberResponseVo.getId(),token,<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    orderConfirmVo.setOrderToken(token);</span><br><span class="line"></span><br><span class="line">    CompletableFuture.allOf(addressFuture,cartInfoFuture).get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderConfirmVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-Feign-远程调用丢失请求头问题"><a href="#3-3-Feign-远程调用丢失请求头问题" class="headerlink" title="3.3 Feign 远程调用丢失请求头问题"></a>3.3 Feign 远程调用丢失请求头问题</h4><p><code>feign</code>远程调用的请求头中没有含有<code>JSESSIONID</code>的<code>cookie</code>，所以也就不能得到服务端的<code>session</code>数据，cart 认为没登录，获取不了用户信息</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202201092350688.png"></p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202201092350629.png" style="zoom:50%"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Request <span class="title function_">targetRequest</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) &#123;</span><br><span class="line">    interceptor.apply(template);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> target.apply(template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是在<code>feign</code>的调用过程中，会使用容器中的<code>RequestInterceptor</code>对<code>RequestTemplate</code>进行处理，因此我们可以通过向容器中导入定制的<code>RequestInterceptor</code>为请求加上<code>cookie</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuliFeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">                <span class="comment">//1. 使用RequestContextHolder拿到老请求的请求数据</span></span><br><span class="line">                <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">                <span class="keyword">if</span> (requestAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">                    <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//2. 将老请求得到cookie信息放到feign请求上</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">                        template.header(<span class="string">&quot;Cookie&quot;</span>, cookie);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>RequestContextHolder</code>为 SpingMVC 中共享<code>request</code>数据的上下文，底层由<code>ThreadLocal</code>实现</li></ul><p>经过<code>RequestInterceptor</code>处理后的请求如下，已经加上了请求头的<code>Cookie</code>信息</p><img src="/img/loading.gif" data-lazy-src="F:/OY项目/gulimall-learning/docs/images/Snipaste_2020-10-10_21-55-45.png" style="zoom:50%"><h4 id="3-4-Feign-异步情况丢失上下文问题"><a href="#3-4-Feign-异步情况丢失上下文问题" class="headerlink" title="3.4 Feign 异步情况丢失上下文问题"></a>3.4 Feign 异步情况丢失上下文问题</h4><img src="/img/loading.gif" data-lazy-src="F:/OY项目/gulimall-learning/docs/images/Snipaste_2020-10-10_22-08-32.png" style="zoom:38%"><ul><li>由于<code>RequestContextHolder</code>使用<code>ThreadLocal</code>共享数据，所以在开启异步时获取不到老请求的信息，自然也就无法共享<code>cookie</code>了</li></ul><p>在这种情况下，我们需要在开启异步的时候将老请求的<code>RequestContextHolder</code>的数据设置进去</p><img src="/img/loading.gif" data-lazy-src="F:/OY项目/gulimall-learning/docs/images/Snipaste_2020-10-10_22-13-47.png" style="zoom:67%"><h4 id="3-5-运费收件信息获取"><a href="#3-5-运费收件信息获取" class="headerlink" title="3.5 运费收件信息获取"></a>3.5 运费收件信息获取</h4><p>数据封装</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FareVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MemberAddressVo address;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal fare;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在页面将选中地址的 id 传给请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/fare/&#123;addrId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> FareVo <span class="title function_">getFare</span><span class="params">(<span class="meta">@PathVariable(&quot;addrId&quot;)</span> Long addrId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> wareInfoService.getFare(addrId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FareVo <span class="title function_">getFare</span><span class="params">(Long addrId)</span> &#123;</span><br><span class="line">    <span class="type">FareVo</span> <span class="variable">fareVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FareVo</span>();</span><br><span class="line">    <span class="type">R</span> <span class="variable">info</span> <span class="operator">=</span> memberFeignService.info(addrId);</span><br><span class="line">    <span class="keyword">if</span> (info.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">MemberAddressVo</span> <span class="variable">address</span> <span class="operator">=</span> info.getData(<span class="string">&quot;memberReceiveAddress&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;MemberAddressVo&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        fareVo.setAddress(address);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> address.getPhone();</span><br><span class="line">        <span class="comment">//取电话号的最后两位作为邮费</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fare</span> <span class="operator">=</span> phone.substring(phone.length() - <span class="number">2</span>, phone.length());</span><br><span class="line">        fareVo.setFare(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(fare));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fareVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、订单提交"><a href="#4、订单提交" class="headerlink" title="4、订单提交"></a>4、订单提交</h3><h4 id="4-1-模型抽取"><a href="#4-1-模型抽取" class="headerlink" title="4.1 模型抽取"></a>4.1 模型抽取</h4><p>页面提交数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSubmitVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 收获地址的id **/</span></span><br><span class="line">    <span class="keyword">private</span> Long addrId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 支付方式 **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer payType;</span><br><span class="line">    <span class="comment">//无需提交要购买的商品，去购物车再获取一遍</span></span><br><span class="line">    <span class="comment">//优惠、发票</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 防重令牌 **/</span></span><br><span class="line">    <span class="keyword">private</span> String orderToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 应付价格 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单备注 **/</span></span><br><span class="line">    <span class="keyword">private</span> String remarks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户相关的信息，直接去session中取出即可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功后转发至支付页面携带数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubmitOrderResponseVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderEntity order;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 错误状态码 **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-提交订单"><a href="#4-2-提交订单" class="headerlink" title="4.2 提交订单"></a>4.2 提交订单</h4><ul><li>提交订单成功，则携带返回数据转发至支付页面</li><li>提交订单失败，则携带错误信息重定向至确认页</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/submitOrder&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo, Model model, RedirectAttributes attributes)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        SubmitOrderResponseVo responseVo=orderService.submitOrder(submitVo);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> responseVo.getCode();</span><br><span class="line">        <span class="keyword">if</span> (code==<span class="number">0</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;order&quot;</span>, responseVo.getOrder());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;pay&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;下单失败;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    msg += <span class="string">&quot;防重令牌校验失败&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    msg += <span class="string">&quot;商品价格发生变化&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NoStockException)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;下单失败，商品无库存&quot;</span>;</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">        <span class="type">SubmitOrderResponseVo</span> <span class="variable">responseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubmitOrderResponseVo</span>();</span><br><span class="line">        responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//1. 验证防重令牌</span></span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">        String script= <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script,Long.class), Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()), submitVo.getOrderToken());</span><br><span class="line">        <span class="keyword">if</span> (execute == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="comment">//1.1 防重令牌验证失败</span></span><br><span class="line">            responseVo.setCode(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> responseVo;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//2. 创建订单、订单项</span></span><br><span class="line">            <span class="type">OrderCreateTo</span> <span class="variable">order</span> <span class="operator">=</span>createOrderTo(memberResponseVo,submitVo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3. 验价</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> order.getOrder().getPayAmount();</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> submitVo.getPayPrice();</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(payAmount.subtract(payPrice).doubleValue()) &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">                <span class="comment">//4. 保存订单</span></span><br><span class="line">                saveOrder(order);</span><br><span class="line">                <span class="comment">//5. 锁定库存</span></span><br><span class="line">                List&lt;OrderItemVo&gt; orderItemVos = order.getOrderItems().stream().map((item) -&gt; &#123;</span><br><span class="line">                    <span class="type">OrderItemVo</span> <span class="variable">orderItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemVo</span>();</span><br><span class="line">                    orderItemVo.setSkuId(item.getSkuId());</span><br><span class="line">                    orderItemVo.setCount(item.getSkuQuantity());</span><br><span class="line">                    <span class="keyword">return</span> orderItemVo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">                <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> wareFeignService.orderLockStock(orderItemVos);</span><br><span class="line">                <span class="comment">//5.1 锁定库存成功</span></span><br><span class="line">                <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//                    int i = 10 / 0;</span></span><br><span class="line">                    responseVo.setOrder(order.getOrder());</span><br><span class="line">                    responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">return</span> responseVo;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//5.1 锁定库存失败</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(msg);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//验价失败</span></span><br><span class="line">                responseVo.setCode(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> responseVo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="1-验证防重令牌"><a href="#1-验证防重令牌" class="headerlink" title="1.验证防重令牌"></a>1.验证防重令牌</h5><p>为防止在获取令牌、对比值和删除令牌之间发生错误导入令牌校验出错，我们必须使用脚本保证原子性操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">String script= <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line"><span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script,Long.class), Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()), submitVo.getOrderToken());</span><br><span class="line"><span class="keyword">if</span> (execute == <span class="number">0L</span>) &#123;</span><br><span class="line">    <span class="comment">//1.1 防重令牌验证失败</span></span><br><span class="line">    responseVo.setCode(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> responseVo;</span><br></pre></td></tr></table></figure><h5 id="2-创建订单、订单项"><a href="#2-创建订单、订单项" class="headerlink" title="2.创建订单、订单项"></a>2.创建订单、订单项</h5><blockquote><p>抽取模型</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCreateTo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderEntity order;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderItemEntity&gt; orderItems;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单计算的应付价格 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 运费 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal fare;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>创建订单、订单项</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2. 创建订单、订单项</span></span><br><span class="line"><span class="type">OrderCreateTo</span> <span class="variable">order</span> <span class="operator">=</span>createOrderTo(memberResponseVo,submitVo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OrderCreateTo <span class="title function_">createOrderTo</span><span class="params">(MemberResponseVo memberResponseVo, OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">    <span class="comment">//2.1 用IdWorker生成订单号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> IdWorker.getTimeId();</span><br><span class="line">    <span class="comment">//2.2 构建订单</span></span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">entity</span> <span class="operator">=</span> buildOrder(memberResponseVo, submitVo,orderSn);</span><br><span class="line">    <span class="comment">//2.3 构建订单项</span></span><br><span class="line">    List&lt;OrderItemEntity&gt; orderItemEntities = buildOrderItems(orderSn);</span><br><span class="line">    <span class="comment">//2.4 计算价格</span></span><br><span class="line">    compute(entity, orderItemEntities);</span><br><span class="line">    <span class="type">OrderCreateTo</span> <span class="variable">createTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderCreateTo</span>();</span><br><span class="line">    createTo.setOrder(entity);</span><br><span class="line">    createTo.setOrderItems(orderItemEntities);</span><br><span class="line">    <span class="keyword">return</span> createTo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>构建订单</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OrderEntity <span class="title function_">buildOrder</span><span class="params">(MemberResponseVo memberResponseVo, OrderSubmitVo submitVo, String orderSn)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">OrderEntity</span>();</span><br><span class="line"></span><br><span class="line">        orderEntity.setOrderSn(orderSn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1) 设置用户信息</span></span><br><span class="line">        orderEntity.setMemberId(memberResponseVo.getId());</span><br><span class="line">        orderEntity.setMemberUsername(memberResponseVo.getUsername());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2) 获取邮费和收件人信息并设置</span></span><br><span class="line">        <span class="type">FareVo</span> <span class="variable">fareVo</span> <span class="operator">=</span> wareFeignService.getFare(submitVo.getAddrId());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">fare</span> <span class="operator">=</span> fareVo.getFare();</span><br><span class="line">        orderEntity.setFreightAmount(fare);</span><br><span class="line">        <span class="type">MemberAddressVo</span> <span class="variable">address</span> <span class="operator">=</span> fareVo.getAddress();</span><br><span class="line">        orderEntity.setReceiverName(address.getName());</span><br><span class="line">        orderEntity.setReceiverPhone(address.getPhone());</span><br><span class="line">        orderEntity.setReceiverPostCode(address.getPostCode());</span><br><span class="line">        orderEntity.setReceiverProvince(address.getProvince());</span><br><span class="line">        orderEntity.setReceiverCity(address.getCity());</span><br><span class="line">        orderEntity.setReceiverRegion(address.getRegion());</span><br><span class="line">        orderEntity.setReceiverDetailAddress(address.getDetailAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3) 设置订单相关的状态信息</span></span><br><span class="line">        orderEntity.setStatus(OrderStatusEnum.CREATE_NEW.getCode());</span><br><span class="line">        orderEntity.setConfirmStatus(<span class="number">0</span>);</span><br><span class="line">        orderEntity.setAutoConfirmDay(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderEntity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>构建订单项</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OrderItemEntity <span class="title function_">buildOrderItem</span><span class="params">(OrderItemVo item)</span> &#123;</span><br><span class="line">        <span class="type">OrderItemEntity</span> <span class="variable">orderItemEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemEntity</span>();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> item.getSkuId();</span><br><span class="line">        <span class="comment">//1) 设置sku相关属性</span></span><br><span class="line">        orderItemEntity.setSkuId(skuId);</span><br><span class="line">        orderItemEntity.setSkuName(item.getTitle());</span><br><span class="line">        orderItemEntity.setSkuAttrsVals(StringUtils.collectionToDelimitedString(item.getSkuAttrValues(), <span class="string">&quot;;&quot;</span>));</span><br><span class="line">        orderItemEntity.setSkuPic(item.getImage());</span><br><span class="line">        orderItemEntity.setSkuPrice(item.getPrice());</span><br><span class="line">        orderItemEntity.setSkuQuantity(item.getCount());</span><br><span class="line">        <span class="comment">//2) 通过skuId查询spu相关属性并设置</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.getSpuBySkuId(skuId);</span><br><span class="line">        <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">SpuInfoTo</span> <span class="variable">spuInfo</span> <span class="operator">=</span> r.getData(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SpuInfoTo&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            orderItemEntity.setSpuId(spuInfo.getId());</span><br><span class="line">            orderItemEntity.setSpuName(spuInfo.getSpuName());</span><br><span class="line">            orderItemEntity.setSpuBrand(spuInfo.getBrandName());</span><br><span class="line">            orderItemEntity.setCategoryId(spuInfo.getCatalogId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3) 商品的优惠信息(不做)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4) 商品的积分成长，为价格x数量</span></span><br><span class="line">        orderItemEntity.setGiftGrowth(item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount())).intValue());</span><br><span class="line">        orderItemEntity.setGiftIntegration(item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount())).intValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5) 订单项订单价格信息</span></span><br><span class="line">        orderItemEntity.setPromotionAmount(BigDecimal.ZERO);</span><br><span class="line">        orderItemEntity.setCouponAmount(BigDecimal.ZERO);</span><br><span class="line">        orderItemEntity.setIntegrationAmount(BigDecimal.ZERO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6) 实际价格</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">origin</span> <span class="operator">=</span> orderItemEntity.getSkuPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(orderItemEntity.getSkuQuantity()));</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">realPrice</span> <span class="operator">=</span> origin.subtract(orderItemEntity.getPromotionAmount())</span><br><span class="line">                .subtract(orderItemEntity.getCouponAmount())</span><br><span class="line">                .subtract(orderItemEntity.getIntegrationAmount());</span><br><span class="line">        orderItemEntity.setRealAmount(realPrice);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderItemEntity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>计算订单价格</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(OrderEntity entity, List&lt;OrderItemEntity&gt; orderItemEntities)</span> &#123;</span><br><span class="line">        <span class="comment">//总价</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">        <span class="comment">//优惠价格</span></span><br><span class="line">        BigDecimal promotion=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        BigDecimal integration=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        BigDecimal coupon=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        <span class="comment">//积分</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">integrationTotal</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">growthTotal</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (OrderItemEntity orderItemEntity : orderItemEntities) &#123;</span><br><span class="line">            total=total.add(orderItemEntity.getRealAmount());</span><br><span class="line">            promotion=promotion.add(orderItemEntity.getPromotionAmount());</span><br><span class="line">            integration=integration.add(orderItemEntity.getIntegrationAmount());</span><br><span class="line">            coupon=coupon.add(orderItemEntity.getCouponAmount());</span><br><span class="line">            integrationTotal += orderItemEntity.getGiftIntegration();</span><br><span class="line">            growthTotal += orderItemEntity.getGiftGrowth();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entity.setTotalAmount(total);</span><br><span class="line">        entity.setPromotionAmount(promotion);</span><br><span class="line">        entity.setIntegrationAmount(integration);</span><br><span class="line">        entity.setCouponAmount(coupon);</span><br><span class="line">        entity.setIntegration(integrationTotal);</span><br><span class="line">        entity.setGrowth(growthTotal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//付款价格=商品价格+运费</span></span><br><span class="line">        entity.setPayAmount(entity.getFreightAmount().add(total));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置删除状态(0-未删除，1-已删除)</span></span><br><span class="line">        entity.setDeleteStatus(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="3-验价"><a href="#3-验价" class="headerlink" title="3.验价"></a>3.验价</h5><p>将页面提交的价格和后台计算的价格进行对比，若不同则提示用户<code>商品价格发生变化</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> order.getOrder().getPayAmount();</span><br><span class="line"><span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> submitVo.getPayPrice();</span><br><span class="line"><span class="keyword">if</span> (Math.abs(payAmount.subtract(payPrice).doubleValue()) &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">			<span class="comment">/****************/</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//验价失败</span></span><br><span class="line">    responseVo.setCode(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> responseVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-保存订单"><a href="#4-保存订单" class="headerlink" title="4.保存订单"></a>4.保存订单</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveOrder</span><span class="params">(OrderCreateTo orderCreateTo)</span> &#123;</span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">order</span> <span class="operator">=</span> orderCreateTo.getOrder();</span><br><span class="line">    order.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    order.setModifyTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="built_in">this</span>.save(order);</span><br><span class="line">    orderItemService.saveBatch(orderCreateTo.getOrderItems());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-锁定库存"><a href="#5-锁定库存" class="headerlink" title="5.锁定库存"></a>5.锁定库存</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrderItemVo&gt; orderItemVos = order.getOrderItems().stream().map((item) -&gt; &#123;</span><br><span class="line">                   <span class="type">OrderItemVo</span> <span class="variable">orderItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemVo</span>();</span><br><span class="line">                   orderItemVo.setSkuId(item.getSkuId());</span><br><span class="line">                   orderItemVo.setCount(item.getSkuQuantity());</span><br><span class="line">                   <span class="keyword">return</span> orderItemVo;</span><br><span class="line">               &#125;).collect(Collectors.toList());</span><br><span class="line">               <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> wareFeignService.orderLockStock(orderItemVos);</span><br><span class="line">               <span class="comment">//5.1 锁定库存成功</span></span><br><span class="line">               <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>)&#123;</span><br><span class="line">                   responseVo.setOrder(order.getOrder());</span><br><span class="line">                   responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">return</span> responseVo;</span><br><span class="line">               &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//5.2 锁定库存失败</span></span><br><span class="line">                   <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(msg);</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure><ul><li>找出所有库存大于商品数的仓库</li><li>遍历所有满足条件的仓库，逐个尝试锁库存，若锁库存成功则退出遍历</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/lock/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">orderLockStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderItemVo&gt; itemVos)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> wareSkuService.orderLockStock(itemVos);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoStockException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnum.NO_STOCK_EXCEPTION.getCode(), BizCodeEnum.NO_STOCK_EXCEPTION.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">orderLockStock</span><span class="params">(List&lt;OrderItemVo&gt; itemVos)</span> &#123;</span><br><span class="line">    List&lt;SkuLockVo&gt; lockVos = itemVos.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">SkuLockVo</span> <span class="variable">skuLockVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLockVo</span>();</span><br><span class="line">        skuLockVo.setSkuId(item.getSkuId());</span><br><span class="line">        skuLockVo.setNum(item.getCount());</span><br><span class="line">        <span class="comment">//找出所有库存大于商品数的仓库</span></span><br><span class="line">        List&lt;Long&gt; wareIds = baseMapper.listWareIdsHasStock(item.getSkuId(), item.getCount());</span><br><span class="line">        skuLockVo.setWareIds(wareIds);</span><br><span class="line">        <span class="keyword">return</span> skuLockVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SkuLockVo lockVo : lockVos) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> lockVo.getSkuId();</span><br><span class="line">        List&lt;Long&gt; wareIds = lockVo.getWareIds();</span><br><span class="line">        <span class="comment">//如果没有满足条件的仓库，抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (wareIds == <span class="literal">null</span> || wareIds.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long wareId : wareIds) &#123;</span><br><span class="line">                Long count=baseMapper.lockWareSku(skuId, lockVo.getNum(), wareId);</span><br><span class="line">                <span class="keyword">if</span> (count==<span class="number">0</span>)&#123;</span><br><span class="line">                    lock=<span class="literal">false</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    lock = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!lock) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里通过异常机制控制事务回滚，如果在锁定库存失败则抛出<code>NoStockExceptions</code>,订单服务和库存服务都会回滚。</p><h2 id="六、分布式事务"><a href="#六、分布式事务" class="headerlink" title="六、分布式事务"></a>六、分布式事务</h2><h3 id="1、分布式事务"><a href="#1、分布式事务" class="headerlink" title="1、分布式事务"></a>1、分布式事务</h3><h3 id="2、整合-Spring-cloud-alibaba-Seata"><a href="#2、整合-Spring-cloud-alibaba-Seata" class="headerlink" title="2、整合 Spring cloud alibaba Seata"></a>2、整合 Spring cloud alibaba Seata</h3><blockquote><p>在 common 添加依赖</p></blockquote><p>seata-all 使用 0.9【所以启动 事务协调者 0.9 版本的】</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--seata 分布式事务--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>2、使用一个 @GlobalTransactional 注解在业务方法上【TM 事务管理器上】<br>资源管理器上只需要标注@Transactional 就可以了【各远程方法】</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>3、各数据库上创建表</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><blockquote><p>安装 事务协调器：seata-server-1.3.0.zip<br>从 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases,%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BD%AF%E4%BB%B6%E5%8C%85%EF%BC%8C%E5%B0%86%E5%85%B6%E8%A7%A3%E5%8E%8B%E7%BC%A9%E3%80%82">https://github.com/seata/seata/releases,下载服务器软件包，将其解压缩。</a></p></blockquote><blockquote><p>5、修改事务协调器的配置 registry.conf</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1）把自己注册到nacos，并且设置nacos的url</span><br><span class="line">registry &#123;</span><br><span class="line">	# file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line"> 		type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2）配置放在file【也可以在nacos上】</span><br><span class="line">config &#123;</span><br><span class="line"> 		# file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line"> 		type = &quot;file&quot;</span><br></pre></td></tr></table></figure><h2 id="七、使用消息队列实现最终一致性"><a href="#七、使用消息队列实现最终一致性" class="headerlink" title="七、使用消息队列实现最终一致性"></a>七、使用消息队列实现最终一致性</h2><h3 id="1、延迟队列的定义与实现"><a href="#1、延迟队列的定义与实现" class="headerlink" title="1、延迟队列的定义与实现"></a>1、延迟队列的定义与实现</h3><ul><li><p>定义:</p><p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息” 是指消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个进行消费。</p></li><li><p>实现：</p><p>RabbitMQ 可以通过设置队列的 <code>TTL</code> 和 死信路由实现延迟队列</p><ul><li>TTL：</li></ul><blockquote><p>RabbitMQ 可以正确 Queue 设置 x-expires 或者 针对 Message 设置 x-message-ttl, 来控制消息的生存时间。如果超时（两者同时设置以最先到期的时间为准），则消息变为 dead letter（死信）</p></blockquote><ul><li>死信路由 DLX</li></ul><blockquote><p>RabbitMQ 的 Queue 可以配置 x-dead-letter-exchange 和 x-dead-letter-router-key（可选）两个参数，如果队列内出现了 dead letter, 则按照这两个参数重新路由转发到指定的队列。</p><ul><li>x-dead-letter-exchange：出现 dead letter 之后将 dead letter 重新发送到指定 exchange</li><li>x-dead-letter-routing-key: 出现 dead letter 之后将 dead letter 重新按照指定的 routing-key 发送</li></ul></blockquote></li></ul><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203172308456.png" style="zoom:50%"><p>针对订单创建以上消息队列，创建订单时消息会被发送至队列 <code>order.delay.queue</code> , 经过 TTL 的时间后消息会变成死信以 order.release.order 的路由键经交换机转发至队列 <code>order.release.order.queue</code> ，在通过监听该队列的消息来实现过期订单的处理。</p><h3 id="2、延迟队列使用场景"><a href="#2、延迟队列使用场景" class="headerlink" title="2、延迟队列使用场景"></a>2、延迟队列使用场景</h3><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203172316643.png" style="zoom:25%"><p><strong>为什么不能用定时任务完成？</strong></p><p>如果恰好在一次扫描后完成业务逻辑，那么就会等待两个扫描周期才能扫到过期的订单，不能保证时效性</p><img src="/img/loading.gif" data-lazy-src="F:/OY项目/gulimall-learning/docs/images/Snipaste_2020-10-14_15-43-37.png" style="zoom:25%"><h3 id="3、-定时关单与库存解锁主体逻辑"><a href="#3、-定时关单与库存解锁主体逻辑" class="headerlink" title="3、 定时关单与库存解锁主体逻辑"></a>3、 定时关单与库存解锁主体逻辑</h3><ul><li>订单超时未支付触发订单过期状态修改与库存解锁</li></ul><blockquote><p>创建订单时消息会被发送至队列 <code>order.delay.queue</code> , 经过 TTL 的时间后消息会变成死信以 order.release.order 的路由键交换机转发至队列 order.release.order.queue, 在通过监听该队列的消息来实现过期订单的处理</p><ul><li>如果该订单已支付，则无需处理</li><li>否则说明该订单已过期，修改该订单的状态并通过并通过路由键 <code>order.release.other</code> 发送消息至队列 <code>stock.release.stock.queue</code> 进行库存解锁</li></ul></blockquote><ul><li>库存锁定后延迟检查是否需要解锁库存</li></ul><blockquote><p>在库存锁定后通过 <code>路由键 stock.locked</code> 发送至 <code>延迟队列stock.delay.queue</code> ， 延迟时间到，死信通过 <code>路由键stock.release</code> 转发至 stock.release.stock.queue， 通过监听该队列进行判断当前订单状态，来确认库存是否需要解锁</p></blockquote><ul><li>由于 <code>关闭订单</code> 和 <code>库存解锁</code> 都有可能被执行多次，因此要保证业务逻辑的幂等性，在执行业务是重新查询当前的状态进行判断</li><li>订单关闭和库存解锁都会进行库存解锁的操作，来确保业务异常或者订单过期时库存会被可靠解锁</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203182250331.png"></p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203182250997.png" style="zoom:67%"><h3 id="4、创建业务交换机和队列"><a href="#4、创建业务交换机和队列" class="headerlink" title="4、创建业务交换机和队列"></a>4、创建业务交换机和队列</h3><blockquote><p>订单模块</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitmqConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">orderEventExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *   String name,</span></span><br><span class="line"><span class="comment">         *   boolean durable,</span></span><br><span class="line"><span class="comment">         *   boolean autoDelete,</span></span><br><span class="line"><span class="comment">         *   Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">orderDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">            Queue(String name,  队列名字</span></span><br><span class="line"><span class="comment">            boolean durable,  是否持久化</span></span><br><span class="line"><span class="comment">            boolean exclusive,  是否排他</span></span><br><span class="line"><span class="comment">            boolean autoDelete, 是否自动删除</span></span><br><span class="line"><span class="comment">            Map&lt;String, Object&gt; arguments) 属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//死信交换机</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;order-event-exchange&quot;</span>);</span><br><span class="line">        <span class="comment">//死信路由键</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;order.release.order&quot;</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">60000</span>); <span class="comment">// 消息过期时间 1分钟</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;order.delay.queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通队列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">orderReleaseQueue</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;order.release.order.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单的binding</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderCreateBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * String destination, 目的地（队列名或者交换机名字）</span></span><br><span class="line"><span class="comment">         * DestinationType destinationType, 目的地类型（Queue、Exhcange）</span></span><br><span class="line"><span class="comment">         * String exchange,</span></span><br><span class="line"><span class="comment">         * String routingKey,</span></span><br><span class="line"><span class="comment">         * Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;order.delay.queue&quot;</span>, Binding.DestinationType.QUEUE, <span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.create.order&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderReleaseBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;order.release.order.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;order.release.order&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderReleaseOrderBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;order.release.other.#&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>库存模块</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitmqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">stockEventExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">&quot;stock-event-exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">stockDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;stock-event-exchange&quot;</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;stock.release&quot;</span>);</span><br><span class="line">        <span class="comment">// 消息过期时间 2分钟</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">120000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;stock.delay.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通队列，用于解锁库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">stockReleaseStockQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机和延迟队列绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">stockLockedBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.delay.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;stock-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stock.locked&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机和普通队列绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">stockReleaseBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;stock-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stock.release.#&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、库存自动解锁"><a href="#5、库存自动解锁" class="headerlink" title="5、库存自动解锁"></a>5、库存自动解锁</h3><h4 id="5-1-库存锁定"><a href="#5-1-库存锁定" class="headerlink" title="5.1 库存锁定"></a>5.1 库存锁定</h4><blockquote><p>在库存锁定是添加一下逻辑</p><ul><li>由于可能订单回滚的情况，所以为了能够得到库存锁定的信息，在锁定需要记录库存工作单，其中包括订单信息和锁定库存时的信息（仓库 id, 商品 id, 锁了几件….）</li><li>在锁定成功后，向延迟对队列发消息，带上库存锁定的相关信息</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">orderLockStock</span><span class="params">(WareSkuLockVo wareSkuLockVo)</span> &#123;</span><br><span class="line">    <span class="comment">//因为可能出现订单回滚后，库存锁定不回滚的情况，但订单已经回滚，得不到库存锁定信息，因此要有库存工作单</span></span><br><span class="line">    <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WareOrderTaskEntity</span>();</span><br><span class="line">    taskEntity.setOrderSn(wareSkuLockVo.getOrderSn());</span><br><span class="line">    taskEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    wareOrderTaskService.save(taskEntity);</span><br><span class="line"></span><br><span class="line">    List&lt;OrderItemVo&gt; itemVos = wareSkuLockVo.getLocks();</span><br><span class="line">    List&lt;SkuLockVo&gt; lockVos = itemVos.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">SkuLockVo</span> <span class="variable">skuLockVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLockVo</span>();</span><br><span class="line">        skuLockVo.setSkuId(item.getSkuId());</span><br><span class="line">        skuLockVo.setNum(item.getCount());</span><br><span class="line">        List&lt;Long&gt; wareIds = baseMapper.listWareIdsHasStock(item.getSkuId(), item.getCount());</span><br><span class="line">        skuLockVo.setWareIds(wareIds);</span><br><span class="line">        <span class="keyword">return</span> skuLockVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SkuLockVo lockVo : lockVos) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> lockVo.getSkuId();</span><br><span class="line">        List&lt;Long&gt; wareIds = lockVo.getWareIds();</span><br><span class="line">        <span class="keyword">if</span> (wareIds == <span class="literal">null</span> || wareIds.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long wareId : wareIds) &#123;</span><br><span class="line">                Long count=baseMapper.lockWareSku(skuId, lockVo.getNum(), wareId);</span><br><span class="line">                <span class="keyword">if</span> (count==<span class="number">0</span>)&#123;</span><br><span class="line">                    lock=<span class="literal">false</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//锁定成功，保存工作单详情</span></span><br><span class="line">                    <span class="type">WareOrderTaskDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> WareOrderTaskDetailEntity.builder()</span><br><span class="line">                            .skuId(skuId)</span><br><span class="line">                            .skuName(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                            .skuNum(lockVo.getNum())</span><br><span class="line">                            .taskId(taskEntity.getId())</span><br><span class="line">                            .wareId(wareId)</span><br><span class="line">                            .lockStatus(<span class="number">1</span>).build();</span><br><span class="line">                    wareOrderTaskDetailService.save(detailEntity);</span><br><span class="line">                    <span class="comment">//发送库存锁定消息至延迟队列</span></span><br><span class="line">                    <span class="type">StockLockedTo</span> <span class="variable">lockedTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StockLockedTo</span>();</span><br><span class="line">                    lockedTo.setId(taskEntity.getId());</span><br><span class="line">                    <span class="type">StockDetailTo</span> <span class="variable">detailTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StockDetailTo</span>();</span><br><span class="line">                    BeanUtils.copyProperties(detailEntity,detailTo);</span><br><span class="line">                    lockedTo.setDetailTo(detailTo);</span><br><span class="line">                    rabbitTemplate.convertAndSend(<span class="string">&quot;stock-event-exchange&quot;</span>,<span class="string">&quot;stock.locked&quot;</span>,lockedTo);</span><br><span class="line"></span><br><span class="line">                    lock = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!lock) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-监听队列"><a href="#5-2-监听队列" class="headerlink" title="5.2 监听队列"></a>5.2 监听队列</h4><ul><li>延迟队列会将过期的消息路由至<code>&quot;stock.release.stock.queue&quot;</code>,通过监听该队列实现库存的解锁</li><li>为保证消息的可靠到达，我们使用手动确认消息的模式，在解锁成功后确认消息，若出现异常则重新归队</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;stock.release.stock.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockReleaseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WareSkuService wareSkuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(StockLockedTo stockLockedTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(stockLockedTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-库存解锁"><a href="#5-3-库存解锁" class="headerlink" title="5.3 库存解锁"></a>5.3 库存解锁</h4><ul><li>如果工作单详情不为空，说明该库存锁定成功<ul><li>查询最新的订单状态，如果订单不存在，说明订单提交出现异常回滚，或者订单处于已取消的状态，我们都对已锁定的库存进行解锁</li></ul></li><li>如果工作单详情为空，说明库存未锁定，自然无需解锁</li><li>为保证幂等性，我们分别对订单的状态和工作单的状态都进行了判断，只有当订单过期且工作单显示当前库存处于锁定的状态时，才进行库存的解锁</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(StockLockedTo stockLockedTo)</span> &#123;</span><br><span class="line">       <span class="type">StockDetailTo</span> <span class="variable">detailTo</span> <span class="operator">=</span> stockLockedTo.getDetailTo();</span><br><span class="line">       <span class="type">WareOrderTaskDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> wareOrderTaskDetailService.getById(detailTo.getId());</span><br><span class="line">       <span class="comment">//1.如果工作单详情不为空，说明该库存锁定成功</span></span><br><span class="line">       <span class="keyword">if</span> (detailEntity != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> wareOrderTaskService.getById(stockLockedTo.getId());</span><br><span class="line">           <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> orderFeignService.infoByOrderSn(taskEntity.getOrderSn());</span><br><span class="line">           <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="type">OrderTo</span> <span class="variable">order</span> <span class="operator">=</span> r.getData(<span class="string">&quot;order&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;OrderTo&gt;() &#123;</span><br><span class="line">               &#125;);</span><br><span class="line">               <span class="comment">//没有这个订单||订单状态已经取消 解锁库存</span></span><br><span class="line">               <span class="keyword">if</span> (order == <span class="literal">null</span>||order.getStatus()== OrderStatusEnum.CANCLED.getCode()) &#123;</span><br><span class="line">                   <span class="comment">//为保证幂等性，只有当工作单详情处于被锁定的情况下才进行解锁</span></span><br><span class="line">                   <span class="keyword">if</span> (detailEntity.getLockStatus()== WareTaskStatusEnum.Locked.getCode())&#123;</span><br><span class="line">                       unlockStock(detailTo.getSkuId(), detailTo.getSkuNum(), detailTo.getWareId(), detailEntity.getId());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;远程调用订单服务失败&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//无需解锁</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="6、定时关单"><a href="#6、定时关单" class="headerlink" title="6、定时关单"></a>6、定时关单</h3><h4 id="6-1-提交订单"><a href="#6-1-提交订单" class="headerlink" title="6.1 提交订单"></a>6.1 提交订单</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提交订单的业务处理。。。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息到订单延迟队列，判断过期订单</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>,<span class="string">&quot;order.create.order&quot;</span>,order.getOrder());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-2-监听队列"><a href="#6-2-监听队列" class="headerlink" title="6.2 监听队列"></a>6.2 监听队列</h4><p>创建订单的消息会进入延迟队列，最终发送至队列<code>order.release.order.queue</code>，因此我们对该队列进行监听，进行订单的关闭</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;order.release.order.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCloseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(OrderEntity orderEntity, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到过期的订单信息，准备关闭订单&quot;</span> + orderEntity.getOrderSn());</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderService.closeOrder(orderEntity);</span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            channel.basicReject(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-3-关闭订单"><a href="#6-3-关闭订单" class="headerlink" title="6.3 关闭订单"></a>6.3 关闭订单</h4><ul><li>由于要保证幂等性，因此要查询最新的订单状态判断是否需要关单</li><li>关闭订单后也需要解锁库存，因此发送消息进行库存、会员服务对应的解锁</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeOrder</span><span class="params">(OrderEntity orderEntity)</span> &#123;</span><br><span class="line">    <span class="comment">//因为消息发送过来的订单已经是很久前的了，中间可能被改动，因此要查询最新的订单</span></span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">newOrderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(orderEntity.getId());</span><br><span class="line">    <span class="comment">//如果订单还处于新创建的状态，说明超时未支付，进行关单</span></span><br><span class="line">    <span class="keyword">if</span> (newOrderEntity.getStatus() == OrderStatusEnum.CREATE_NEW.getCode()) &#123;</span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">updateOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderEntity</span>();</span><br><span class="line">        updateOrder.setId(newOrderEntity.getId());</span><br><span class="line">        updateOrder.setStatus(OrderStatusEnum.CANCLED.getCode());</span><br><span class="line">        <span class="built_in">this</span>.updateById(updateOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关单后发送消息通知其他服务进行关单相关的操作，如解锁库存</span></span><br><span class="line">        <span class="type">OrderTo</span> <span class="variable">orderTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderTo</span>();</span><br><span class="line">        BeanUtils.copyProperties(newOrderEntity,orderTo);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.release.other&quot;</span>,orderTo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-4-解锁库存"><a href="#6-4-解锁库存" class="headerlink" title="6.4 解锁库存"></a>6.4 解锁库存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;stock.release.stock.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockReleaseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WareSkuService wareSkuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(StockLockedTo stockLockedTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(stockLockedTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(OrderTo orderTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************从订单模块收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(orderTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(OrderTo orderTo)</span> &#123;</span><br><span class="line">    <span class="comment">//为防止重复解锁，需要重新查询工作单</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> orderTo.getOrderSn();</span><br><span class="line">    <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> wareOrderTaskService.getBaseMapper().selectOne((<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;WareOrderTaskEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn)));</span><br><span class="line">    <span class="comment">//查询出当前订单相关的且处于锁定状态的工作单详情</span></span><br><span class="line">    List&lt;WareOrderTaskDetailEntity&gt; lockDetails = wareOrderTaskDetailService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;WareOrderTaskDetailEntity&gt;().eq(<span class="string">&quot;task_id&quot;</span>, taskEntity.getId()).eq(<span class="string">&quot;lock_status&quot;</span>, WareTaskStatusEnum.Locked.getCode()));</span><br><span class="line">    <span class="keyword">for</span> (WareOrderTaskDetailEntity lockDetail : lockDetails) &#123;</span><br><span class="line">        unlockStock(lockDetail.getSkuId(),lockDetail.getSkuNum(),lockDetail.getWareId(),lockDetail.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="八、支付"><a href="#八、支付" class="headerlink" title="八、支付"></a>八、支付</h2><h3 id="1、支付宝加密原理"><a href="#1、支付宝加密原理" class="headerlink" title="1、支付宝加密原理"></a>1、支付宝加密原理</h3><ul><li>支付宝加密采用 RSA 非对称加密，分别在客户端和支付端有两个公钥和私钥</li><li>在发送订单数据时，直接使用明文但会使用 <code>商户私钥</code> 加一个对应的签名，支付宝端会使用 <code>商户公钥</code> 对签名进行验签，只有数据明文和签名对应的时候才能说明传输正确。</li><li>支付宝成功后，支付宝发送支付成功数据之外，还会使用 支付宝私钥 加一个对应的签名，商户端收到支付成功数据之后会使用 <code>支付宝公钥</code> 验签，成功后才能确认。</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203292335053.png" alt="image-20220329233453861"></p><h3 id="2、配置支付宝沙箱环境"><a href="#2、配置支付宝沙箱环境" class="headerlink" title="2、配置支付宝沙箱环境"></a>2、配置支付宝沙箱环境</h3><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202203292341985.png" alt="image-20220329234110995"></p><h3 id="3、环境搭建"><a href="#3、环境搭建" class="headerlink" title="3、环境搭建"></a>3、环境搭建</h3><p>导入支付宝 sdk</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.28.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>抽取支付工具类并进行配置</p><p>成功调用该接口后，返回的数据就是支付页面的 html，因此后续会使用<code>@ResponseBody</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;alipay&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlipayTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在支付宝创建的应用的id</span></span><br><span class="line">    <span class="keyword">private</span>   <span class="type">String</span> <span class="variable">app_id</span> <span class="operator">=</span> <span class="string">&quot;2016102600763190&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户私钥，您的PKCS8格式RSA2私钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">merchant_private_key</span> <span class="operator">=</span> <span class="string">&quot;MjXN6Hnj8k2GAriRFt0BS9gjihbl9Rt38VMNbBi3Vt3Cy6TOwANLLJ/DfnYjRqwCG81fkyKlDqdsamdfCiTysCa0gQKBgQDYQ45LSRxAOTyM5NliBmtev0lbpDa7FqXL0UFgBel5VgA1Ysp0+6ex2n73NBHbaVPEXgNMnTdzU3WF9uHF4Gj0mfUzbVMbj/YkkHDOZHBggAjEHCB87IKowq/uAH/++Qes2GipHHCTJlG6yejdxhOsMZXdCRnidNx5yv9+2JI37QKBgQCw0xn7ZeRBIOXxW7xFJw1WecUV7yaL9OWqKRHat3lFtf1Qo/87cLl+KeObvQjjXuUe07UkrS05h6ijWyCFlBo2V7Cdb3qjq4atUwScKfTJONnrF+fwTX0L5QgyQeDX5a4yYp4pLmt6HKh34sI5S/RSWxDm7kpj+/MjCZgp6Xc51g==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">alipay_public_key</span> <span class="operator">=</span> <span class="string">&quot;MIIBIjA74UKxt2F8VMIRKrRAAAuIMuawIsl4Ye+G12LK8P1ZLYy7ZJpgZ+Wv5nOs3DdoEazgCERj/ON8lM1KBHZOAV+TkrIcyi7cD1gfv4a1usikrUqm8/qhFvoiUfyHJFv1ymT7C4BI6aHzQ2zcUlSQPGoPl4C11tgnSkm3DlH2JZKgaIMcCOnNH+qctjNh9yIV9zat2qUiXbxmrCTtxAmiI3I+eVsUNwvwIDAQAB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line">    <span class="keyword">private</span>  String notify_url=<span class="string">&quot;http://**.natappfree.cc/payed/notify&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line">    <span class="keyword">private</span>  String return_url=<span class="string">&quot;http://order.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 签名方式</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">sign_type</span> <span class="operator">=</span> <span class="string">&quot;RSA2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符编码格式</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">charset</span> <span class="operator">=</span> <span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付宝网关； https://openapi.alipaydev.com/gateway.do</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">gatewayUrl</span> <span class="operator">=</span> <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">pay</span><span class="params">(PayVo vo)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, &quot;json&quot;, AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);</span></span><br><span class="line">        <span class="comment">//1、根据支付宝的配置生成一个支付客户端</span></span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(gatewayUrl,</span><br><span class="line">                app_id, merchant_private_key, <span class="string">&quot;json&quot;</span>,</span><br><span class="line">                charset, alipay_public_key, sign_type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、创建一个支付请求 //设置请求参数</span></span><br><span class="line">        <span class="type">AlipayTradePagePayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradePagePayRequest</span>();</span><br><span class="line">        alipayRequest.setReturnUrl(return_url);</span><br><span class="line">        alipayRequest.setNotifyUrl(notify_url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号，商户网站订单系统中唯一订单号，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> vo.getOut_trade_no();</span><br><span class="line">        <span class="comment">//付款金额，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> vo.getTotal_amount();</span><br><span class="line">        <span class="comment">//订单名称，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> vo.getSubject();</span><br><span class="line">        <span class="comment">//商品描述，可空</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> vo.getBody();</span><br><span class="line"></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;\&quot;out_trade_no\&quot;:\&quot;&quot;</span>+ out_trade_no +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;total_amount\&quot;:\&quot;&quot;</span>+ total_amount +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;subject\&quot;:\&quot;&quot;</span>+ subject +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;body\&quot;:\&quot;&quot;</span>+ body +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;product_code\&quot;:\&quot;FAST_INSTANT_TRADE_PAY\&quot;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面</span></span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝的响应：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、订单支付与同步通知"><a href="#4、订单支付与同步通知" class="headerlink" title="4、订单支付与同步通知"></a>4、订单支付与同步通知</h3><blockquote><p>点击支付跳转到支付接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;aliPayOrder&quot;, produces = &quot;text/html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">aliPayOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;orderSn&quot;)</span> String orderSn)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;接收到订单信息orderSn:&quot;</span> + orderSn);</span><br><span class="line">    <span class="comment">// 获取当前订单并设置支付订单相关信息</span></span><br><span class="line">    <span class="type">PayVo</span> <span class="variable">payVo</span> <span class="operator">=</span> orderService.getOrderPay(orderSn);</span><br><span class="line">    <span class="type">String</span> <span class="variable">pay</span> <span class="operator">=</span> alipayTemplate.pay(payVo);</span><br><span class="line">    <span class="keyword">return</span> pay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayVo <span class="title function_">getOrderPay</span><span class="params">(String orderSn)</span> &#123;</span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;OrderEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">    <span class="type">PayVo</span> <span class="variable">payVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayVo</span>();</span><br><span class="line">    <span class="comment">//交易号</span></span><br><span class="line">    payVo.setOut_trade_no(orderSn);</span><br><span class="line">    <span class="comment">//支付金额设置为两位小数，否则会报错</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> orderEntity.getPayAmount().setScale(<span class="number">2</span>, BigDecimal.ROUND_UP);</span><br><span class="line">    payVo.setTotal_amount(payAmount.toString());</span><br><span class="line"></span><br><span class="line">    List&lt;OrderItemEntity&gt; orderItemEntities = orderItemService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;OrderItemEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">    <span class="type">OrderItemEntity</span> <span class="variable">orderItemEntity</span> <span class="operator">=</span> orderItemEntities.get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//订单名称</span></span><br><span class="line">    payVo.setSubject(orderItemEntity.getSkuName());</span><br><span class="line">    <span class="comment">//商品描述</span></span><br><span class="line">    payVo.setBody(orderItemEntity.getSkuAttrsVals());</span><br><span class="line">    <span class="keyword">return</span> payVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>设置成功回调地址为订单详情页</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line">    <span class="keyword">private</span>  String return_url=<span class="string">&quot;http://order.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前用户的所有订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/memberOrder.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">memberOrderPage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;pageNum&quot;,required = false,defaultValue = &quot;0&quot;)</span> Integer pageNum, Model model)</span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    params.put(<span class="string">&quot;page&quot;</span>,pageNum.toString());</span><br><span class="line">    <span class="comment">// 分页查询当前用户的所有订单及对应的订单项</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderFeignService.listWithItem(params);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;orders&quot;</span>,orderInfo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;orderList&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>注意</code>：需要给 gulimall-member 项目基本配置</p><ol><li>spring-session 依赖</li><li>spring-session 配置</li><li>LoginInterceptor 拦截器</li></ol><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202204062320610.png" alt="image-20220406232015966"></p><h3 id="5、异步通知"><a href="#5、异步通知" class="headerlink" title="5、异步通知"></a>5、异步通知</h3><ul><li>订单支付成功后支付宝会回调商户接口，这个时候需要修改订单状态</li><li>由于同步跳转可能由于网络问题失败，所以使用异步通知</li><li>支付宝使用的是最大努力通知方案，保障数据一致性，隔一段时间会通知商户支付成功，直到返回<code>success</code></li></ul><h4 id="5-1-内网穿透设置异步通知地址"><a href="#5-1-内网穿透设置异步通知地址" class="headerlink" title="5.1 内网穿透设置异步通知地址"></a>5.1 内网穿透设置异步通知地址</h4><ul><li><p>将外网映射到本地的<code>order.gulimall.com:80</code></p></li><li><p>由于回调的请求头不是<code>order.gulimall.com</code>，因此 nginx 转发到网关后找不到对应的服务，所以需要对 nginx 进行设置</p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202204062325285.png" style="zoom:38%"></li></ul><p>将<code>/payed/notify</code>异步通知转发至订单服务</p><p>设置异步通知的地址</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line"><span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line"><span class="keyword">private</span>  String notify_url=<span class="string">&quot;http://****.natappfree.cc/payed/notify&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="5-2-支付包支付异步通知"><a href="#5-2-支付包支付异步通知" class="headerlink" title="5.2 支付包支付异步通知"></a>5.2 支付包支付异步通知</h4><blockquote><p><strong>异步通知的参数</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/payed/notify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handlerAlipay</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到支付宝异步通知******************&quot;</span>);</span><br><span class="line">    Map&lt;String, String[]&gt; parameterMap = request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (String key : parameterMap.keySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> request.getParameter(key);</span><br><span class="line">        System.out.println(<span class="string">&quot;key:&quot;</span>+key+<span class="string">&quot;===========&gt;value:&quot;</span>+value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">收到支付宝异步通知******************</span><br><span class="line">key:gmt_create===========&gt;value:2020-10-18 09:13:26</span><br><span class="line">key:charset===========&gt;value:utf-8</span><br><span class="line">key:gmt_payment===========&gt;value:2020-10-18 09:13:34</span><br><span class="line">key:notify_time===========&gt;value:2020-10-18 09:13:35</span><br><span class="line">key:subject===========&gt;value:华为</span><br><span class="line">key:sign===========&gt;value:aqhKWzgzTLE84Scy5d8i3f+t9f7t7IE5tK/s5iHf3SdFQXPnTt6MEVtbr15ZXmITEo015nCbSXaUFJvLiAhWpvkNEd6ysraa+2dMgotuHPIHnIUFwvdk+U4Ez+2A4DBTJgmwtc5Ay8mYLpHLNR9ASuEmkxxK2F3Ov6MO0d+1DOjw9c/CCRRBWR8NHSJePAy/UxMzULLtpMELQ1KUVHLgZC5yym5TYSuRmltYpLHOuoJhJw8vGkh2+4FngvjtS7SBhEhR1GvJCYm1iXRFTNgP9Fmflw+EjxrDafCIA+r69ZqoJJ2Sk1hb4cBsXgNrFXR2Uj4+rQ1Ec74bIjT98f1KpA==</span><br><span class="line">key:buyer_id===========&gt;value:2088622954825223</span><br><span class="line">key:body===========&gt;value:上市年份：2020；内存：64G</span><br><span class="line">key:invoice_amount===========&gt;value:6300.00</span><br><span class="line">key:version===========&gt;value:1.0</span><br><span class="line">key:notify_id===========&gt;value:2020101800222091334025220507700182</span><br><span class="line">key:fund_bill_list===========&gt;value:[&#123;&quot;amount&quot;:&quot;6300.00&quot;,&quot;fundChannel&quot;:&quot;ALIPAYACCOUNT&quot;&#125;]</span><br><span class="line">key:notify_type===========&gt;value:trade_status_sync</span><br><span class="line">key:out_trade_no===========&gt;value:12345523123</span><br><span class="line">key:total_amount===========&gt;value:6300.00</span><br><span class="line">key:trade_status===========&gt;value:TRADE_SUCCESS</span><br><span class="line">key:trade_no===========&gt;value:2020101822001425220501264292</span><br><span class="line">key:auth_app_id===========&gt;value:2016102600763190</span><br><span class="line">key:receipt_amount===========&gt;value:6300.00</span><br><span class="line">key:point_amount===========&gt;value:0.00</span><br><span class="line">key:app_id===========&gt;value:2016102600763190</span><br><span class="line">key:buyer_pay_amount===========&gt;value:6300.00</span><br><span class="line">key:sign_type===========&gt;value:RSA2</span><br><span class="line">key:seller_id===========&gt;value:2088102181115314</span><br></pre></td></tr></table></figure><p>各参数详细意义见<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/194/103296">支付宝开放平台异步通知</a></p><blockquote><p><strong>验证签名</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/payed/notify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handlerAlipay</span><span class="params">(HttpServletRequest request, PayAsyncVo payAsyncVo)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到支付宝异步通知******************&quot;</span>);</span><br><span class="line">    <span class="comment">// 只要收到支付宝的异步通知，返回 success 支付宝便不再通知</span></span><br><span class="line">    <span class="comment">// 获取支付宝POST过来反馈信息</span></span><br><span class="line">    <span class="comment">//TODO 需要验签</span></span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Map&lt;String, String[]&gt; requestParams = request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (String name : requestParams.keySet()) &#123;</span><br><span class="line">        String[] values = requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                    : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用</span></span><br><span class="line">        <span class="comment">// valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;utf-8&quot;);</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">signVerified</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, alipayTemplate.getAlipay_public_key(),</span><br><span class="line">            alipayTemplate.getCharset(), alipayTemplate.getSign_type()); <span class="comment">//调用SDK验证签名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (signVerified)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝异步通知验签成功&quot;</span>);</span><br><span class="line">        <span class="comment">//修改订单状态</span></span><br><span class="line">        orderService.handlerPayResult(payAsyncVo);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝异步通知验签失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>修改订单状态与保存交易流水</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handlePayResult</span><span class="params">(PayAsyncVo asyncVo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存交易流水信息</span></span><br><span class="line">    <span class="type">PaymentInfoEntity</span> <span class="variable">paymentInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentInfoEntity</span>();</span><br><span class="line">    paymentInfo.setOrderSn(asyncVo.getOut_trade_no());</span><br><span class="line">    paymentInfo.setAlipayTradeNo(asyncVo.getTrade_no());</span><br><span class="line">    paymentInfo.setTotalAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(asyncVo.getBuyer_pay_amount()));</span><br><span class="line">    paymentInfo.setSubject(asyncVo.getBody());</span><br><span class="line">    paymentInfo.setPaymentStatus(asyncVo.getTrade_status());</span><br><span class="line">    paymentInfo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    paymentInfo.setCallbackTime(asyncVo.getNotify_time());</span><br><span class="line">    <span class="comment">//添加到数据库中</span></span><br><span class="line">    <span class="built_in">this</span>.paymentInfoService.save(paymentInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改订单状态</span></span><br><span class="line">    <span class="comment">//获取当前状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tradeStatus</span> <span class="operator">=</span> asyncVo.getTrade_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tradeStatus.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>) || tradeStatus.equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//支付成功状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> asyncVo.getOut_trade_no(); <span class="comment">//获取订单号</span></span><br><span class="line">        <span class="built_in">this</span>.updateOrderStatus(orderSn,OrderStatusEnum.PAYED.getCode(),PayConstant.ALIPAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改订单状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateOrderStatus</span><span class="params">(String orderSn, Integer code,Integer payType)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.updateOrderStatus(orderSn,code,payType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ALIPAY</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">WXPAY</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、收单"><a href="#6、收单" class="headerlink" title="6、收单"></a>6、收单</h3><p>由于可能出现订单已经过期后，库存已经解锁，但支付成功后再修改订单状态的情况，需要设置支付有效时间，只有在有效期内才能进行支付</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">alipayRequest.setBizContent(<span class="string">&quot;&#123;\&quot;out_trade_no\&quot;:\&quot;&quot;</span>+ out_trade_no +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;total_amount\&quot;:\&quot;&quot;</span>+ total_amount +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;subject\&quot;:\&quot;&quot;</span>+ subject +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;body\&quot;:\&quot;&quot;</span>+ body +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        <span class="comment">//设置过期时间为1m</span></span><br><span class="line">        +<span class="string">&quot;\&quot;timeout_express\&quot;:\&quot;1m\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;product_code\&quot;:\&quot;FAST_INSTANT_TRADE_PAY\&quot;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure><p>超时后订单显示</p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202204070020283.png" alt="image-20220407002035239"></p><p><img src="/img/loading.gif" data-lazy-src="https://oss.imoyt.top/img/202204070020438.png" alt="image-20220407002006990"></p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>谷粒商城-高级篇（订单服务）</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://oy6090.top/posts/a66c836/">https://oy6090.top/posts/a66c836/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display:inline-block;width:120px"><h>作者</h><div class="post-copyright-cc-info"><h>OY</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-04-08</h></div></div><div class="post-copyright-u" style="display:inline-block;width:120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-08-14</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E9%A1%B9%E7%9B%AE/">Java项目</a></div><div class="post_share"><div class="social-share" data-image="https://oss.imoyt.top/blog_img/imoyt/15.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://fastly.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/622eb062/"><img class="prev-cover" src="https://oss.imoyt.top/img/202204140006105.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">b站大学学习路线</div></div></a></div><div class="next-post pull-right"><a href="/posts/764a0b3/"><img class="next-cover" src="https://oss.imoyt.top/blog_img/imoyt/26.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">谷粒商城-高级篇（分布式事务）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i> <span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/47cc953c/" title="谷粒商城-Spring Sleuth服务链路追踪"><img class="cover" src="https://oss.imoyt.top/blog_img/imoyt/8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-17</div><div class="title">谷粒商城-Spring Sleuth服务链路追踪</div></div></a></div><div><a href="/posts/101fda4c/" title="谷粒商城-Spring alibaba Sentinel"><img class="cover" src="https://oss.imoyt.top/blog_img/imoyt/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-17</div><div class="title">谷粒商城-Spring alibaba Sentinel</div></div></a></div><div><a href="/posts/1b6f740d/" title="谷粒商城—分布式基础(一)"><img class="cover" src="https://oss.imoyt.top/img/20210502174039.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-02</div><div class="title">谷粒商城—分布式基础(一)</div></div></a></div><div><a href="/posts/3d7d679f/" title="谷粒商城—分布式基础(二)"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/21.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-07</div><div class="title">谷粒商城—分布式基础(二)</div></div></a></div><div><a href="/posts/f5810d24/" title="谷粒商城-高级篇（SSO-单点登录）"><img class="cover" src="https://fastly.jsdelivr.net/gh/OYCodeSite/CDN@0.5/thumb/25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-26</div><div class="title">谷粒商城-高级篇（SSO-单点登录）</div></div></a></div><div><a href="/posts/764a0b3/" title="谷粒商城-高级篇（分布式事务）"><img class="cover" src="https://oss.imoyt.top/blog_img/imoyt/26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-08</div><div class="title">谷粒商城-高级篇（分布式事务）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Waline</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__name">OY</div><div class="author-info__description">放弃不难，但坚持一定很酷</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">134</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/OyCodeSite"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/OyCodeSite" target="_blank" title="Github"><i class="iconfont icon-githubblack"></i></a><a class="social-icon" href="mailto:2097291754@qq.com" target="_blank" title="Email"><i class="iconfont icon-youxiang"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=2097291754" target="_blank" title="qq"><i class="iconfont icon-QQ2"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_45738810" target="_blank" title="CSDN"><i class="iconfont icon-csdn1"></i></a><a class="social-icon" href="https://travellings-zeta.vercel.app/" target="_blank" title="开往"><i class="iconfont icon-icon-technology-rocket"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">OY博客功能是用来记录学习的笔记以及一些基本的操作记录。如果你在阅读中遇到了什么问题，可以到留言板留言，也可以联系我哦! <img src="https://oss.imoyt.top/img/202207172346054.gif"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81RabbitMQ"><span class="toc-text">一、RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85-RabbitMQ"><span class="toc-text">二、安装 RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%95%B4%E5%90%88-SpringBoot"><span class="toc-text">三、整合 SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ-%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-text">RabbitMQ 消息确认机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-text">四、项目搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-text">五、订单服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%AE%A2%E5%8D%95%E6%B5%81%E7%A8%8B"><span class="toc-text">1、订单流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"><span class="toc-text">2、登录拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AE%A2%E5%8D%95%E7%A1%AE%E8%AE%A4%E9%A1%B5"><span class="toc-text">3、订单确认页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span class="toc-text">3.1 模型抽取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"><span class="toc-text">3.2 数据获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-Feign-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E4%B8%A2%E5%A4%B1%E8%AF%B7%E6%B1%82%E5%A4%B4%E9%97%AE%E9%A2%98"><span class="toc-text">3.3 Feign 远程调用丢失请求头问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-Feign-%E5%BC%82%E6%AD%A5%E6%83%85%E5%86%B5%E4%B8%A2%E5%A4%B1%E4%B8%8A%E4%B8%8B%E6%96%87%E9%97%AE%E9%A2%98"><span class="toc-text">3.4 Feign 异步情况丢失上下文问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E8%BF%90%E8%B4%B9%E6%94%B6%E4%BB%B6%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96"><span class="toc-text">3.5 运费收件信息获取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%AE%A2%E5%8D%95%E6%8F%90%E4%BA%A4"><span class="toc-text">4、订单提交</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span class="toc-text">4.1 模型抽取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-text">4.2 提交订单</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E9%AA%8C%E8%AF%81%E9%98%B2%E9%87%8D%E4%BB%A4%E7%89%8C"><span class="toc-text">1.验证防重令牌</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E9%A1%B9"><span class="toc-text">2.创建订单、订单项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%AA%8C%E4%BB%B7"><span class="toc-text">3.验价</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%BF%9D%E5%AD%98%E8%AE%A2%E5%8D%95"><span class="toc-text">4.保存订单</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E9%94%81%E5%AE%9A%E5%BA%93%E5%AD%98"><span class="toc-text">5.锁定库存</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">六、分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">1、分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B4%E5%90%88-Spring-cloud-alibaba-Seata"><span class="toc-text">2、整合 Spring cloud alibaba Seata</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">七、使用消息队列实现最终一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-text">1、延迟队列的定义与实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">2、延迟队列使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81-%E5%AE%9A%E6%97%B6%E5%85%B3%E5%8D%95%E4%B8%8E%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81%E4%B8%BB%E4%BD%93%E9%80%BB%E8%BE%91"><span class="toc-text">3、 定时关单与库存解锁主体逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E9%98%9F%E5%88%97"><span class="toc-text">4、创建业务交换机和队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%BA%93%E5%AD%98%E8%87%AA%E5%8A%A8%E8%A7%A3%E9%94%81"><span class="toc-text">5、库存自动解锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%BA%93%E5%AD%98%E9%94%81%E5%AE%9A"><span class="toc-text">5.1 库存锁定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97"><span class="toc-text">5.2 监听队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81"><span class="toc-text">5.3 库存解锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%AE%9A%E6%97%B6%E5%85%B3%E5%8D%95"><span class="toc-text">6、定时关单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-text">6.1 提交订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97"><span class="toc-text">6.2 监听队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-%E5%85%B3%E9%97%AD%E8%AE%A2%E5%8D%95"><span class="toc-text">6.3 关闭订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-%E8%A7%A3%E9%94%81%E5%BA%93%E5%AD%98"><span class="toc-text">6.4 解锁库存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%94%AF%E4%BB%98"><span class="toc-text">八、支付</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%94%AF%E4%BB%98%E5%AE%9D%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86"><span class="toc-text">1、支付宝加密原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AE%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83"><span class="toc-text">2、配置支付宝沙箱环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">3、环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E4%B8%8E%E5%90%8C%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">4、订单支付与同步通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">5、异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E8%AE%BE%E7%BD%AE%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E5%9C%B0%E5%9D%80"><span class="toc-text">5.1 内网穿透设置异步通知地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E6%94%AF%E4%BB%98%E5%8C%85%E6%94%AF%E4%BB%98%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">5.2 支付包支付异步通知</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%94%B6%E5%8D%95"><span class="toc-text">6、收单</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/39d99ac5/" title="VPS 搭建 ChatGPT-web"><img src="https://oss.imoyt.top/blog_img/imoyt/14.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="VPS 搭建 ChatGPT-web"></a><div class="content"><a class="title" href="/posts/39d99ac5/" title="VPS 搭建 ChatGPT-web">VPS 搭建 ChatGPT-web</a><time datetime="2023-08-14T21:30:00.000Z" title="发表于 2023-08-14 21:30:00">2023-08-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9630e29b/" title="jar 打包 exec"><img src="https://oss.imoyt.top/blog_img/imoyt/29.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="jar 打包 exec"></a><div class="content"><a class="title" href="/posts/9630e29b/" title="jar 打包 exec">jar 打包 exec</a><time datetime="2023-07-19T15:30:00.000Z" title="发表于 2023-07-19 15:30:00">2023-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c6d29fee/" title="KubeSphere 中间件部署"><img src="https://oss.imoyt.top/blog_img/imoyt/11.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="KubeSphere 中间件部署"></a><div class="content"><a class="title" href="/posts/c6d29fee/" title="KubeSphere 中间件部署">KubeSphere 中间件部署</a><time datetime="2023-02-11T20:00:00.000Z" title="发表于 2023-02-11 20:00:00">2023-02-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e9281f56/" title="KubeSphere DevOps 流水线"><img src="https://oss.imoyt.top/blog_img/imoyt/23.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="KubeSphere DevOps 流水线"></a><div class="content"><a class="title" href="/posts/e9281f56/" title="KubeSphere DevOps 流水线">KubeSphere DevOps 流水线</a><time datetime="2023-02-09T18:00:00.000Z" title="发表于 2023-02-09 18:00:00">2023-02-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/15c6dcc3/" title="Linux多节点部署KubeSphere"><img src="https://oss.imoyt.top/blog_img/imoyt/34.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Linux多节点部署KubeSphere"></a><div class="content"><a class="title" href="/posts/15c6dcc3/" title="Linux多节点部署KubeSphere">Linux多节点部署KubeSphere</a><time datetime="2023-01-28T22:00:00.000Z" title="发表于 2023-01-28 22:00:00">2023-01-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By OY</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" alt="又拍云" rel="nofollow"><img src="https://s1.ax1x.com/2020/07/27/aPoebR.png" alt="又拍云" class="yunpai"></a>&nbsp;&nbsp;&nbsp; <a href="https://cloud.tencent.com/" target="_blank" alt="腾讯云" rel="nofollow"><img src="https://oss.imoyt.top/img/202205252228367.png" alt="腾讯云" class="yunpai"></a>&nbsp;&nbsp;&nbsp; <a href="https://travellings.now.sh/" target="_blank" alt="travellings" rel="nofollow"><img src="https://oss.imoyt.top/img/202205252230430.gif" alt="travellings" class="yunpai"></a><br><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img class="icp-icon" src="/img/icp1.png"><span>湘 ICP 备 2020020882 号-1</span></a> &nbsp;&nbsp; <a target="_blank" rel="noopener" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43108102000064"><img class="icp-icon" src="/img/icp.png"><span>湘公网安备 43108102000064 号</span></a><p class="ghbdages"><a href="https://hexo.io/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;&nbsp;<a href="https://github.com/jerryc127/hexo-theme-butterfly" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;&nbsp;<a href="https://www.jsdelivr.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a>&nbsp;&nbsp;<a href="https://vercel.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;&nbsp;<a href="https://github.com/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;&nbsp;<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" target="_blank"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA 4.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://fastly.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://fastly.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://fastly.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://fastly.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      true && mermaid.init()
    })
  }
}</script><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.imoyt.top/',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo.imoyt.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://fastly.jsdelivr.net/npm/twikoo@1.6.7/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.oy6090.top/',
      avatar: 'monsterid',
      path: location.pathname,
      visitor: false,
      dark: '[data-theme="dark"]'
    }, null))
  }

  if (typeof Waline === 'function') initWaline() 
  else getScript('https://fastly.jsdelivr.net/npm/@waline/client/dist/Waline.min.js').then(initWaline)
}

if ('Twikoo' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="/tools/js/jquery.min.js"></script><script data-pjax src="/tools/js/oy.js"></script><script data-pjax src="/tools/js/index.js"></script><script src="https://myhkw.cn/api/player/161104765824" id="myhk" key="161104765824" m="1"></script><script defer src="https://fastly.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"✨ 博客已更新 👉",backgroundColor:t,duration:5e5,pos:e,actionText:"✔ 点击刷新 💫",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",function(){showNotification()}),window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")}));</script><script async data-pjax src="https://fastly.jsdelivr.net/gh/HCLonely/hclonely.github.io@1.4.7/js/custom/pace.min.js"></script><script id="click-show-text" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,富强,文明,和谐,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async></script><script>!function(t,e,o,c,n,a,i){t.DaoVoiceObject=n,t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},t[n].l=1*new Date,a=e.createElement(o),i=e.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",i.parentNode.insertBefore(a,i)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/5a56cd55.js","daovoice")</script><script>var isChatBtn = true
daovoice('init', {
  app_id: '5a56cd55',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://fastly.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://fastly.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/link/"]):not([href="/artitalk/"]):not([href="/bb/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax], .pjax-reload script').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="pjax-reload"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","100ms"),arr[i].setAttribute("data-wow-offset","50"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("ghbdages"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInX"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay","50ms"),arr[i].setAttribute("data-wow-offset","50"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("article-sort-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","1")</script></div><script defer src="https://fastly.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script><script defer src="/tools/js/wow_init.js"></script></div></body></html>